---
title: "Wandering Albatross Bycatch Estimates - Corrected Catchability Method"
author: "WAAL Bycatch Project"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8
)
```

# Overview

This script estimates wandering albatross bycatch using a **corrected catchability approach** that properly accounts for spatial variation in Bird Island population composition.

## Method

$$\text{Bycatch}_{BI}^{age} = \sum_i \left( \text{hooks}^i \times \text{birds}_{all}^i \times \beta \times \text{pct\_BI}^i \times \text{age\_weight}^i \right)$$

Where:
- $\beta$ = catchability (derived from BPUE for all WAAL)
- $\text{birds}_{all}^i$ = total WAAL density in cell i (all populations)
- $\text{pct\_BI}^i$ = local % of birds from Bird Island in cell i (from Carneiro distributions)
- $\text{age\_weight}^i$ = local age-class composition in cell i (from Clay distributions)

## Key Features

**Differences from script 03b:**
- Uses actual **local % BI** from Carneiro distributions (varies 0-100% spatially)
- NOT scaled by global average (15.67%) - that was conceptually incorrect
- Uses **Carneiro for population allocation**, **Clay for age partitioning**
- Properly accounts for spatial heterogeneity in population composition

**Maintains catchability framework:**
- β still derived from literature BPUE for all WAAL
- Total expected bycatch still constrained by BPUE × total hooks
- Spatial partitioning based on hooks × birds interaction

# Setup

```{r libraries}
library(tidyverse)
library(terra)
library(sf)
library(here)
library(viridis)
library(patchwork)
```

# Load Required Data

## Load fishing effort data

```{r load-fishing-effort}
# Load fishing effort rasters (hooks per grid cell)
fishing_pel <- rast(here("output/rasters/fishing_effort_pelagic.tif"))
fishing_dem <- rast(here("output/rasters/fishing_effort_demersal.tif"))

# Calculate total hooks across all cells
total_hooks_pel <- global(fishing_pel, fun = "sum", na.rm = TRUE)[1,1]
total_hooks_dem <- global(fishing_dem, fun = "sum", na.rm = TRUE)[1,1]

cat("=== FISHING EFFORT ===\n")
cat("Pelagic total hooks:  ", format(total_hooks_pel, big.mark = ","), "\n")
cat("Demersal total hooks: ", format(total_hooks_dem, big.mark = ","), "\n")
```

## Load bird density data

```{r load-bird-densities}
# Load total bird density (all populations) - for catchability calculation
total_bird_density <- rast(here("output/rasters/total_bird_density_all_pops.tif"))

cat("\nTotal bird density (all populations):\n")
cat("  Sum:", round(global(total_bird_density, "sum", na.rm = TRUE)[1,1], 3),
    "(should be ~1)\n")

# Load % Bird Island map from script 02 (Carneiro-based)
pct_bird_island <- rast(here("output/rasters/percentage_bird_island.tif"))

cat("\nPercentage Bird Island map:\n")
cat("  Min:", round(global(pct_bird_island, "min", na.rm = TRUE)[1,1], 3), "\n")
cat("  Mean:", round(global(pct_bird_island, "mean", na.rm = TRUE)[1,1], 3), "\n")
cat("  Max:", round(global(pct_bird_island, "max", na.rm = TRUE)[1,1], 3), "\n")
cat("  (Values are proportions, not percentages)\n")
```

## Load Clay age-class distributions

```{r load-clay-distributions}
# Load Bird Island age-class distributions (Clay et al. 2019)
bird_fb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_FB_1990-2009.tif"))
bird_sb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_SB_1990-2009.tif"))
bird_nb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_NB_1990-2009.tif"))
bird_j2j3 <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_J2+3_1990-2009.tif"))
bird_imm <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_IMM_1990-2009.tif"))

# Store in named list
bird_dists_raw <- list(
  fb = bird_fb,
  sb = bird_sb,
  nb = bird_nb,
  j2j3 = bird_j2j3,
  imm = bird_imm
)

cat("\nLoaded Clay age-class distributions\n")
```

## Load demographic proportions and BPUE data

```{r load-demographic-data}
# Load demographic proportions
dem_props <- read_csv(here("data/WAAL_dist_Clay2019/Dem_props copy.csv"),
                      show_col_types = FALSE)

# Clean demographic class names
dem_props <- dem_props %>%
  mutate(Dem_class = str_replace(Dem_class, "J2\\+3", "J2J3"))

# Calculate mean proportions by demographic class
dem_props_summary <- dem_props %>%
  group_by(Dem_class) %>%
  summarise(
    mean_prop = mean(Prop),
    mean_pop = mean(Pop)
  )

cat("\nDemographic proportions:\n")
print(dem_props_summary)

# Extract age class proportions (excluding J1)
age_class_props <- c(
  fb = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "FB"],
  sb = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "SB"],
  nb = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "NB"],
  j2j3 = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "J2J3"],
  imm = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "IMM"]
)

cat("\nAge class proportions of Bird Island population:\n")
print(round(age_class_props, 4))
cat("Sum:", round(sum(age_class_props), 4), "(excludes J1)\n")
```

## Define BPUE rates

```{r define-bpue}
# BPUE rates per 1000 hooks (same as previous scripts)
K_BPUE_1000_PEL <- 0.01    # Klaer 2012, South Atlantic
T_BPUE_1000_PEL <- 0.007   # Tuck 2015, South Atlantic
mean_BPUE_pel_1000 <- (K_BPUE_1000_PEL + T_BPUE_1000_PEL) / 2

T_BPUE_1000_DEM_baseline <- 0.001837540  # Tuck 2015
JIM_BPUE_1000_DEM_premit <- 0.029        # Jiménez et al. 2020
mean_BPUE_dem_1000 <- (T_BPUE_1000_DEM_baseline + JIM_BPUE_1000_DEM_premit) / 2

# Convert to per hook for catchability calculation
mean_BPUE_pel_per_hook <- mean_BPUE_pel_1000 / 1000
mean_BPUE_dem_per_hook <- mean_BPUE_dem_1000 / 1000

cat("\n=== BPUE RATES ===\n")
cat("Pelagic:  ", mean_BPUE_pel_1000, "birds per 1000 hooks\n")
cat("          ", format(mean_BPUE_pel_per_hook, scientific = TRUE), "birds per hook\n")
cat("Demersal: ", mean_BPUE_dem_1000, "birds per 1000 hooks\n")
cat("          ", format(mean_BPUE_dem_per_hook, scientific = TRUE), "birds per hook\n")
```

## Load base map data

```{r load-basemap}
# Load Natural Earth land polygons for mapping
ne_land <- st_read(here("data/ne_10m_land/ne_10m_land.shp"), quiet = TRUE)
```

# Align Raster Grids

Ensure all rasters have the same extent and resolution for cell-by-cell calculations.

```{r align-rasters}
# Use total_bird_density as the template
template <- total_bird_density

# Resample fishing effort to match bird density grid
fishing_pel_aligned <- resample(fishing_pel, template, method = "bilinear")
fishing_dem_aligned <- resample(fishing_dem, template, method = "bilinear")

# Resample % BI map to match template
pct_BI_aligned <- resample(pct_bird_island, template, method = "bilinear")

# Resample Clay distributions to match template
bird_dists_aligned <- map(bird_dists_raw, function(r) {
  resample(r, template, method = "bilinear")
})

cat("All rasters aligned to common grid\n")
cat("Template dimensions:", dim(template), "\n")
```

# Calculate Catchability

Catchability is calculated using **all wandering albatross populations** (same as script 03b).

## Pelagic catchability

```{r calculate-catchability-pelagic}
# Calculate hooks × birds for each cell (all populations)
hooks_x_birds_pel <- fishing_pel_aligned * total_bird_density

# Sum across all cells
sum_hooks_x_birds_pel <- global(hooks_x_birds_pel, fun = "sum", na.rm = TRUE)[1,1]

# Calculate catchability
# catchability = BPUE_per_hook * total_hooks / sum(hooks * birds)
catchability_pel <- mean_BPUE_pel_per_hook * total_hooks_pel / sum_hooks_x_birds_pel

cat("\n=== PELAGIC CATCHABILITY ===\n")
cat("BPUE (α):                ", format(mean_BPUE_pel_per_hook, scientific = TRUE),
    "per hook\n")
cat("Total hooks:             ", format(total_hooks_pel, big.mark = ","), "\n")
cat("Sum(hooks × birds):      ", format(sum_hooks_x_birds_pel, big.mark = ",",
                                         scientific = FALSE), "\n")
cat("Catchability (β):        ", format(catchability_pel, scientific = TRUE), "\n")
```

## Demersal catchability

```{r calculate-catchability-demersal}
# Calculate hooks × birds for each cell (all populations)
hooks_x_birds_dem <- fishing_dem_aligned * total_bird_density

# Sum across all cells
sum_hooks_x_birds_dem <- global(hooks_x_birds_dem, fun = "sum", na.rm = TRUE)[1,1]

# Calculate catchability
catchability_dem <- mean_BPUE_dem_per_hook * total_hooks_dem / sum_hooks_x_birds_dem

cat("\n=== DEMERSAL CATCHABILITY ===\n")
cat("BPUE (α):                ", format(mean_BPUE_dem_per_hook, scientific = TRUE),
    "per hook\n")
cat("Total hooks:             ", format(total_hooks_dem, big.mark = ","), "\n")
cat("Sum(hooks × birds):      ", format(sum_hooks_x_birds_dem, big.mark = ",",
                                         scientific = FALSE), "\n")
cat("Catchability (β):        ", format(catchability_dem, scientific = TRUE), "\n")
```

# Calculate Total WAAL Bycatch Density

Calculate bycatch for ALL WAAL in each cell using the catchability framework.

```{r calculate-total-waal-bycatch}
# Bycatch density for all WAAL (birds per cell)
# Bycatch = hooks × birds × catchability
total_waal_bycatch_pel <- fishing_pel_aligned * total_bird_density * catchability_pel
total_waal_bycatch_dem <- fishing_dem_aligned * total_bird_density * catchability_dem

# Verify totals match expected (BPUE × total hooks)
expected_pel <- mean_BPUE_pel_per_hook * total_hooks_pel
expected_dem <- mean_BPUE_dem_per_hook * total_hooks_dem

actual_pel <- global(total_waal_bycatch_pel, "sum", na.rm = TRUE)[1,1]
actual_dem <- global(total_waal_bycatch_dem, "sum", na.rm = TRUE)[1,1]

cat("\n=== TOTAL WAAL BYCATCH (ALL POPULATIONS) ===\n")
cat("Pelagic:\n")
cat("  Expected (BPUE × hooks):", round(expected_pel, 2), "birds\n")
cat("  Calculated:             ", round(actual_pel, 2), "birds\n")
cat("  Match:", round(100 * actual_pel / expected_pel, 1), "%\n\n")

cat("Demersal:\n")
cat("  Expected (BPUE × hooks):", round(expected_dem, 2), "birds\n")
cat("  Calculated:             ", round(actual_dem, 2), "birds\n")
cat("  Match:", round(100 * actual_dem / expected_dem, 1), "%\n")
```

# Allocate to Bird Island

Allocate total WAAL bycatch to Bird Island based on the **local % BI** in each cell.

```{r allocate-to-bird-island}
# Bird Island bycatch density = Total WAAL bycatch × % BI
BI_total_bycatch_pel <- total_waal_bycatch_pel * pct_BI_aligned
BI_total_bycatch_dem <- total_waal_bycatch_dem * pct_BI_aligned

# Sum to get total BI bycatch
BI_total_pel <- global(BI_total_bycatch_pel, "sum", na.rm = TRUE)[1,1]
BI_total_dem <- global(BI_total_bycatch_dem, "sum", na.rm = TRUE)[1,1]

cat("\n=== BIRD ISLAND TOTAL BYCATCH ===\n")
cat("Pelagic:  ", round(BI_total_pel, 2), "birds/year\n")
cat("Demersal: ", round(BI_total_dem, 2), "birds/year\n")
cat("TOTAL:    ", round(BI_total_pel + BI_total_dem, 2), "birds/year\n")

# Calculate as % of total WAAL bycatch
pct_of_total_pel <- 100 * BI_total_pel / actual_pel
pct_of_total_dem <- 100 * BI_total_dem / actual_dem

cat("\nBird Island as % of total WAAL bycatch:\n")
cat("Pelagic:  ", round(pct_of_total_pel, 1), "%\n")
cat("Demersal: ", round(pct_of_total_dem, 1), "%\n")
```

# Partition by Age Class

Use Clay distributions to partition Bird Island bycatch by age class.

## Prepare age-class weights

```{r prepare-age-weights}
# Normalize Clay distributions to sum to 1
bird_dists_norm <- map(bird_dists_aligned, function(r) {
  r_zero <- subst(r, NA, 0)
  r_sum <- global(r_zero, "sum", na.rm = TRUE)[1,1]
  r_norm <- r_zero / r_sum
  return(r_norm)
})

# Weight by age class proportion of population
bird_dists_weighted <- map2(bird_dists_norm, age_class_props, function(r, prop) {
  r * prop
})

# Calculate sum of weighted distributions in each cell
# This tells us the relative contribution of each cell to total BI distribution
all_ages_sum <- Reduce("+", bird_dists_weighted)

# For each age class, calculate what proportion of BI birds are that age in each cell
# age_weight[i] = (bird_age[i] * prop_age) / sum_all_ages[i]
age_weights <- map(bird_dists_weighted, function(r) {
  r / all_ages_sum
})

# Verify weights sum to 1 in each cell (excluding NAs)
weights_sum <- Reduce("+", age_weights)
cat("\nAge weights verification:\n")
cat("  Mean sum across cells:", round(global(weights_sum, "mean", na.rm = TRUE)[1,1], 3),
    "(should be ~1)\n")
cat("  Min sum:", round(global(weights_sum, "min", na.rm = TRUE)[1,1], 3), "\n")
cat("  Max sum:", round(global(weights_sum, "max", na.rm = TRUE)[1,1], 3), "\n")
```

## Calculate bycatch by age class

### Pelagic bycatch by age

```{r pelagic-by-age}
# For each age class: age_bycatch = BI_total_bycatch × age_weight
byc_pel_by_age <- map(age_weights, function(age_wt) {
  bycatch_map <- BI_total_bycatch_pel * age_wt
  bycatch_total <- global(bycatch_map, "sum", na.rm = TRUE)[1,1]
  return(list(map = bycatch_map, total = bycatch_total))
})

# Extract totals
byc_pel_totals <- map_dbl(byc_pel_by_age, "total")

cat("\n=== PELAGIC BYCATCH BY AGE CLASS ===\n")
print(round(byc_pel_totals, 2))
cat("\nTotal pelagic bycatch:", round(sum(byc_pel_totals), 2), "birds\n")
cat("Expected (from allocation):", round(BI_total_pel, 2), "birds\n")
cat("Match:", round(100 * sum(byc_pel_totals) / BI_total_pel, 1), "%\n")
```

### Demersal bycatch by age

```{r demersal-by-age}
# For each age class: age_bycatch = BI_total_bycatch × age_weight
byc_dem_by_age <- map(age_weights, function(age_wt) {
  bycatch_map <- BI_total_bycatch_dem * age_wt
  bycatch_total <- global(bycatch_map, "sum", na.rm = TRUE)[1,1]
  return(list(map = bycatch_map, total = bycatch_total))
})

# Extract totals
byc_dem_totals <- map_dbl(byc_dem_by_age, "total")

cat("\n=== DEMERSAL BYCATCH BY AGE CLASS ===\n")
print(round(byc_dem_totals, 2))
cat("\nTotal demersal bycatch:", round(sum(byc_dem_totals), 2), "birds\n")
cat("Expected (from allocation):", round(BI_total_dem, 2), "birds\n")
cat("Match:", round(100 * sum(byc_dem_totals) / BI_total_dem, 1), "%\n")
```

## Total bycatch summary

```{r bycatch-summary}
# Create summary table
bycatch_summary <- tibble(
  age_class = names(byc_pel_totals),
  pelagic = byc_pel_totals,
  demersal = byc_dem_totals,
  total = byc_pel_totals + byc_dem_totals
) %>%
  bind_rows(tibble(
    age_class = "TOTAL",
    pelagic = sum(byc_pel_totals),
    demersal = sum(byc_dem_totals),
    total = sum(byc_pel_totals) + sum(byc_dem_totals)
  ))

cat("\n=== TOTAL BYCATCH SUMMARY ===\n")
print(bycatch_summary)
```

# Calculate Per Capita Bycatch Rates

```{r per-capita-rates}
# Population sizes for each age class
pop_sizes <- c(
  fb = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "FB"],
  sb = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "SB"],
  nb = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "NB"],
  j2j3 = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "J2J3"],
  imm = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "IMM"]
)

# Calculate per capita rates
percap_pel <- byc_pel_totals / pop_sizes
percap_dem <- byc_dem_totals / pop_sizes

cat("\n=== PER CAPITA BYCATCH RATES ===\n")
cat("\nPelagic (birds per individual per year):\n")
print(round(percap_pel, 6))
cat("\nDemersal (birds per individual per year):\n")
print(round(percap_dem, 6))

# Create per capita summary table
percap_summary <- tibble(
  age_class = names(pop_sizes),
  population = pop_sizes,
  byc_pel = byc_pel_totals,
  byc_dem = byc_dem_totals,
  percap_pel = percap_pel,
  percap_dem = percap_dem,
  percap_total = percap_pel + percap_dem
)

print(percap_summary)
```

# Create Bycatch Maps

```{r create-total-maps}
# Extract bycatch maps from results
byc_pel_maps <- map(byc_pel_by_age, "map")
byc_dem_maps <- map(byc_dem_by_age, "map")

# Sum across all age classes
pel_byc_total <- Reduce("+", byc_pel_maps)
dem_byc_total <- Reduce("+", byc_dem_maps)

cat("\nTotal bycatch map sums:\n")
cat("Pelagic:  ", round(global(pel_byc_total, "sum", na.rm = TRUE)[1,1], 2), "\n")
cat("Demersal: ", round(global(dem_byc_total, "sum", na.rm = TRUE)[1,1], 2), "\n")
```

## Map bycatch density

```{r map-bycatch, fig.width=12, fig.height=6}
# Function to map bycatch density
map_bycatch <- function(rast_obj, title) {
  df <- as.data.frame(rast_obj, xy = TRUE, na.rm = TRUE)
  names(df)[3] <- "bycatch"

  ext_rast <- ext(rast_obj)

  ggplot(df, aes(x = x, y = y, fill = bycatch)) +
    geom_raster() +
    geom_sf(data = ne_land, inherit.aes = FALSE, fill = "grey80", color = NA) +
    coord_sf(xlim = c(ext_rast[1], ext_rast[2]),
             ylim = c(ext_rast[3], ext_rast[4]),
             expand = FALSE) +
    scale_fill_viridis_c(
      name = "Bycatch\nDensity",
      na.value = "white",
      direction = -1
    ) +
    labs(title = title) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 12, face = "bold"),
      legend.position = "right"
    )
}

# Create bycatch maps
p_byc_pel <- map_bycatch(pel_byc_total,
                         "Total Pelagic Bycatch Density (Corrected Method)")
p_byc_dem <- map_bycatch(dem_byc_total,
                         "Total Demersal Bycatch Density (Corrected Method)")

# Display side by side
p_byc_pel | p_byc_dem

# Save maps
dir.create(here("output/maps"), showWarnings = FALSE, recursive = TRUE)
ggsave(here("output/maps/bycatch_pelagic_total_03c.png"), p_byc_pel,
       width = 10, height = 6, dpi = 300)
ggsave(here("output/maps/bycatch_demersal_total_03c.png"), p_byc_dem,
       width = 10, height = 6, dpi = 300)
```

## Map by age class

```{r map-by-age-class, fig.width=15, fig.height=10}
# Create maps for each age class (pelagic)
byc_pel_age_maps <- imap(byc_pel_maps, function(r, age) {
  map_bycatch(r, paste0("Pelagic Bycatch: ", toupper(age), " (Corrected Method)"))
})

# Display all pelagic age class maps
wrap_plots(byc_pel_age_maps, ncol = 3)

# Save individual age class maps
iwalk(byc_pel_age_maps, function(p, age) {
  ggsave(here(paste0("output/maps/bycatch_pelagic_", age, "_03c.png")),
         p, width = 8, height = 6, dpi = 300)
})

# Create maps for each age class (demersal)
byc_dem_age_maps <- imap(byc_dem_maps, function(r, age) {
  map_bycatch(r, paste0("Demersal Bycatch: ", toupper(age), " (Corrected Method)"))
})

# Display all demersal age class maps
wrap_plots(byc_dem_age_maps, ncol = 3)

# Save individual age class maps
iwalk(byc_dem_age_maps, function(p, age) {
  ggsave(here(paste0("output/maps/bycatch_demersal_", age, "_03c.png")),
         p, width = 8, height = 6, dpi = 300)
})
```

# Comparison with Script 03b

```{r compare-03b}
# Load results from script 03b if available
if (file.exists(here("output/bycatch_summary_catchability.csv"))) {
  byc_03b <- read_csv(here("output/bycatch_summary_catchability.csv"),
                      show_col_types = FALSE)

  # Compare totals
  comparison <- tibble(
    age_class = bycatch_summary$age_class,
    pelagic_03b = byc_03b$pelagic,
    pelagic_03c = bycatch_summary$pelagic,
    pelagic_ratio = bycatch_summary$pelagic / byc_03b$pelagic,
    demersal_03b = byc_03b$demersal,
    demersal_03c = bycatch_summary$demersal,
    demersal_ratio = bycatch_summary$demersal / byc_03b$demersal
  )

  cat("\n=== COMPARISON: SCRIPT 03b vs 03c ===\n")
  print(comparison)

  cat("\n=== SUMMARY ===\n")
  cat("Total pelagic (03b):  ", round(byc_03b$pelagic[nrow(byc_03b)], 2), "\n")
  cat("Total pelagic (03c):  ", round(sum(byc_pel_totals), 2), "\n")
  cat("Ratio (03c/03b):      ", round(sum(byc_pel_totals) / byc_03b$pelagic[nrow(byc_03b)], 3), "×\n\n")

  cat("Total demersal (03b): ", round(byc_03b$demersal[nrow(byc_03b)], 2), "\n")
  cat("Total demersal (03c): ", round(sum(byc_dem_totals), 2), "\n")
  cat("Ratio (03c/03b):      ", round(sum(byc_dem_totals) / byc_03b$demersal[nrow(byc_03b)], 3), "×\n")

  # Save comparison
  write_csv(comparison, here("output/bycatch_comparison_03b_vs_03c.csv"))
} else {
  cat("\nScript 03b results not found - run script 03b first for comparison\n")
}
```

# Save Processed Data

```{r save-outputs}
# Create output directories if they don't exist
dir.create(here("output/rasters"), showWarnings = FALSE, recursive = TRUE)

# Save total bycatch maps
writeRaster(pel_byc_total,
            here("output/rasters/bycatch_pelagic_total_03c.tif"),
            overwrite = TRUE)
writeRaster(dem_byc_total,
            here("output/rasters/bycatch_demersal_total_03c.tif"),
            overwrite = TRUE)

# Save bycatch rasters by age class (pelagic)
iwalk(byc_pel_maps, function(r, age) {
  writeRaster(r,
              here(paste0("output/rasters/bycatch_pelagic_", age, "_03c.tif")),
              overwrite = TRUE)
})

# Save bycatch rasters by age class (demersal)
iwalk(byc_dem_maps, function(r, age) {
  writeRaster(r,
              here(paste0("output/rasters/bycatch_demersal_", age, "_03c.tif")),
              overwrite = TRUE)
})

# Save summary tables
write_csv(bycatch_summary, here("output/bycatch_summary_03c.csv"))
write_csv(percap_summary, here("output/bycatch_percapita_summary_03c.csv"))

# Save catchability values for reference
catchability_values <- tibble(
  fishery = c("Pelagic", "Demersal"),
  BPUE_per_1000_hooks = c(mean_BPUE_pel_1000, mean_BPUE_dem_1000),
  BPUE_per_hook = c(mean_BPUE_pel_per_hook, mean_BPUE_dem_per_hook),
  total_hooks = c(total_hooks_pel, total_hooks_dem),
  sum_hooks_x_birds = c(sum_hooks_x_birds_pel, sum_hooks_x_birds_dem),
  catchability_beta = c(catchability_pel, catchability_dem)
)

write_csv(catchability_values, here("output/catchability_values_03c.csv"))

cat("\nAll outputs saved successfully\n")
```

# Diagnostics

```{r diagnostics}
cat("\n=== DIAGNOSTIC VALUES ===\n\n")

# Check that catchability matches 03b (should be identical)
cat("Catchability values (should match 03b):\n")
cat("Pelagic:  ", format(catchability_pel, scientific = TRUE), "\n")
cat("Demersal: ", format(catchability_dem, scientific = TRUE), "\n\n")

# Check that total WAAL bycatch matches expected
cat("Total WAAL bycatch validation:\n")
cat("Pelagic:  ", round(actual_pel, 2), "/", round(expected_pel, 2),
    "=", round(100 * actual_pel / expected_pel, 1), "%\n")
cat("Demersal: ", round(actual_dem, 2), "/", round(expected_dem, 2),
    "=", round(100 * actual_dem / expected_dem, 1), "%\n\n")

# Check BI allocation
cat("Bird Island allocation:\n")
cat("BI % of total (pelagic): ", round(pct_of_total_pel, 1), "%\n")
cat("BI % of total (demersal):", round(pct_of_total_dem, 1), "%\n")
cat("Mean % BI across space:  ", round(100 * global(pct_BI_aligned, "mean", na.rm = TRUE)[1,1], 1), "%\n\n")

# Check age partitioning
cat("Age class partitioning (sums should match totals):\n")
cat("Pelagic:  ", round(sum(byc_pel_totals), 2), "/", round(BI_total_pel, 2),
    "=", round(100 * sum(byc_pel_totals) / BI_total_pel, 1), "%\n")
cat("Demersal: ", round(sum(byc_dem_totals), 2), "/", round(BI_total_dem, 2),
    "=", round(100 * sum(byc_dem_totals) / BI_total_dem, 1), "%\n\n")

# Population estimates
cat("Bird Island population estimates by age class:\n")
print(pop_sizes)
cat("Total BI population:", sum(pop_sizes), "\n")
```

# Session Info

```{r session-info}
sessionInfo()
```
