---
title: "Wandering Albatross Bycatch - Standardized Clay + Carneiro Method"
author: "WAAL Bycatch Project"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8
)
```

# Overview

This script implements the **standardized method** for bycatch estimation:

**Key Principles:**
1. ✓ Use Clay age-class distributions for Bird Island (our study population)
2. ✓ Use Carneiro distributions for other populations (Crozet, Kerguelen, PEI)
3. ✓ Build total WAAL density = Clay_BI + Carneiro_others
4. ✓ Calculate catchability (β) using this combined density
5. ✓ Apply β directly to Clay age-class densities for BI bycatch
6. ✓ NO % BI map needed - we have BI densities directly from Clay!

**Why this approach:**
- Clay provides actual age-class data for Bird Island
- Carneiro provides other population distributions
- Maintains theoretical rigor (catchability framework)
- More direct and conceptually clean
- Validated: Clay BI ≈ Carneiro SG (r=0.98)

# Setup

```{r libraries}
library(tidyverse)
library(terra)
library(sf)
library(here)
library(viridis)
library(patchwork)
```

# Load Data

## Load fishing effort

```{r load-fishing-effort}
fishing_pel <- rast(here("output/rasters/fishing_effort_pelagic.tif"))
fishing_dem <- rast(here("output/rasters/fishing_effort_demersal.tif"))

cat("=== FISHING EFFORT LOADED ===\n")
cat("Pelagic and demersal longline effort rasters\n")
```

## Load bird distributions

```{r load-bird-distributions}
# Clay age-class distributions for Bird Island
bird_fb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_FB_1990-2009.tif"))
bird_sb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_SB_1990-2009.tif"))
bird_nb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_NB_1990-2009.tif"))
bird_j2j3 <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_J2+3_1990-2009.tif"))
bird_imm <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_IMM_1990-2009.tif"))

bird_dists_clay <- list(
  fb = bird_fb,
  sb = bird_sb,
  nb = bird_nb,
  j2j3 = bird_j2j3,
  imm = bird_imm
)

cat("\n=== CLAY DISTRIBUTIONS (Bird Island) ===\n")
cat("Loaded 5 age-class distributions\n")

# Carneiro distributions for other populations
crozet_dist <- rast(here("data/WAAL_dist_Carneiro/Wandering_Albatross_Crozet_year-round.tif"))
kerguelen_dist <- rast(here("data/WAAL_dist_Carneiro/Wandering_Albatross_Kerguelen_year-round.tif"))

cat("\n=== CARNEIRO DISTRIBUTIONS (Other populations) ===\n")
cat("Loaded Crozet and Kerguelen\n")
```

## Load demographic data

```{r load-demographics}
# Load demographic proportions for Bird Island
dem_props <- read_csv(here("data/WAAL_dist_Clay2019/Dem_props copy.csv"),
                      show_col_types = FALSE) %>%
  mutate(Dem_class = str_replace(Dem_class, "J2\\+3", "J2J3"))

dem_props_summary <- dem_props %>%
  group_by(Dem_class) %>%
  summarise(mean_prop = mean(Prop), mean_pop = mean(Pop))

age_class_props <- c(
  fb = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "FB"],
  sb = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "SB"],
  nb = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "NB"],
  j2j3 = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "J2J3"],
  imm = dem_props_summary$mean_prop[dem_props_summary$Dem_class == "IMM"]
)

pop_sizes <- c(
  fb = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "FB"],
  sb = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "SB"],
  nb = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "NB"],
  j2j3 = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "J2J3"],
  imm = dem_props_summary$mean_pop[dem_props_summary$Dem_class == "IMM"]
)

cat("\n=== BIRD ISLAND DEMOGRAPHICS ===\n")
cat("Age class proportions:\n")
print(age_class_props)
cat("\nAge class population sizes:\n")
print(pop_sizes)
cat("\nTotal BI population:", sum(pop_sizes), "\n")
```

## Define population structure

```{r define-populations}
# Breeding pair estimates (from Carneiro et al. 2020)
breeding_pairs <- tibble(
  population = c("Bird_Island", "Crozet", "Kerguelen", "PEI"),
  pairs = c(
    931.8,   # Bird Island (60% of 1553 SG pairs)
    340,     # Crozet
    354,     # Kerguelen
    3700     # Prince Edward + Marion combined
  ),
  data_source = c("Clay", "Carneiro", "Carneiro", "Carneiro (Crozet proxy)")
)

total_pairs <- sum(breeding_pairs$pairs)
breeding_pairs <- breeding_pairs %>%
  mutate(proportion = pairs / total_pairs,
         percent = proportion * 100)

cat("\n=== GLOBAL POPULATION STRUCTURE ===\n")
cat("Total breeding pairs:", total_pairs, "\n\n")
print(breeding_pairs)

# Extract proportions for weighting
prop_BI <- breeding_pairs$proportion[breeding_pairs$population == "Bird_Island"]
prop_crozet <- breeding_pairs$proportion[breeding_pairs$population == "Crozet"]
prop_kerg <- breeding_pairs$proportion[breeding_pairs$population == "Kerguelen"]
prop_pei <- breeding_pairs$proportion[breeding_pairs$population == "PEI"]
```

## Load basemap

```{r load-basemap}
ne_land <- st_read(here("data/ne_10m_land/ne_10m_land.shp"), quiet = TRUE)
map_extent <- c(-180, 180, -90, 0)
```

# Build Total WAAL Density

This is the key step: combine Clay (BI) + Carneiro (others) to create the total WAAL density needed for catchability calculation.

```{r build-total-waal-density}
# Use fishing effort as template for grid alignment
template <- fishing_pel

# Resample all distributions to common grid
cat("\n=== ALIGNING RASTERS TO COMMON GRID ===\n")

crozet_aligned <- resample(crozet_dist, template, method = "bilinear")
kerguelen_aligned <- resample(kerguelen_dist, template, method = "bilinear")

clay_aligned <- map(bird_dists_clay, function(r) {
  resample(r, template, method = "bilinear")
})

fishing_pel_aligned <- fishing_pel  # Already on this grid
fishing_dem_aligned <- resample(fishing_dem, template, method = "bilinear")

cat("All rasters aligned\n")
cat("Grid dimensions:", dim(template)[1:2], "\n")

# Normalize each distribution to sum to 1
cat("\n=== NORMALIZING DISTRIBUTIONS ===\n")

crozet_norm <- crozet_aligned / global(crozet_aligned, "sum", na.rm = TRUE)[1,1]
kerguelen_norm <- kerguelen_aligned / global(kerguelen_aligned, "sum", na.rm = TRUE)[1,1]

clay_norm <- map(clay_aligned, function(r) {
  r_zero <- subst(r, NA, 0)
  r_sum <- global(r_zero, "sum", na.rm = TRUE)[1,1]
  return(r_zero / r_sum)
})

cat("Each distribution normalized to sum to 1\n")

# Weight Clay age classes by their proportions, then sum to get BI total
cat("\n=== BUILDING BI DENSITY FROM CLAY ===\n")

clay_weighted <- map2(clay_norm, age_class_props, function(r, prop) {
  r * prop
})

BI_density_norm <- Reduce("+", clay_weighted)  # Normalized BI distribution
BI_density <- BI_density_norm * prop_BI         # Weighted by global proportion

cat("BI density created from Clay age classes\n")

# Build other population densities
cat("\n=== BUILDING OTHER POPULATION DENSITIES ===\n")

crozet_density <- crozet_norm * prop_crozet
kerguelen_density <- kerguelen_norm * prop_kerg
pei_density <- crozet_norm * prop_pei  # Use Crozet as proxy

cat("Crozet, Kerguelen, and PEI densities created\n")

# Combine to get total WAAL density
total_bird_density <- BI_density + crozet_density + kerguelen_density + pei_density

cat("\n=== TOTAL WAAL DENSITY VERIFICATION ===\n")
cat("Components (should sum to 1.0):\n")
cat("  Bird Island (Clay):   ", round(global(BI_density, "sum", na.rm = TRUE)[1,1], 4), "\n")
cat("  Crozet (Carneiro):    ", round(global(crozet_density, "sum", na.rm = TRUE)[1,1], 4), "\n")
cat("  Kerguelen (Carneiro): ", round(global(kerguelen_density, "sum", na.rm = TRUE)[1,1], 4), "\n")
cat("  PEI (Crozet proxy):   ", round(global(pei_density, "sum", na.rm = TRUE)[1,1], 4), "\n")
cat("  -----------------------\n")
cat("  TOTAL:                ", round(global(total_bird_density, "sum", na.rm = TRUE)[1,1], 4), "\n\n")
```

# Calculate Catchability

Using the combined total WAAL density (Clay BI + Carneiro others)

```{r calculate-catchability}
# Calculate global parameters
total_hooks_pel <- global(fishing_pel_aligned, "sum", na.rm = TRUE)[1,1]
total_hooks_dem <- global(fishing_dem_aligned, "sum", na.rm = TRUE)[1,1]

# Sum of hooks × birds (denominator of catchability)
hooks_x_birds_pel <- fishing_pel_aligned * total_bird_density
sum_hooks_x_birds_pel <- global(hooks_x_birds_pel, "sum", na.rm = TRUE)[1,1]

hooks_x_birds_dem <- fishing_dem_aligned * total_bird_density
sum_hooks_x_birds_dem <- global(hooks_x_birds_dem, "sum", na.rm = TRUE)[1,1]

cat("\n=== GLOBAL PARAMETERS ===\n")
cat("Pelagic:\n")
cat("  Total hooks:        ", format(total_hooks_pel, big.mark = ","), "\n")
cat("  Sum(hooks × birds): ", format(sum_hooks_x_birds_pel, big.mark = ","), "\n")

cat("\nDemersal:\n")
cat("  Total hooks:        ", format(total_hooks_dem, big.mark = ","), "\n")
cat("  Sum(hooks × birds): ", format(sum_hooks_x_birds_dem, big.mark = ","), "\n")

# BPUE values (placeholders - will come from literature review)
bpue_pel <- 0.008547  # Mean from Tuck 2015
bpue_dem <- 0.001837540  # Tuck 2015 baseline

cat("\n=== BPUE VALUES (PLACEHOLDER) ===\n")
cat("Pelagic BPUE:  ", bpue_pel, "birds per 1000 hooks\n")
cat("Demersal BPUE: ", bpue_dem, "birds per 1000 hooks\n")

# Calculate catchability (β)
beta_pel <- (bpue_pel / 1000 * total_hooks_pel) / sum_hooks_x_birds_pel
beta_dem <- (bpue_dem / 1000 * total_hooks_dem) / sum_hooks_x_birds_dem

cat("\n=== CATCHABILITY (β) ===\n")
cat("Pelagic:  ", format(beta_pel, scientific = TRUE), "\n")
cat("Demersal: ", format(beta_dem, scientific = TRUE), "\n")
```

# Calculate Bycatch Directly by Age Class

Apply catchability to Clay age-class densities - no need for % BI map!

```{r calculate-bycatch}
cat("\n=== CALCULATING BYCATCH BY AGE CLASS ===\n\n")

# Prepare BI bird densities by age class (weighted and scaled)
bird_densities_by_age <- map(clay_weighted, function(r) {
  r * prop_BI
})

# PELAGIC bycatch by age class
byc_pel_by_age <- imap(bird_densities_by_age, function(bird_density, age_name) {
  bycatch_map <- fishing_pel_aligned * bird_density * beta_pel
  bycatch_total <- global(bycatch_map, "sum", na.rm = TRUE)[1,1]

  cat(toupper(age_name), ": ", round(bycatch_total, 2), "birds (pelagic)\n")

  return(list(map = bycatch_map, total = bycatch_total))
})

cat("\n")

# DEMERSAL bycatch by age class
byc_dem_by_age <- imap(bird_densities_by_age, function(bird_density, age_name) {
  bycatch_map <- fishing_dem_aligned * bird_density * beta_dem
  bycatch_total <- global(bycatch_map, "sum", na.rm = TRUE)[1,1]

  cat(toupper(age_name), ": ", round(bycatch_total, 2), "birds (demersal)\n")

  return(list(map = bycatch_map, total = bycatch_total))
})

# Extract totals
byc_pel_totals <- map_dbl(byc_pel_by_age, "total")
byc_dem_totals <- map_dbl(byc_dem_by_age, "total")

cat("\n=== TOTALS ===\n")
cat("Pelagic:  ", round(sum(byc_pel_totals), 2), "birds/year\n")
cat("Demersal: ", round(sum(byc_dem_totals), 2), "birds/year\n")
cat("TOTAL:    ", round(sum(byc_pel_totals) + sum(byc_dem_totals), 2), "birds/year\n")
```

# Summary Tables

```{r summary-tables}
# Bycatch summary
bycatch_summary <- tibble(
  age_class = names(byc_pel_totals),
  pelagic = byc_pel_totals,
  demersal = byc_dem_totals,
  total = byc_pel_totals + byc_dem_totals
) %>%
  bind_rows(tibble(
    age_class = "TOTAL",
    pelagic = sum(byc_pel_totals),
    demersal = sum(byc_dem_totals),
    total = sum(byc_pel_totals) + sum(byc_dem_totals)
  ))

cat("\n=== BYCATCH SUMMARY ===\n")
print(bycatch_summary)

# Per capita rates
percap_summary <- tibble(
  age_class = names(pop_sizes),
  population = pop_sizes,
  byc_pel = byc_pel_totals,
  byc_dem = byc_dem_totals,
  percap_pel = byc_pel_totals / pop_sizes,
  percap_dem = byc_dem_totals / pop_sizes,
  percap_total = (byc_pel_totals + byc_dem_totals) / pop_sizes
)

cat("\n=== PER CAPITA RATES ===\n")
print(percap_summary)
```

# Visualizations

## Map basemap

```{r map-basemap, fig.width=12, fig.height=8}
# Define map extent to show full Southern Ocean
map_extent <- c(-180, 180, -90, 0)

p_basemap <- ggplot() +
  geom_sf(data = ne_land, fill = "grey80", color = "grey40", linewidth = 0.3) +
  coord_sf(xlim = map_extent[1:2],
           ylim = map_extent[3:4],
           expand = FALSE) +
  labs(title = "Study Area - Southern Ocean") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.5)
  )

print(p_basemap)

dir.create(here("output/maps"), showWarnings = FALSE, recursive = TRUE)
ggsave(here("output/maps/basemap_final.png"), p_basemap,
       width = 12, height = 8, dpi = 300)
```

## Map total WAAL density

```{r map-total-density, fig.width=12, fig.height=8}
# Mask low values
total_density_masked <- total_bird_density
total_density_masked[total_density_masked < 0.001] <- NA

df_density <- as.data.frame(total_density_masked, xy = TRUE, na.rm = TRUE)
names(df_density)[3] <- "density"

p_total_density <- ggplot(df_density, aes(x = x, y = y, fill = density)) +
  geom_raster() +
  geom_sf(data = ne_land, inherit.aes = FALSE, fill = "grey80", color = NA) +
  coord_sf(xlim = map_extent[1:2],
           ylim = map_extent[3:4],
           expand = FALSE) +
  scale_fill_viridis_c(
    name = "Density",
    na.value = "white",
    option = "viridis",
    direction = -1
  ) +
  labs(title = "Total WAAL Density (Clay BI + Carneiro Others)") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    legend.position = "right"
  )

print(p_total_density)

ggsave(here("output/maps/total_waal_density_final.png"), p_total_density,
       width = 12, height = 8, dpi = 300)
```

## Map bycatch density

```{r map-bycatch, fig.width=12, fig.height=6}
# Function to map bycatch
map_bycatch <- function(rast_obj, title) {
  df <- as.data.frame(rast_obj, xy = TRUE, na.rm = TRUE)
  names(df)[3] <- "bycatch"

  ggplot(df, aes(x = x, y = y, fill = bycatch)) +
    geom_raster() +
    geom_sf(data = ne_land, inherit.aes = FALSE, fill = "grey80", color = NA) +
    coord_sf(xlim = c(ext_rast[1], ext_rast[2]),
             ylim = c(ext_rast[3], ext_rast[4]),
             expand = FALSE) +
    scale_fill_viridis_c(
      name = "Bycatch\nDensity",
      na.value = "white",
      direction = -1
    ) +
    labs(title = title) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 12, face = "bold"),
      legend.position = "right"
    )
}

# Sum across age classes for total maps
BI_total_bycatch_pel <- Reduce("+", map(byc_pel_by_age, "map"))
BI_total_bycatch_dem <- Reduce("+", map(byc_dem_by_age, "map"))

p_byc_pel <- map_bycatch(BI_total_bycatch_pel, "Pelagic Bycatch (Clay+Carneiro Method)")
p_byc_dem <- map_bycatch(BI_total_bycatch_dem, "Demersal Bycatch (Clay+Carneiro Method)")

p_byc_pel | p_byc_dem

ggsave(here("output/maps/bycatch_pelagic_final.png"), p_byc_pel,
       width = 10, height = 6, dpi = 300)
ggsave(here("output/maps/bycatch_demersal_final.png"), p_byc_dem,
       width = 10, height = 6, dpi = 300)
```

## Map by age class

```{r map-by-age, fig.width=15, fig.height=10}
byc_pel_maps <- map(byc_pel_by_age, "map")
byc_dem_maps <- map(byc_dem_by_age, "map")

# Pelagic age class maps
byc_pel_age_maps <- imap(byc_pel_maps, function(r, age) {
  map_bycatch(r, paste0("Pelagic: ", toupper(age)))
})

wrap_plots(byc_pel_age_maps, ncol = 3)

iwalk(byc_pel_age_maps, function(p, age) {
  ggsave(here(paste0("output/maps/bycatch_pelagic_", age, "_final.png")),
         p, width = 8, height = 6, dpi = 300)
})

# Demersal age class maps
byc_dem_age_maps <- imap(byc_dem_maps, function(r, age) {
  map_bycatch(r, paste0("Demersal: ", toupper(age)))
})

wrap_plots(byc_dem_age_maps, ncol = 3)

iwalk(byc_dem_age_maps, function(p, age) {
  ggsave(here(paste0("output/maps/bycatch_demersal_", age, "_final.png")),
         p, width = 8, height = 6, dpi = 300)
})
```

# Save Outputs

```{r save-outputs}
dir.create(here("output/rasters"), showWarnings = FALSE, recursive = TRUE)

# Save total WAAL density (KEY OUTPUT)
writeRaster(total_bird_density,
            here("output/rasters/total_waal_density_clay_carneiro.tif"),
            overwrite = TRUE)

# Save BI density components by age
iwalk(bird_densities_by_age, function(r, age_name) {
  writeRaster(r, here(paste0("output/rasters/BI_density_", age_name, "_final.tif")),
              overwrite = TRUE)
})

# Save summaries
write_csv(bycatch_summary, here("output/bycatch_summary_final.csv"))
write_csv(percap_summary, here("output/bycatch_percapita_summary_final.csv"))
write_csv(breeding_pairs, here("output/breeding_pairs_final.csv"))

cat("\nAll outputs saved successfully\n")
```

# Compare with Previous Methods

```{r compare-previous}
# Compare with 03c if available
if (file.exists(here("output/bycatch_summary_03c.csv"))) {
  byc_03c <- read_csv(here("output/bycatch_summary_03c.csv"),
                      show_col_types = FALSE)

  comparison <- tibble(
    age_class = bycatch_summary$age_class,
    pelagic_03c = byc_03c$pelagic,
    pelagic_final = bycatch_summary$pelagic,
    pelagic_ratio = bycatch_summary$pelagic / byc_03c$pelagic,
    demersal_03c = byc_03c$demersal,
    demersal_final = bycatch_summary$demersal,
    demersal_ratio = bycatch_summary$demersal / byc_03c$demersal
  )

  cat("\n=== COMPARISON: 03c vs FINAL ===\n")
  print(comparison)

  write_csv(comparison, here("output/bycatch_comparison_03c_vs_final.csv"))
}
```

# Notes

**Method Summary:**

This script uses the **standardized Clay + Carneiro approach**:

1. **Bird Island**: Clay age-class distributions (5 age classes)
2. **Other populations**: Carneiro year-round distributions (Crozet, Kerguelen, PEI)
3. **Total WAAL density**: Weighted sum of all populations
4. **Catchability**: Calculated using total WAAL density (all populations)
5. **Bycatch**: Applied directly to Clay age-class densities

**Key advantages:**
- Uses actual age-class data (Clay) for our study population (BI)
- No % BI map needed - we have BI densities directly
- Theoretically sound - catchability calculated from all WAAL
- Consistent and reproducible
- Validated: Clay BI ≈ Carneiro SG (r=0.98)

**Next steps:**
1. Replace placeholder BPUE with literature values (script 04)
2. Implement spatial catchability (different β per region)
3. Integrate per capita rates into demographic matrix model
4. Sensitivity analyses

# Session Info

```{r session-info}
sessionInfo()
```
