---
title: "Compare Carneiro SG with Clay Total Distribution"
author: "WAAL Bycatch Project"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 12,
  fig.height = 8
)
```

# Overview

This script compares two different estimates of Bird Island/South Georgia spatial distribution:

1. **Carneiro et al. 2020**: Population-specific distribution for South Georgia
2. **Clay et al. 2019**: Sum of all age-class distributions from Bird Island tracking data

These should represent the same population (South Georgia = Bird Island), but may differ due to:
- Different time periods
- Different individuals tracked
- Different analytical methods

**Goal:** Determine if they're consistent enough to combine, or if we need to choose one.

# Setup

```{r libraries}
library(tidyverse)
library(terra)
library(sf)
library(here)
library(viridis)
library(patchwork)
```

# Load Distributions

## Carneiro South Georgia Distribution

```{r load-carneiro}
# From Carneiro et al. 2020
carneiro_sg <- rast(here("data/WAAL_dist_Carneiro/Wandering_Albatross_South_Georgia_year-round.tif"))

# Normalize to sum to 1
carneiro_sg_zero <- subst(carneiro_sg, NA, 0)
carneiro_sg_sum <- global(carneiro_sg_zero, "sum", na.rm = TRUE)[1,1]
carneiro_sg_norm <- carneiro_sg_zero / carneiro_sg_sum

cat("Carneiro South Georgia distribution:\n")
cat("  Sum (normalized):", global(carneiro_sg_norm, "sum", na.rm = TRUE)[1,1], "\n")
cat("  Cells with data:", nrow(as.data.frame(carneiro_sg_norm, na.rm = TRUE)), "\n")
```

## Clay Age-Class Distributions

```{r load-clay}
# Load all Clay et al. 2019 age-class distributions
clay_fb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_FB_1990-2009.tif"))
clay_sb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_SB_1990-2009.tif"))
clay_nb <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_NB_1990-2009.tif"))
clay_j2j3 <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_J2+3_1990-2009.tif"))
clay_imm <- rast(here("data/WAAL_dist_Clay2019/WA_AllMonths_Both_IMM_1990-2009.tif"))

clay_dists <- list(
  fb = clay_fb,
  sb = clay_sb,
  nb = clay_nb,
  j2j3 = clay_j2j3,
  imm = clay_imm
)

# Normalize each distribution
clay_dists_norm <- map(clay_dists, function(r) {
  r_zero <- subst(r, NA, 0)
  r_sum <- global(r_zero, "sum", na.rm = TRUE)[1,1]
  r_norm <- r_zero / r_sum
  return(r_norm)
})

cat("\nClay age-class distributions (normalized):\n")
clay_sums <- map_dbl(clay_dists_norm, ~global(.x, "sum", na.rm = TRUE)[1,1])
print(clay_sums)
```

## Sum Clay Distributions

```{r sum-clay}
# Load demographic proportions to weight age classes
dem_props <- read_csv(here("data/WAAL_dist_Clay2019/Dem_props copy.csv"),
                      show_col_types = FALSE) %>%
  mutate(Dem_class = str_replace(Dem_class, "J2\\+3", "J2J3"))

# Calculate mean proportions
age_class_props <- dem_props %>%
  group_by(Dem_class) %>%
  summarise(mean_prop = mean(Prop)) %>%
  filter(Dem_class %in% c("FB", "SB", "NB", "J2J3", "IMM"))

cat("\nAge class proportions:\n")
print(age_class_props)

# Weight each age class by its proportion of the population
clay_fb_weighted <- clay_dists_norm$fb * age_class_props$mean_prop[age_class_props$Dem_class == "FB"]
clay_sb_weighted <- clay_dists_norm$sb * age_class_props$mean_prop[age_class_props$Dem_class == "SB"]
clay_nb_weighted <- clay_dists_norm$nb * age_class_props$mean_prop[age_class_props$Dem_class == "NB"]
clay_j2j3_weighted <- clay_dists_norm$j2j3 * age_class_props$mean_prop[age_class_props$Dem_class == "J2J3"]
clay_imm_weighted <- clay_dists_norm$imm * age_class_props$mean_prop[age_class_props$Dem_class == "IMM"]

# Sum all weighted age classes
clay_total <- clay_fb_weighted + clay_sb_weighted + clay_nb_weighted +
              clay_j2j3_weighted + clay_imm_weighted

# Normalize to sum to 1 for comparison
clay_total_sum <- global(clay_total, "sum", na.rm = TRUE)[1,1]
clay_total_norm <- clay_total / clay_total_sum

cat("\nClay total (sum of weighted age classes):\n")
cat("  Sum before normalization:", clay_total_sum, "(should be ~0.93 - excludes J1)\n")
cat("  Sum after normalization:", global(clay_total_norm, "sum", na.rm = TRUE)[1,1], "\n")
cat("  Cells with data:", nrow(as.data.frame(clay_total_norm, na.rm = TRUE)), "\n")
```

# Align Rasters

```{r align-rasters}
# Use Carneiro as template (it has the broader extent)
template <- carneiro_sg_norm

# Resample Clay to match Carneiro grid
clay_total_aligned <- resample(clay_total_norm, template, method = "bilinear")

cat("Rasters aligned to common grid\n")
cat("Template dimensions:", dim(template), "\n")
```

# Compare Distributions

## Calculate Difference

```{r calculate-difference}
# Difference: Clay - Carneiro
diff_clay_carneiro <- clay_total_aligned - carneiro_sg_norm

# Where does Clay have MORE birds than Carneiro?
clay_higher <- ifel(diff_clay_carneiro > 0, diff_clay_carneiro, NA)

# Where does Carneiro have MORE birds than Clay?
carneiro_higher <- ifel(diff_clay_carneiro < 0, abs(diff_clay_carneiro), NA)

cat("Difference statistics:\n")
cat("  Mean difference:", global(diff_clay_carneiro, "mean", na.rm = TRUE)[1,1], "\n")
cat("  SD of difference:", global(diff_clay_carneiro, "sd", na.rm = TRUE)[1,1], "\n")
cat("  Max Clay higher:", global(clay_higher, "max", na.rm = TRUE)[1,1], "\n")
cat("  Max Carneiro higher:", global(carneiro_higher, "max", na.rm = TRUE)[1,1], "\n")
```

## Calculate Correlation

```{r calculate-correlation}
# Extract values as data frame for correlation
carneiro_vals <- as.data.frame(carneiro_sg_norm, xy = TRUE, na.rm = TRUE)
clay_vals <- as.data.frame(clay_total_aligned, xy = TRUE, na.rm = TRUE)

# Merge on coordinates
comparison_df <- inner_join(
  carneiro_vals %>% rename(carneiro = 3),
  clay_vals %>% rename(clay = 3),
  by = c("x", "y")
)

# Calculate correlation
cor_pearson <- cor(comparison_df$carneiro, comparison_df$clay, use = "complete.obs")
cor_spearman <- cor(comparison_df$carneiro, comparison_df$clay,
                    method = "spearman", use = "complete.obs")

cat("\nCorrelation between Carneiro and Clay:\n")
cat("  Pearson r:", round(cor_pearson, 3), "\n")
cat("  Spearman rho:", round(cor_spearman, 3), "\n")
```

# Visualize Comparison

## Load base map

```{r load-basemap}
ne_land <- st_read(here("data/ne_10m_land/ne_10m_land.shp"), quiet = TRUE)
map_extent <- c(-180, 180, -90, 0)
```

## Side-by-side maps

```{r map-comparison, fig.width=14, fig.height=10}
# Function to map distribution
map_dist <- function(rast_obj, title) {
  df <- as.data.frame(rast_obj, xy = TRUE, na.rm = TRUE)
  names(df)[3] <- "density"

  ggplot(df, aes(x = x, y = y, fill = density)) +
    geom_raster() +
    geom_sf(data = ne_land, inherit.aes = FALSE, fill = "grey80", color = NA) +
    coord_sf(xlim = map_extent[1:2], ylim = map_extent[3:4], expand = FALSE) +
    scale_fill_viridis_c(
      name = "Density",
      na.value = "white",
      option = "plasma"
    ) +
    labs(title = title) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 11, face = "bold"),
      legend.position = "right"
    )
}

p1 <- map_dist(carneiro_sg_norm, "Carneiro South Georgia Distribution")
p2 <- map_dist(clay_total_aligned, "Clay Total (Sum of Age Classes)")

# Difference map
df_diff <- as.data.frame(diff_clay_carneiro, xy = TRUE, na.rm = TRUE)
names(df_diff)[3] <- "difference"

p3 <- ggplot(df_diff, aes(x = x, y = y, fill = difference)) +
  geom_raster() +
  geom_sf(data = ne_land, inherit.aes = FALSE, fill = "grey80", color = NA) +
  coord_sf(xlim = map_extent[1:2], ylim = map_extent[3:4], expand = FALSE) +
  scale_fill_gradient2(
    name = "Difference\n(Clay - Carneiro)",
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = 0,
    na.value = "white"
  ) +
  labs(title = "Difference: Clay minus Carneiro (Positive = Clay higher)") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 11, face = "bold"),
    legend.position = "right"
  )

# Display
(p1 | p2) / p3
```

## Scatter plot

```{r scatter-plot, fig.width=8, fig.height=6}
ggplot(comparison_df, aes(x = carneiro, y = clay)) +
  geom_point(alpha = 0.3, size = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(
    title = "Correlation between Carneiro SG and Clay Total Distributions",
    subtitle = paste0("Pearson r = ", round(cor_pearson, 3),
                     ", Spearman rho = ", round(cor_spearman, 3)),
    x = "Carneiro South Georgia (normalized density)",
    y = "Clay Total (normalized density)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

# Quantify Agreement

```{r quantify-agreement}
# Calculate metrics of agreement
comparison_df <- comparison_df %>%
  mutate(
    abs_diff = abs(clay - carneiro),
    rel_diff = abs_diff / carneiro,
    agree_10pct = abs_diff < 0.10,
    agree_20pct = abs_diff < 0.20
  )

agreement_stats <- tibble(
  metric = c(
    "Mean absolute difference",
    "Median absolute difference",
    "% cells with <10% difference",
    "% cells with <20% difference",
    "Mean relative difference",
    "Pearson correlation",
    "Spearman correlation"
  ),
  value = c(
    mean(comparison_df$abs_diff, na.rm = TRUE),
    median(comparison_df$abs_diff, na.rm = TRUE),
    100 * mean(comparison_df$agree_10pct, na.rm = TRUE),
    100 * mean(comparison_df$agree_20pct, na.rm = TRUE),
    mean(comparison_df$rel_diff[is.finite(comparison_df$rel_diff)], na.rm = TRUE),
    cor_pearson,
    cor_spearman
  )
) %>%
  mutate(value = round(value, 3))

cat("\n=== AGREEMENT METRICS ===\n")
print(agreement_stats)
```

# Interpretation

```{r interpretation}
cat("\n=== INTERPRETATION ===\n\n")

if (cor_pearson > 0.9) {
  cat("✓ STRONG AGREEMENT (r > 0.9)\n")
  cat("The Carneiro and Clay distributions are highly correlated.\n")
  cat("They capture similar spatial patterns of South Georgia/Bird Island WAAL.\n\n")
} else if (cor_pearson > 0.7) {
  cat("~ MODERATE AGREEMENT (0.7 < r < 0.9)\n")
  cat("The distributions show similar patterns but with some differences.\n")
  cat("Consider which source is more appropriate for your analysis.\n\n")
} else {
  cat("✗ WEAK AGREEMENT (r < 0.7)\n")
  cat("The distributions differ substantially.\n")
  cat("Investigate reasons for discrepancy before proceeding.\n\n")
}

cat("Recommendations for script 03c:\n\n")

if (cor_pearson > 0.9) {
  cat("1. Either distribution is reasonable for calculating % BI\n")
  cat("2. PREFER CARNEIRO for population allocation (population-specific data)\n")
  cat("3. USE CLAY for age-class partitioning (age-specific data)\n")
  cat("4. This is the approach we'll implement in 03c\n")
} else {
  cat("1. Investigate discrepancies before choosing\n")
  cat("2. Consider which data source is more reliable\n")
  cat("3. Document choice and uncertainty\n")
}
```

# Save Outputs

```{r save-outputs}
dir.create(here("output/maps"), showWarnings = FALSE, recursive = TRUE)
dir.create(here("output/rasters"), showWarnings = FALSE, recursive = TRUE)

# Save comparison map
ggsave(here("output/maps/comparison_carneiro_clay.png"),
       (p1 | p2) / p3, width = 14, height = 10, dpi = 300)

# Save scatter plot
ggsave(here("output/maps/correlation_carneiro_clay.png"),
       last_plot(), width = 8, height = 6, dpi = 300)

# Save comparison rasters
writeRaster(diff_clay_carneiro,
            here("output/rasters/difference_clay_carneiro.tif"),
            overwrite = TRUE)

# Save comparison data
write_csv(agreement_stats, here("output/carneiro_clay_agreement.csv"))

cat("\nOutputs saved successfully\n")
```

# Session Info

```{r session-info}
sessionInfo()
```
