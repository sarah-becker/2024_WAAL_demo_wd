---
title: "WFC_prep_21724"
author: "Sarah Becker"
date: '2024-02-17'
output: html_document
---

```{r, echo= FALSE, include =FALSE}
library(here)
library(tidyverse)
library(RColorBrewer)

#set up various plotting themes
themeo <-theme_classic()+
  theme(strip.background = element_blank(),
        panel.grid.major = element_line(colour = "transparent"), 
        panel.grid.minor = element_line(colour = "transparent"),
        axis.line = element_blank(),
        axis.title = element_text(color = "black", size = 10),
        axis.ticks.length=unit(-0.1, "cm"),
        axis.ticks = element_line(color = "black", size = .25),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=.5),
        panel.spacing = unit(1, "lines"),
        legend.position = "bottom",
        legend.title = element_text(colour = "black", size = 10, face = "bold"),
        legend.text = element_text(color = "black", size =8)) #default legend position
```

**set vital rates. Try first without widowing**
```{r}
#survival rates - drawn from Weimerskirch 1998
s_c <- 0.64 #chick+ fledgling survival year 0-1
s_cc <- 0.7244736 #conditional chick survival (disregarding parental survival) *calculted from other VR, not directly from literature
s_j <- 0.85 #juvenile survival year 1-3
s_i <- 0.92 #immature survival year 3-7
s_s <- 0.94 #subadult survival year 7-10
s_a <- 0.94 #adult survival year 10+
#males show senescence but femailes don't, so not including it here, though perhaps I should since it impacts breeding success?

#fecundity building blocks
#breeding success - drawn from Weimerskirch 1998 &Rackete 2021
bs_a <- 0.76 #adult breeding success

#breeding probability (biennial breeders) - adult rate drawn from Rackete 2021, subadult downscaled slightly from that
bp_a <- 0.45 #adult breeding probablity (biennial breeding, most breeding by age 10)

c <- 0.5# # of female chicks per year

#fecundity 
#f_a <- bs_a*bp_a*c
f_a <- bp_a*c*s_cc
  
#add widowing
#assume 25% prob year1 -> 100% prob year 4?
#Sun et al 2022 - takes 4 years to reach next breeding attempt, breeding prob with new mate after widowhood = ~0.25 (fig5)

w <- 1-0.1^.25
w4 <- 1
```

**create matrix**
```{r}
#set up age-based matrix based on vital rates

#Age classes (years)  0-1        1-2    2-3    3-4    4-5    5-6    6-7    7-8   8-9    nw,          w1,            w2,             w3,             w4 
m <- matrix(data = c(0,          0,    0,      0,     0,     0,     0,     0,      0,   s_a^2*f_a,   s_a^2*f_a*w,   s_a^2*f_a*w,    s_a^2*f_a*w,    s_a^2*f_a*w4,   #0-1
                    s_j,         0,    0,      0,     0,     0,     0,     0,      0,   0,           0,             0,              0,              0,              #1-2
                    0,           s_j,  0,      0,     0,     0,     0,     0,      0,   0,           0,             0,              0,              0,              #2-3
                    0,           0,    s_j,    0,     0,     0,     0,     0,      0,   0,           0,             0,              0,              0,              #3-4
                    0,           0,    0,      s_i,   0,     0,     0,     0,      0,   0,           0,             0,              0,              0,              #4-5
                    0,           0,    0,      0,     s_i,   0,     0,     0,      0,   0,           0,             0,              0,              0,              #5-6
                    0,           0,    0,      0,     0,     s_i,   0,     0,      0,   0,           0,             0,              0,              0,              #6-7
                    0,           0,    0,      0,     0,     0,     s_i,   0,      0,   0,           0,             0,              0,              0,              #7-8
                    0,           0,    0,      0,     0,     0,     0,     s_s,    0,   0,           0,             0,              0,              0,              #8-9
                    0,           0,    0,      0,     0,     0,     0,     0,      s_s, s_a^2,       s_a^2*w,       s_a^2*w,        s_a^2*w,        s_a^2*w4,       #nw
                    0,           0,    0,      0,     0,     0,     0,     0,      0,   s_a*(1-s_a), s_a*(1-s_a)*w, s_a*(1-s_a)*w,  s_a*(1-s_a)*w,  s_a*(1-s_a)*w4, #w1
                    0,           0,    0,      0,     0,     0,     0,     0,      0,   0,           s_a*(1-w),     0,              0,              0,              #w2 
                    0,           0,    0,      0,     0,     0,     0,     0,      0,   0,           0,             s_a*(1-w),      0,              0,              #w3 
                    0,           0,    0,      0,     0,     0,     0,     0,      0,   0,           0,             0,              s_a*(1-w),      0),             #w4 
                   nrow = 14, byrow = TRUE) 
m
```

**extract lambda, SSDs, and RVs from eigenvalues**
```{r}
#deterministic growth rate (lambda)
#extract eigenvalues and lambda from the matrix 
m_eig <- eigen(m)
lambda <- as.numeric(m_eig$values[1])
lambda # this matches the ideal population growth rate in the table

#Stable state distribution
#extract and scale the right eigenvector 
SSD <- round(as.numeric(m_eig$vectors[,1]/sum(m_eig$vectors[,1])),3)
SSD

#extract reproductive values
RV <- as.numeric(eigen(t(m))$vectors[,1]/eigen(t(m))$vectors[1,1])
RV
```

*per capita mortality per hook*
*first, get total population estimates*
```{r}
MI_SDD <- sum(SSD[10:14]) #proportion mature individuals
JI_SDD <- sum(SSD[1:9]) #proportion juvenile/immature/subadult

#total fledged population from MI estimates: 
#from iucn redlist:https://www.iucnredlist.org/species/22698305/132640680#population
# In 1998, the total annual breeding population was estimated at 8,500 pairs, equivalent to c. 28,000 mature individuals (Gales 1998). However, current estimates are 1,553 pairs on South Georgia (Georgias del Sur) (Poncet et al. 2006), 1,800 pairs on Prince Edward Island (2008, Ryan et al. 2009), c. 1,900 pairs on Marion Island (2013, ACAP 2009), c. 340 pairs on Iles Crozet (CNRS Chinzè Monitoring Database 2010), c. 354 pairs in Iles Kerguelen (CNRS Chinzè Monitoring Database 2011), and 4 pairs on Macquarie Island (DPIWPE 2010, unpublished data), making a total of c. 6,000 annual breeding pairs. Using the same ratio as Gales (1998) for estimating the number of mature individuals, this would equate to approximately 20,100 mature individuals.

br_mi_rate <- 20100/6000

#South georgia mature individuals from reported breeding pairs
SG_MI <- 1553*br_mi_rate

#get total pop of fledged birds from MI  numbers and stable state distribution
#MI= MI_SDD*total pop
#total pop = MI/MI_SDD
SG_pop <- SG_MI/MI_SDD

#check against juvenile pop and SDD
juv_pop <- SG_pop-SG_MI #calc juv pop
juv_pop/SG_pop # prop to full fledged pop
JI_SDD #compare to SDD
```
*now, per capita hook mortality*
```{r}
BPUE_1000 <- ((0.5460*0.0108)+(0.3276*(0.0066))+(0.4169*0.1111)+(0.0120*0)+(0.2690*0.044)+(0.01060*0.044))/6 
                                    # #bycatch rate per 1000 hooks for South Atlantic (all south atlantic studies averaged) (Klaer 2012, table 2.5) #0.01111316
#BPUE_1000 <- 0.0308*0.105 #bycatch rate per 1000 hooks for South Atlantic (below 25S) (Klaer 2012, table 2.5) #0.003234
hooks <- 6710000 #average annual number of hooks in South West Atlantic from 1999-2009(Jimenez et al 2016, table 1)
#overlap <- 1466368 #average annual number of hooks in South West Atlantic from 1999-2009 that birds are exposed to (Jimenez et al 2016, table 1)
BPUE_1 <- BPUE_1000/1000 #convert to per 1 hook rate

bycatch_mortality <- BPUE_1*hooks #multiply by average annual hooks

per_cap_bycatch_mortality <- bycatch_mortality/SG_pop
```

*partition mortality between natural and fishery mortality, set efficacy rates*
```{r}
#surv = natural mortality - fishing mortality
#surv - fishing mortality = natural mortality

#fishing mortality = per capita calculation above
fm <- per_cap_bycatch_mortality

#natural mortality
nm_j <- (1-s_j)-fm
nm_i <- (1-s_i)-fm
nm_s <- (1-s_s)-fm
nm_a <- (1-s_a)-fm


mitigation_eff <- 0.8
```


**loop through different bycatch reductions scenarios, find lambda for each**
```{r}
bycatch_reductions <- data.frame(reduction = seq(0, 1, by =0.01), lambda = NA)

for(i in 1:nrow(bycatch_reductions)){

  n_s_j <- 1-((fm*(1-(mitigation_eff*bycatch_reductions$reduction[i])))+(nm_j))
  n_s_i <- 1-((fm*(1-(mitigation_eff*bycatch_reductions$reduction[i])))+(nm_i))
  n_s_s <- 1-((fm*(1-(mitigation_eff*bycatch_reductions$reduction[i])))+(nm_s))
  n_s_a <- 1-((fm*(1-(mitigation_eff*bycatch_reductions$reduction[i])))+(nm_s))

  
#Age classes (years)   0-1     1-2     2-3     3-4     4-5    5-6    6-7    7-8   8-9      nw,              w1,                w2,                w3,                w4 
n_m <- matrix(data = c(0,      0,      0,      0,      0,     0,     0,     0,      0,     n_s_a^2*f_a,     n_s_a^2*f_a*w,     n_s_a^2*f_a*w,     n_s_a^2*f_a*w,     n_s_a^2*f_a*w4,      #0-1
                       n_s_j,  0,      0,      0,      0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #1-2
                       0,      n_s_j,  0,      0,      0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #2-3
                       0,      0,      n_s_j,  0,      0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #3-4
                       0,      0,      0,      n_s_i,  0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #4-5
                       0,      0,      0,      0,      n_s_i, 0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #5-6
                       0,      0,      0,      0,      0,     n_s_i, 0,     0,      0,     0,               0,                 0,                 0,                 0,                   #6-7
                       0,      0,      0,      0,      0,     0,     n_s_i, 0,      0,     0,               0,                 0,                 0,                 0,                   #7-8
                       0,      0,      0,      0,      0,     0,     0,     n_s_s,  0,     0,               0,                 0,                 0,                 0,                   #8-9
                       0,      0,      0,      0,      0,     0,     0,     0,      n_s_s, n_s_a^2,         n_s_a^2*w,         n_s_a^2*w,         n_s_a^2*w,         n_s_a^2*w4,          #nw
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     n_s_a*(1-n_s_a), n_s_a*(1-n_s_a)*w, n_s_a*(1-n_s_a)*w, n_s_a*(1-n_s_a)*w, n_s_a*(1-n_s_a)*w4,  #w1
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     0,               n_s_a*(1-w),       0,                 0,                 0,                   #w2 
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     0,               0,                 n_s_a*(1-w),       0,                 0,                   #w3 
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     0,               0,                 0,                 n_s_a*(1-w),       0),                  #w4 
                    nrow = 14, byrow = TRUE) 
n_m
  
  #extract eigenvalues and lambda from the matrix 
  n_m_eig <- eigen(n_m)
  lambda_n <- as.numeric(n_m_eig$values[1])
  bycatch_reductions$lambda[i] <- lambda_n 

}
```

**plot bycatch reduction against changes to lambda**
```{r}
ggplot(bycatch_reductions)+
  geom_line(aes(x=reduction, y=as.numeric(lambda)))+
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  # geom_vline(aes(xintercept = 0.66), color = "red", alpha =0.5)+ #illegal vs legal fisheries transition
  # geom_vline(aes(xintercept = 0.33), color = "red", alpha =0.5)+ #illegal vs legal fisheries transition
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  themeo+
  coord_cartesian(expand=FALSE)
```

**add uncertainty for mitigation efficacy**
```{r}
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range <- seq(0.5,1, by  = 0.1)
output <- matrix(nrow = length(bycatch_reductions2), ncol = length(mitigation_eff_range)) %>% as.data.frame() 

for(k in 1:length(mitigation_eff_range)){
  mit_eff <- mitigation_eff_range[k]
  
  for(i in 1:length(bycatch_reductions2)){
  
  n_s_j <- 1-((fm*(1-(mit_eff*bycatch_reductions$reduction[i])))+(nm_j))
  n_s_i <- 1-((fm*(1-(mit_eff*bycatch_reductions$reduction[i])))+(nm_i))
  n_s_s <- 1-((fm*(1-(mit_eff*bycatch_reductions$reduction[i])))+(nm_s))
  n_s_a <- 1-((fm*(1-(mit_eff*bycatch_reductions$reduction[i])))+(nm_s))
  
  
 #Age classes (years)   0-1     1-2     2-3     3-4     4-5    5-6    6-7    7-8   8-9      nw,              w1,                w2,                w3,                w4 
n_m <- matrix(data = c(0,      0,      0,      0,      0,     0,     0,     0,      0,     n_s_a^2*f_a,     n_s_a^2*f_a*w,     n_s_a^2*f_a*w,     n_s_a^2*f_a*w,     n_s_a^2*f_a*w4,      #0-1
                       n_s_j,  0,      0,      0,      0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #1-2
                       0,      n_s_j,  0,      0,      0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #2-3
                       0,      0,      n_s_j,  0,      0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #3-4
                       0,      0,      0,      n_s_i,  0,     0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #4-5
                       0,      0,      0,      0,      n_s_i, 0,     0,     0,      0,     0,               0,                 0,                 0,                 0,                   #5-6
                       0,      0,      0,      0,      0,     n_s_i, 0,     0,      0,     0,               0,                 0,                 0,                 0,                   #6-7
                       0,      0,      0,      0,      0,     0,     n_s_i, 0,      0,     0,               0,                 0,                 0,                 0,                   #7-8
                       0,      0,      0,      0,      0,     0,     0,     n_s_s,  0,     0,               0,                 0,                 0,                 0,                   #8-9
                       0,      0,      0,      0,      0,     0,     0,     0,      n_s_s, n_s_a^2,         n_s_a^2*w,         n_s_a^2*w,         n_s_a^2*w,         n_s_a^2*w4,          #nw
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     n_s_a*(1-n_s_a), n_s_a*(1-n_s_a)*w, n_s_a*(1-n_s_a)*w, n_s_a*(1-n_s_a)*w, n_s_a*(1-n_s_a)*w4,  #w1
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     0,               n_s_a*(1-w),       0,                 0,                 0,                   #w2 
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     0,               0,                 n_s_a*(1-w),       0,                 0,                   #w3 
                       0,      0,      0,      0,      0,     0,     0,     0,      0,     0,               0,                 0,                 n_s_a*(1-w),       0),                  #w4 
                    nrow = 14, byrow = TRUE) 
n_m
  
  #extract eigenvalues and lambda from the matrix 
  n_m_eig <- eigen(n_m)
  lambda_n <- as.numeric(n_m_eig$values[1])
  output[i,k] <- lambda_n # this matches the ideal population growth rate in the table

}
}

```

*format output*
```{r}
oldnames = c("V1","V2","V3","V4" ,"V5", "V6")
newnames = c("0.5", "0.6", "0.7", "0.8", "0.9", "1")

output<- output %>%
  rename_with(~ newnames[which(oldnames == .x)], .cols = oldnames)

output$bycatch_reductions <- bycatch_reductions2

output_l <- output %>% 
  pivot_longer(cols = !bycatch_reductions,names_to = "mit_eff", values_to = "lambda")

output_l$mit_eff <- as.numeric(output_l$mit_eff)
```


```{r}
ggplot(output_l)+
  geom_line(aes(x=bycatch_reductions, y=lambda, group = factor(mit_eff), color = factor(mit_eff)))+
  geom_hline(aes(yintercept = 1), color = "darkgrey", alpha =0.5)+ 
  # geom_vline(aes(xintercept = 0.66), color = "red", alpha =0.5)+ #illegal vs legal fisheries transition
  # geom_vline(aes(xintercept = 0.33), color = "red", alpha =0.5)+ #illegal vs legal fisheries transition
  labs(x="% fisheries with bycatch mitigation", y="lambda", color = "% mitigation efficacy")+
  themeo+
  guides(colour = guide_legend(nrow = 1))+
  coord_cartesian(expand=FALSE)+
  scale_color_manual(values=c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494"))
```


*incorporate vital rate uncertainty*
**first, set VR uncertainty from beta dist**
```{r}
#set mean, CI for each vital rate, use these to pull VR rates within beta distribution
#s_c2
s_c2mean <-0.64
s_c2upper_CI <- 0.65
s_c2lower_CI <- 0.63
  
s_c2SE <- (s_c2upper_CI - s_c2lower_CI) / 3.92

s_c2var <- s_c2SE^2

s_c2alpha = s_c2mean * ((1 - s_c2mean) / s_c2var - 1 / s_c2mean)
s_c2beta = (1 - s_c2mean) * ((1 -s_c2mean) /s_c2var - 1 / (1 - s_c2mean))

#s_cc2
s_cc2mean <-0.7244736
s_cc2upper_CI <- 0.73
s_cc2lower_CI <- 0.72
  
s_cc2SE <- (s_cc2upper_CI - s_cc2lower_CI) / 3.92

s_cc2var <- s_cc2SE^2

s_cc2alpha = s_cc2mean * ((1 - s_cc2mean) / s_cc2var - 1 / s_cc2mean)
s_cc2beta = (1 - s_cc2mean) * ((1 -s_cc2mean) /s_cc2var - 1 / (1 - s_cc2mean))

#s_j2
#s_j2mean <-0.825
s_j2mean <-0.85
s_j2upper_CI <- 0.85
# s_j2upper_CI <- 0.89
s_j2lower_CI <- 0.8
  
s_j2SE <- (s_j2upper_CI - s_j2lower_CI) / 3.92

s_j2var <- s_j2SE^2

s_j2alpha = s_j2mean * ((1 - s_j2mean) / s_j2var - 1 / s_j2mean)
s_j2beta = (1 - s_j2mean) * ((1 -s_j2mean) /s_j2var - 1 / (1 - s_j2mean))

# s_i2
 #s_i2mean <-0.925
 s_i2mean <-0.92
 s_i2upper_CI <- 0.94
 s_i2lower_CI <- 0.91
  
 s_i2SE <- ( s_i2upper_CI -  s_i2lower_CI) / 3.92

 s_i2var <-  s_i2SE^2

 s_i2alpha =  s_i2mean * ((1 -  s_i2mean) /  s_i2var - 1 /  s_i2mean)
 s_i2beta = (1 -  s_i2mean) * ((1 - s_i2mean) / s_i2var - 1 / (1 -  s_i2mean))
 
# s_s2
 #s_s2mean <-0.944
 s_s2mean <-0.94
 s_s2upper_CI <- 0.95
 s_s2lower_CI <- 0.94
  
 s_s2SE <- ( s_s2upper_CI -  s_s2lower_CI) / 3.92

 s_s2var <-  s_s2SE^2

 s_s2alpha =  s_s2mean * ((1 -  s_s2mean) /  s_s2var - 1 /  s_s2mean)
 s_s2beta = (1 -  s_s2mean) * ((1 - s_s2mean) / s_s2var - 1 / (1 -  s_s2mean))
 
 # s_a2
 #s_a2mean <-0.945
  s_a2mean <-0.94
 s_a2upper_CI <- 0.95
 s_a2lower_CI <- 0.94
  
 s_a2SE <- ( s_a2upper_CI -  s_a2lower_CI) / 3.92

 s_a2var <-  s_a2SE^2

 s_a2alpha =  s_a2mean * ((1 -  s_a2mean) /  s_a2var - 1 /  s_a2mean)
 s_a2beta = (1 -  s_a2mean) * ((1 - s_a2mean) / s_a2var - 1 / (1 -  s_a2mean))

 
  # bs_a2
 bs_a2mean <-0.76
 bs_a2upper_CI <- 0.8
 bs_a2lower_CI <- 0.68
  
 bs_a2SE <- ( bs_a2upper_CI -  bs_a2lower_CI) / 3.92

 bs_a2var <-  bs_a2SE^2

 bs_a2alpha =  bs_a2mean * ((1 -  bs_a2mean) /  bs_a2var - 1 /  bs_a2mean)
 bs_a2beta = (1 -  bs_a2mean) * ((1 - bs_a2mean) / bs_a2var - 1 / (1 -  bs_a2mean))
 
 
   # bp_a2
 bp_a2mean <-0.45
 bp_a2upper_CI <- 0.7
 bp_a2lower_CI <- 0.4
  
 bp_a2SE <- ( bp_a2upper_CI -  bp_a2lower_CI) / 3.92

 bp_a2var <-  bp_a2SE^2

 bp_a2alpha =  bp_a2mean * ((1 -  bp_a2mean) /  bp_a2var - 1 /  bp_a2mean)
 bp_a2beta = (1 -  bp_a2mean) * ((1 - bp_a2mean) / bp_a2var - 1 / (1 -  bp_a2mean))
 
#fm2
# BPUE_1000 <- ((0.5460*0.0108)+(0.3276*0.0066)+(0.4169*0.1111)+(0.0120*0)+(0.2690*0.044)+(0.01060*0.044))/6 
# hooks <- 6710000 #average annual number of hooks in South West Atlantic from 1999-2009(Jimenez et al 2016, table 1)
# BPUE_1 <- BPUE_1000/1000 #convert to per 1 hook rate
# bycatch_mortality <- BPUE_1*hooks #multiply by average annual hooks
# per_cap_bycatch_mortality <- bycatch_mortality/SG_pop


fm2_mean <- fm
fm2_upperCI <- (((0.4169*0.1111)/1000)*hooks)/SG_pop
fm2_lowerCI <- (((0.01060*0.044)/1000)*hooks)/SG_pop

fm2_SE <- ( fm2_upperCI -  fm2_lowerCI) / 3.92

fm2_var <-  fm2_SE^2

fm2_alpha =  fm2_mean * ((1 -  fm2_mean) /  fm2_var - 1 /  fm2_mean)
fm2_beta = (1 -  fm2_mean) * ((1 - fm2_mean) / fm2_var - 1 / (1 -  fm2_mean))

```

*constrain by biology*
*take rescaled version, add a if next statement to skip any runs where js is higher than s or a s*
*then, filter data to remove any columns where the 0 reduction scenario yields lambda >1, or where with just natural mortality and full mitigation lambda is <1*
```{r}
full_output_IUU <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range <- seq(0.5,1, by  = 0.1)
sims = 1:1000



set.seed(123)

for(k in 1:length(mitigation_eff_range)){
  mit_eff <- mitigation_eff_range[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU_count<- round(runif(1, min = 66, max = 94))
    non_IUU<- round(runif(1, min = 0.66, max = 0.94),2)
    IUU <- round(runif(1, min =0.06, max = 0.34),2)
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
 #   for(i in 1:non_IUU_count){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU[[k]] <- output2_IUU


    }

}
}

full_output_IUU[[1]]
 sim_results_IUU<- full_output_IUU[[1]]
 sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range #0.5 0.6 0.7 0.8 0.9 1.0

mit05_l_IUU <- full_output_IUU[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit06_l_IUU  <- full_output_IUU[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit07_l_IUU  <- full_output_IUU[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit08_l_IUU  <- full_output_IUU[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit09_l_IUU  <- full_output_IUU[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit1_l_IUU  <- full_output_IUU[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU  <- rbind(mit05_l_IUU,mit06_l_IUU,mit07_l_IUU,mit08_l_IUU,mit09_l_IUU,mit1_l_IUU)
fulldat_IUU$mitsim <- paste(fulldat_IUU$mitigation_efficacy, fulldat_IUU$simrun)

mit05_IUU  <- full_output_IUU[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU  <- full_output_IUU[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU  <- full_output_IUU[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU  <- full_output_IUU[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU  <- full_output_IUU[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU  <- full_output_IUU[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU <- rbind(mit05_IUU ,mit06_IUU ,mit07_IUU ,mit08_IUU ,mit09_IUU ,mit1_IUU )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU$mitsim <- paste(full_dat_w_IUU$mitigation_efficacy, full_dat_w_IUU$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU <- fulldat_IUU %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```
*rerun this version with just natural mortality (no fisheries mortality) to see what low values can be removed (anything below lambda for no fishing mortality and full fisheries mitigation)*
```{r}
full_output_IUU <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range <- seq(0.5,1, by  = 0.1)
sims = 1:1000



set.seed(123)

for(k in 1:length(mitigation_eff_range)){
  mit_eff <- mitigation_eff_range[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU_count<- round(runif(1, min = 66, max = 94))
    non_IUU<- round(runif(1, min = 0.66, max = 0.94),2)
    IUU <- round(runif(1, min =0.06, max = 0.34),2)
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
 #   for(i in 1:non_IUU_count){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  # n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  # n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  # n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  # n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  
  n_s_j2 <- 1-nm_j2
  n_s_i2 <- 1-nm_i2
  n_s_s2 <- 1-nm_s2
  n_s_a2 <- 1-nm_s2
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU[[k]] <- output2_IUU


    }

}
}

full_output_IUU[[1]]
 sim_results_IUU<- full_output_IUU[[1]]
 sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range #0.5 0.6 0.7 0.8 0.9 1.0

mit05_l_IUU <- full_output_IUU[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit06_l_IUU  <- full_output_IUU[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit07_l_IUU  <- full_output_IUU[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit08_l_IUU  <- full_output_IUU[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit09_l_IUU  <- full_output_IUU[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit1_l_IUU  <- full_output_IUU[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU  <- rbind(mit05_l_IUU,mit06_l_IUU,mit07_l_IUU,mit08_l_IUU,mit09_l_IUU,mit1_l_IUU)
fulldat_IUU$mitsim <- paste(fulldat_IUU$mitigation_efficacy, fulldat_IUU$simrun)

mit05_IUU  <- full_output_IUU[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU  <- full_output_IUU[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU  <- full_output_IUU[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU  <- full_output_IUU[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU  <- full_output_IUU[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU  <- full_output_IUU[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU <- rbind(mit05_IUU ,mit06_IUU ,mit07_IUU ,mit08_IUU ,mit09_IUU ,mit1_IUU )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU$mitsim <- paste(full_dat_w_IUU$mitigation_efficacy, full_dat_w_IUU$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU <- fulldat_IUU %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```
*which low values to remove?*
```{r}
# Print values of column1 where column2 is greater than 20
lowfilter <- fulldat_IUU %>%
  filter(lambda <1) %>% 
  select(!mean_lambda)

unique(lowfilter$simrun)
#  [1] "V4"   "V13"  "V30"  "V31"  "V59"  "V74"  "V89"  "V165" "V170" "V186" "V281" "V304" "V326" "V377" "V383" "V412" "V453" "V458" "V495" "V521" "V555" "V570" "V573" "V576" "V577" "V635" "V658" "V679"
# [29] "V683" "V687" "V709" "V737" "V777" "V787" "V819" "V822" "V823" "V835" "V846" "V854" "V866" "V956" "V974" "V976" "V987" "V993"
```

*increase sims to 1500, rerun full version, then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1*
```{r}
full_output_IUU <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range <- seq(0.5,1, by  = 0.1)
sims = 1:1500



set.seed(123)

for(k in 1:length(mitigation_eff_range)){
  mit_eff <- mitigation_eff_range[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU_count<- round(runif(1, min = 66, max = 94))
    non_IUU<- round(runif(1, min = 0.66, max = 0.94),2)
    IUU <- round(runif(1, min =0.06, max = 0.34),2)
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
 #   for(i in 1:non_IUU_count){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU[[k]] <- output2_IUU


    }

}
}

full_output_IUU[[1]]
 sim_results_IUU<- full_output_IUU[[1]]
 sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range #0.5 0.6 0.7 0.8 0.9 1.0

mit05_l_IUU <- full_output_IUU[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit06_l_IUU  <- full_output_IUU[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit07_l_IUU  <- full_output_IUU[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit08_l_IUU  <- full_output_IUU[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit09_l_IUU  <- full_output_IUU[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")
mit1_l_IUU  <- full_output_IUU[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU  <- rbind(mit05_l_IUU,mit06_l_IUU,mit07_l_IUU,mit08_l_IUU,mit09_l_IUU,mit1_l_IUU)
fulldat_IUU$mitsim <- paste(fulldat_IUU$mitigation_efficacy, fulldat_IUU$simrun)

mit05_IUU  <- full_output_IUU[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU  <- full_output_IUU[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU  <- full_output_IUU[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU  <- full_output_IUU[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU  <- full_output_IUU[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU  <- full_output_IUU[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU <- rbind(mit05_IUU ,mit06_IUU ,mit07_IUU ,mit08_IUU ,mit09_IUU ,mit1_IUU )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU$mitsim <- paste(full_dat_w_IUU$mitigation_efficacy, full_dat_w_IUU$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU <- fulldat_IUU %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```

*then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1 and replot*
```{r}
highfilter <- fulldat_IUU %>%
  filter(bycatch_reduction ==0 & lambda >=1) %>% 
  select(!mean_lambda)

lowfiltertest <- fulldat_IUU %>% 
  filter(simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993"))

unique(lowfilter$simrun)
#  [1] "V4"   "V13"  "V30"  "V31"  "V59"  "V74"  "V89"  "V165" "V170" "V186" "V281" "V304" "V326" "V377" "V383" "V412" "V453" "V458" "V495" "V521" "V555" "V570" "V573" "V576" "V577" "V635" "V658" "V679"
# [29] "V683" "V687" "V709" "V737" "V777" "V787" "V819" "V822" "V823" "V835" "V846" "V854" "V866" "V956" "V974" "V976" "V987" "V993"
unique(highfilter$simrun)
#  [1] "V12"   "V40"   "V44"   "V49"   "V94"   "V107"  "V153"  "V198"  "V207"  "V245"  "V391"  "V445"  "V452"  "V490"  "V540"  "V611"  "V769"  "V820"  "V843"  "V853"  "V957"  "V973"  "V1151" "V1227" "V1312"
# [26] "V1397"
unique(fulldat_IUU$simrun)

fulldat_IUU_filtered <- fulldat_IUU %>% 
  filter(!simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993", #lowfilter
                     "V12"  , "V40"  , "V44"  , "V49"  , "V94"  , "V107" , "V153" , "V198" , "V207" , "V245" , "V391" , "V445" , "V452" , "V490"  ,"V540" , "V611" , "V769",  "V820" ,
                     "V843" , "V853"  ,"V957" , "V973",  "V1151", "V1227" ,"V1312","V1397")) #highfilter
unique(fulldat_IUU_filtered$simrun)

ggplot(fulldat_IUU_filtered)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)

```

*this looks reasonable*
*now, calculate the probability of lambda being >=1 (aka prob of success) for each bycatch reduction percentile - do this across all mitigation efficacy rates, and broken up by efficacy rates*
```{r}
unique(fulldat_IUU_filtered$bycatch_reduction)

fulldat_IUU_prob1 <- fulldat_IUU_filtered %>% 
  group_by(bycatch_reduction) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_prob1mit <- fulldat_IUU_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))
```

```{r}
ggplot(fulldat_IUU_prob1)+
  geom_line(aes(bycatch_reduction, prob1))+
  theme_bw()
```
```{r}
ggplot(fulldat_IUU_prob1mit)+
  geom_line(aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)))+
  theme_bw()
```
```{r}
ggplot()+
  geom_line(data = fulldat_IUU_prob1mit, aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)), alpha = 0.5)+
  geom_line(data = fulldat_IUU_prob1, aes(bycatch_reduction, prob1))+
   labs(x="% legal fisheries with bycatch mitigation", y="Probability lambda >=1 ", color = "% mitigation efficacy")+
    coord_cartesian(expand=FALSE)+
  theme_bw()
```

*now with my data*
```{r}

# Heatmap 
ggplot(fulldat_IUU_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  scale_fill_viridis_c()

```

*increase # of mit eff categories*
*increase sims to 1500, rerun full version, then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1*
```{r}
full_output_IUU <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range2 <- seq(0.5,1, by  = 0.05)
sims = 1:1500



set.seed(123)

for(k in 1:length(mitigation_eff_range2)){
  mit_eff <- mitigation_eff_range2[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU_count<- round(runif(1, min = 66, max = 94))
    non_IUU<- round(runif(1, min = 0.66, max = 0.94),2)
    IUU <- round(runif(1, min =0.06, max = 0.34),2)
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
 #   for(i in 1:non_IUU_count){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU[[k]] <- output2_IUU


    }

}
}

full_output_IUU[[1]]
 sim_results_IUU<- full_output_IUU[[1]]
 sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range2 #0.50 0.55 0.60 0.65 0.70 0.75 0.80 0.85 0.90 0.95 1.00

mit05_l_IUU <- full_output_IUU[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit055_l_IUU <- full_output_IUU[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit06_l_IUU  <- full_output_IUU[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit065_l_IUU  <- full_output_IUU[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit07_l_IUU  <- full_output_IUU[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit075_l_IUU  <- full_output_IUU[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit08_l_IUU  <- full_output_IUU[[7]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit085_l_IUU  <- full_output_IUU[[8]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit09_l_IUU  <- full_output_IUU[[9]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit095_l_IUU  <- full_output_IUU[[10]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit1_l_IUU  <- full_output_IUU[[11]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU  <- rbind(mit05_l_IUU,mit055_l_IUU,mit06_l_IUU,mit065_l_IUU,mit07_l_IUU,mit075_l_IUU,
                      mit08_l_IUU,mit085_l_IUU,mit09_l_IUU,mit095_l_IUU,mit1_l_IUU)
fulldat_IUU$mitsim <- paste(fulldat_IUU$mitigation_efficacy, fulldat_IUU$simrun)

mit05_IUU  <- full_output_IUU[[1]] %>%  select_if(~all(!is.na(.)))
mit055_IUU  <- full_output_IUU[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU  <- full_output_IUU[[2]] %>%  select_if(~all(!is.na(.)))
mit065_IUU  <- full_output_IUU[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU  <- full_output_IUU[[3]] %>%  select_if(~all(!is.na(.)))
mit075_IUU  <- full_output_IUU[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU  <- full_output_IUU[[4]] %>%  select_if(~all(!is.na(.)))
mit085_IUU  <- full_output_IUU[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU  <- full_output_IUU[[5]] %>%  select_if(~all(!is.na(.)))
mit095_IUU  <- full_output_IUU[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU  <- full_output_IUU[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU <- rbind(mit05_IUU ,mit055_IUU ,mit06_IUU ,mit065_IUU ,mit07_IUU ,mit075_IUU ,
                        mit08_IUU ,mit085_IUU ,mit09_IUU ,mit095_IUU ,mit1_IUU )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU$mitsim <- paste(full_dat_w_IUU$mitigation_efficacy, full_dat_w_IUU$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU <- fulldat_IUU %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```

*then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1 and replot*
```{r}
highfilter <- fulldat_IUU %>%
  filter(bycatch_reduction ==0 & lambda >=1) %>% 
  select(!mean_lambda)

lowfiltertest <- fulldat_IUU %>% 
  filter(simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993"))

unique(lowfilter$simrun)
#  [1] "V4"   "V13"  "V30"  "V31"  "V59"  "V74"  "V89"  "V165" "V170" "V186" "V281" "V304" "V326" "V377" "V383" "V412" "V453" "V458" "V495" "V521" "V555" "V570" "V573" "V576" "V577" "V635" "V658" "V679"
# [29] "V683" "V687" "V709" "V737" "V777" "V787" "V819" "V822" "V823" "V835" "V846" "V854" "V866" "V956" "V974" "V976" "V987" "V993"
unique(highfilter$simrun)
#  [1] "V12"   "V40"   "V44"   "V49"   "V94"   "V107"  "V153"  "V198"  "V207"  "V245"  "V391"  "V445"  "V452"  "V490"  "V540"  "V611"  "V769"  "V820"  "V843"  "V853"  "V957"  "V973"  "V1151" "V1227" "V1312"
# [26] "V1397"
unique(fulldat_IUU$simrun)

fulldat_IUU_filtered <- fulldat_IUU %>% 
  filter(!simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993", #lowfilter
                     "V12"  , "V40"  , "V44"  , "V49"  , "V94"  , "V107" , "V153" , "V198" , "V207" , "V245" , "V391" , "V445" , "V452" , "V490"  ,"V540" , "V611" , "V769",  "V820" ,
                     "V843" , "V853"  ,"V957" , "V973",  "V1151", "V1227" ,"V1312","V1397")) #highfilter
unique(fulldat_IUU_filtered$simrun)

ggplot(fulldat_IUU_filtered)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)

```
*this looks reasonable*
*now, calculate the probability of lambda being >=1 (aka prob of success) for each bycatch reduction percentile - do this across all mitigation efficacy rates, and broken up by efficacy rates*
```{r}
unique(fulldat_IUU_filtered$bycatch_reduction)

fulldat_IUU_prob1 <- fulldat_IUU_filtered %>% 
  group_by(bycatch_reduction) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_prob1mit <- fulldat_IUU_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_meanlambda <- fulldat_IUU_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(mean_lambda =mean(lambda))
```

```{r}
ggplot(fulldat_IUU_prob1)+
  geom_line(aes(bycatch_reduction, prob1))+
  theme_bw()
```

```{r}
ggplot(fulldat_IUU_prob1mit)+
  geom_line(aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)))+
  theme_bw()
```

```{r}
ggplot()+
  geom_line(data = fulldat_IUU_prob1mit, aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)), alpha = 0.5)+
  geom_line(data = fulldat_IUU_prob1, aes(bycatch_reduction, prob1))+
   labs(x="% legal fisheries with bycatch mitigation", y="Probability \u03BB \u2265 1 ", color = "% mitigation efficacy")+
    coord_cartesian(expand=FALSE)+
  #scale_color_viridis_d()+
  theme_bw()
```

*heatplot of prb1*
```{r}

# Heatmap 
ggplot(fulldat_IUU_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
  scale_fill_viridis_c()

```

*heatmap of mean lambda*
```{r}
# Heatmap 
ggplot(fulldat_IUU_meanlambda, aes(bycatch_reduction, mitigation_efficacy, fill= mean_lambda)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Mean \u03BB")+
  scale_fill_viridis_c()
  #scale_fill_distiller(palette = "RdBu")
```


*heatmap of mean lambda^20*
```{r}
# Heatmap 

fulldat_IUU_meanlambda$mean_lambda20 <- fulldat_IUU_meanlambda$mean_lambda^20
ggplot(fulldat_IUU_meanlambda, aes(bycatch_reduction, mitigation_efficacy, fill= mean_lambda20)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Mean \u03BB ^20")+
  scale_fill_viridis_c()
  #scale_fill_distiller(palette = "RdBu")
```


*TEST FOR DIFFERENT IUU AMOUNTS INSTEAD OF VARIED*
*increase # of mit eff categories*
*increase sims to 1500, rerun full version, then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1*
*ZERO BYCATCH*
```{r}
full_output_IUU_none <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range2 <- seq(0.5,1, by  = 0.05)
sims = 1:1500



set.seed(123)

for(k in 1:length(mitigation_eff_range2)){
  mit_eff <- mitigation_eff_range2[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU<- 1
    IUU <- 0
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU_none[[k]] <- output2_IUU


    }

}
}

full_output_IUU_none[[1]]
 # sim_results_IUU<- full_output_IUU[[1]]
 # sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 # sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 # 
 
```


*format output*
```{r}
mitigation_eff_range2 #0.50 0.55 0.60 0.65 0.70 0.75 0.80 0.85 0.90 0.95 1.00

mit05_l_IUU_none <- full_output_IUU_none[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit055_l_IUU_none <- full_output_IUU_none[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit06_l_IUU_none  <- full_output_IUU_none[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit065_l_IUU_none  <- full_output_IUU_none[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit07_l_IUU_none  <- full_output_IUU_none[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit075_l_IUU_none  <- full_output_IUU_none[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit08_l_IUU_none  <- full_output_IUU_none[[7]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit085_l_IUU_none  <- full_output_IUU_none[[8]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit09_l_IUU_none  <- full_output_IUU_none[[9]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit095_l_IUU_none  <- full_output_IUU_none[[10]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit1_l_IUU_none  <- full_output_IUU_none[[11]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU_none  <- rbind(mit05_l_IUU_none,mit055_l_IUU_none,mit06_l_IUU_none,mit065_l_IUU_none,mit07_l_IUU_none,mit075_l_IUU_none,
                      mit08_l_IUU_none,mit085_l_IUU_none,mit09_l_IUU_none,mit095_l_IUU_none,mit1_l_IUU_none)
fulldat_IUU_none$mitsim <- paste(fulldat_IUU_none$mitigation_efficacy, fulldat_IUU_none$simrun)

mit05_IUU_none  <- full_output_IUU_none[[1]] %>%  select_if(~all(!is.na(.)))
mit055_IUU_none  <- full_output_IUU_none[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU_none <- full_output_IUU_none[[2]] %>%  select_if(~all(!is.na(.)))
mit065_IUU_none <- full_output_IUU_none[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU_none  <- full_output_IUU_none[[3]] %>%  select_if(~all(!is.na(.)))
mit075_IUU_none  <- full_output_IUU_none[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU_none  <- full_output_IUU_none[[4]] %>%  select_if(~all(!is.na(.)))
mit085_IUU_none  <- full_output_IUU_none[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU_none  <- full_output_IUU_none[[5]] %>%  select_if(~all(!is.na(.)))
mit095_IUU_none  <- full_output_IUU_none[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU_none  <- full_output_IUU_none[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU_none <- rbind(mit05_IUU_none ,mit055_IUU_none ,mit06_IUU_none ,mit065_IUU_none ,mit07_IUU_none ,mit075_IUU_none ,
                        mit08_IUU_none ,mit085_IUU_none ,mit09_IUU_none ,mit095_IUU_none ,mit1_IUU_none )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU_none$mitsim <- paste(full_dat_w_IUU_none$mitigation_efficacy, full_dat_w_IUU_none$simrun)

```
*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU_none <- fulldat_IUU_none %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU_none)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```

*then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1 and plot*
```{r}

fulldat_IUU_none_filtered <- fulldat_IUU_none %>% 
  filter(!simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993", #lowfilter
                     "V12"  , "V40"  , "V44"  , "V49"  , "V94"  , "V107" , "V153" , "V198" , "V207" , "V245" , "V391" , "V445" , "V452" , "V490"  ,"V540" , "V611" , "V769",  "V820" ,
                     "V843" , "V853"  ,"V957" , "V973",  "V1151", "V1227" ,"V1312","V1397")) #highfilter
unique(fulldat_IUU_none_filtered$simrun)

ggplot(fulldat_IUU_none_filtered)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)

```
*this looks reasonable*
*now, calculate the probability of lambda being >=1 (aka prob of success) for each bycatch reduction percentile - do this across all mitigation efficacy rates, and broken up by efficacy rates*
```{r}
unique(fulldat_IUU_none_filtered$bycatch_reduction)

fulldat_IUU_none_prob1 <- fulldat_IUU_none_filtered %>% 
  group_by(bycatch_reduction) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_none_prob1mit <- fulldat_IUU_none_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_none_meanlambda <- fulldat_IUU_none_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(mean_lambda =mean(lambda))
```

```{r}
ggplot()+
  geom_line(data = fulldat_IUU_none_prob1mit, aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)), alpha = 0.5)+
  geom_line(data = fulldat_IUU_none_prob1, aes(bycatch_reduction, prob1))+
   labs(x="% legal fisheries with bycatch mitigation", y="Probability \u03BB \u2265 1 ", color = "% mitigation efficacy")+
    coord_cartesian(expand=FALSE)+
  #scale_color_viridis_d()+
  theme_bw()
```

*heatmap prob1*
```{r}
ggplot(fulldat_IUU_none_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
  scale_fill_viridis_c()

```

heatmap of mean lambda
```{r}
# Heatmap 
ggplot(fulldat_IUU_none_meanlambda, aes(bycatch_reduction, mitigation_efficacy, fill= mean_lambda)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Mean \u03BB")+
  scale_fill_viridis_c()
  #scale_fill_distiller(palette = "RdBu")
```

*high BYCATCH*
```{r}
full_output_IUU_high <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range2 <- seq(0.5,1, by  = 0.05)
sims = 1:1500



set.seed(123)

for(k in 1:length(mitigation_eff_range2)){
  mit_eff <- mitigation_eff_range2[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU<- 0.66
    IUU <- 0.34
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU_high[[k]] <- output2_IUU


    }

}
}

full_output_IUU_high[[1]]
 # sim_results_IUU<- full_output_IUU[[1]]
 # sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 # sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range2 #0.50 0.55 0.60 0.65 0.70 0.75 0.80 0.85 0.90 0.95 1.00

mit05_l_IUU_high <- full_output_IUU_high[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit055_l_IUU_high <- full_output_IUU_high[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit06_l_IUU_high  <- full_output_IUU_high[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit065_l_IUU_high  <- full_output_IUU_high[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit07_l_IUU_high  <- full_output_IUU_high[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit075_l_IUU_high  <- full_output_IUU_high[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit08_l_IUU_high  <- full_output_IUU_high[[7]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit085_l_IUU_high  <- full_output_IUU_high[[8]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit09_l_IUU_high  <- full_output_IUU_high[[9]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit095_l_IUU_high  <- full_output_IUU_high[[10]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit1_l_IUU_high  <- full_output_IUU_high[[11]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU_high  <- rbind(mit05_l_IUU_high,mit055_l_IUU_high,mit06_l_IUU_high,mit065_l_IUU_high,mit07_l_IUU_high,mit075_l_IUU_high,
                      mit08_l_IUU_high,mit085_l_IUU_high,mit09_l_IUU_high,mit095_l_IUU_high,mit1_l_IUU_high)
fulldat_IUU_high$mitsim <- paste(fulldat_IUU_high$mitigation_efficacy, fulldat_IUU_high$simrun)

mit05_IUU_high  <- full_output_IUU_high[[1]] %>%  select_if(~all(!is.na(.)))
mit055_IUU_high  <- full_output_IUU_high[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU_high  <- full_output_IUU_high[[2]] %>%  select_if(~all(!is.na(.)))
mit065_IUU_high  <- full_output_IUU_high[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU_high  <- full_output_IUU_high[[3]] %>%  select_if(~all(!is.na(.)))
mit075_IUU_high  <- full_output_IUU_high[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU_high  <- full_output_IUU_high[[4]] %>%  select_if(~all(!is.na(.)))
mit085_IUU_high  <- full_output_IUU_high[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU_high  <- full_output_IUU_high[[5]] %>%  select_if(~all(!is.na(.)))
mit095_IUU_high  <- full_output_IUU_high[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU_high  <- full_output_IUU_high[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU_high <- rbind(mit05_IUU_high ,mit055_IUU_high ,mit06_IUU_high ,mit065_IUU_high ,mit07_IUU_high ,mit075_IUU_high ,
                        mit08_IUU_high ,mit085_IUU_high ,mit09_IUU_high ,mit095_IUU_high ,mit1_IUU_high )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU_high$mitsim <- paste(full_dat_w_IUU_high$mitigation_efficacy, full_dat_w_IUU_high$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU_high <- fulldat_IUU_high %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU_high)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```

*then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1 and replot*
```{r}

fulldat_IUU_high_filtered <- fulldat_IUU_high %>% 
  filter(!simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993", #lowfilter
                     "V12"  , "V40"  , "V44"  , "V49"  , "V94"  , "V107" , "V153" , "V198" , "V207" , "V245" , "V391" , "V445" , "V452" , "V490"  ,"V540" , "V611" , "V769",  "V820" ,
                     "V843" , "V853"  ,"V957" , "V973",  "V1151", "V1227" ,"V1312","V1397")) #highfilter
unique(fulldat_IUU_high_filtered$simrun)

ggplot(fulldat_IUU_high_filtered)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)

```
*this looks reasonable*
*now, calculate the probability of lambda being >=1 (aka prob of success) for each bycatch reduction percentile - do this across all mitigation efficacy rates, and broken up by efficacy rates*
```{r}
unique(fulldat_IUU_high_filtered$bycatch_reduction)

fulldat_IUU_high_prob1 <- fulldat_IUU_high_filtered %>% 
  group_by(bycatch_reduction) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_high_prob1mit <- fulldat_IUU_high_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_high_meanlambda <- fulldat_IUU_high_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(mean_lambda =mean(lambda))
```


```{r}
ggplot()+
  geom_line(data = fulldat_IUU_high_prob1mit, aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)), alpha = 0.5)+
  geom_line(data = fulldat_IUU_high_prob1, aes(bycatch_reduction, prob1))+
   labs(x="% legal fisheries with bycatch mitigation", y="Probability \u03BB \u2265 1 ", color = "% mitigation efficacy")+
    coord_cartesian(expand=FALSE)+
  #scale_color_viridis_d()+
  theme_bw()
```

*heatmap prob1*
```{r}
# Heatmap 
ggplot(fulldat_IUU_high_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
  scale_fill_viridis_c()

```

heatmap of mean lambda
```{r}
# Heatmap 
ggplot(fulldat_IUU_high_meanlambda, aes(bycatch_reduction, mitigation_efficacy, fill= mean_lambda)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Mean \u03BB")+
  scale_fill_viridis_c()
  #scale_fill_distiller(palette = "RdBu")
```



*med BYCATCH*
```{r}
full_output_IUU_med <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range2 <- seq(0.5,1, by  = 0.05)
sims = 1:1500



set.seed(123)

for(k in 1:length(mitigation_eff_range2)){
  mit_eff <- mitigation_eff_range2[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU<- 0.8
    IUU <- 0.2
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU_med[[k]] <- output2_IUU


    }

}
}

full_output_IUU_med[[1]]
 # sim_results_IUU<- full_output_IUU[[1]]
 # sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 # sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range2 #0.50 0.55 0.60 0.65 0.70 0.75 0.80 0.85 0.90 0.95 1.00

mit05_l_IUU_med <- full_output_IUU_med[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit055_l_IUU_med <- full_output_IUU_med[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit06_l_IUU_med  <- full_output_IUU_med[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit065_l_IUU_med  <- full_output_IUU_med[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit07_l_IUU_med  <- full_output_IUU_med[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit075_l_IUU_med  <- full_output_IUU_med[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit08_l_IUU_med  <- full_output_IUU_med[[7]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit085_l_IUU_med  <- full_output_IUU_med[[8]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit09_l_IUU_med  <- full_output_IUU_med[[9]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit095_l_IUU_med  <- full_output_IUU_med[[10]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit1_l_IUU_med  <- full_output_IUU_med[[11]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU_med  <- rbind(mit05_l_IUU_med,mit055_l_IUU_med,mit06_l_IUU_med,mit065_l_IUU_med,mit07_l_IUU_med,mit075_l_IUU_med,
                      mit08_l_IUU_med,mit085_l_IUU_med,mit09_l_IUU_med,mit095_l_IUU_med,mit1_l_IUU_med)
fulldat_IUU_med$mitsim <- paste(fulldat_IUU_med$mitigation_efficacy, fulldat_IUU_med$simrun)

mit05_IUU_med  <- full_output_IUU_med[[1]] %>%  select_if(~all(!is.na(.)))
mit055_IUU_med  <- full_output_IUU_med[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU_med  <- full_output_IUU_med[[2]] %>%  select_if(~all(!is.na(.)))
mit065_IUU_med  <- full_output_IUU_med[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU_med  <- full_output_IUU_med[[3]] %>%  select_if(~all(!is.na(.)))
mit075_IUU_med  <- full_output_IUU_med[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU_med  <- full_output_IUU_med[[4]] %>%  select_if(~all(!is.na(.)))
mit085_IUU_med  <- full_output_IUU_med[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU_med  <- full_output_IUU_med[[5]] %>%  select_if(~all(!is.na(.)))
mit095_IUU_med  <- full_output_IUU_med[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU_med  <- full_output_IUU_med[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU_med <- rbind(mit05_IUU_med ,mit055_IUU_med ,mit06_IUU_med ,mit065_IUU_med ,mit07_IUU_med ,mit075_IUU_med ,
                        mit08_IUU_med ,mit085_IUU_med ,mit09_IUU_med ,mit095_IUU_med ,mit1_IUU_med )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU_med$mitsim <- paste(full_dat_w_IUU_med$mitigation_efficacy, full_dat_w_IUU_med$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU_med <- fulldat_IUU_med %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU_med)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```

*then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1 and replot*
```{r}

fulldat_IUU_med_filtered <- fulldat_IUU_med %>% 
  filter(!simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993", #lowfilter
                     "V12"  , "V40"  , "V44"  , "V49"  , "V94"  , "V107" , "V153" , "V198" , "V207" , "V245" , "V391" , "V445" , "V452" , "V490"  ,"V540" , "V611" , "V769",  "V820" ,
                     "V843" , "V853"  ,"V957" , "V973",  "V1151", "V1227" ,"V1312","V1397")) #highfilter
unique(fulldat_IUU_filtered$simrun)

ggplot(fulldat_IUU_filtered)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)

```
*this looks reasonable*
*now, calculate the probability of lambda being >=1 (aka prob of success) for each bycatch reduction percentile - do this across all mitigation efficacy rates, and broken up by efficacy rates*
```{r}
unique(fulldat_IUU_med_filtered$bycatch_reduction)

fulldat_IUU_med_prob1 <- fulldat_IUU_med_filtered %>% 
  group_by(bycatch_reduction) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_med_prob1mit <- fulldat_IUU_med_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_med_meanlambda <- fulldat_IUU_med_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(mean_lambda =mean(lambda))
```


```{r}
ggplot()+
  geom_line(data = fulldat_IUU_med_prob1mit, aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)), alpha = 0.5)+
  geom_line(data = fulldat_IUU_med_prob1, aes(bycatch_reduction, prob1))+
   labs(x="% legal fisheries with bycatch mitigation", y="Probability \u03BB \u2265 1 ", color = "% mitigation efficacy")+
    coord_cartesian(expand=FALSE)+
  #scale_color_viridis_d()+
  theme_bw()
```

*heatmap prob1*
```{r}
# Heatmap 
ggplot(fulldat_IUU_med_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
  scale_fill_viridis_c()

```

heatmap of mean lambda
```{r}
# Heatmap 
ggplot(fulldat_IUU_med_meanlambda, aes(bycatch_reduction, mitigation_efficacy, fill= mean_lambda)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Mean \u03BB")+
  scale_fill_viridis_c()
  #scale_fill_distiller(palette = "RdBu")
```

*low BYCATCH*
```{r}
full_output_IUU_low <- vector("list", 6)
bycatch_reductions2 <- seq(0, 1, by =0.01)
mitigation_eff_range2 <- seq(0.5,1, by  = 0.05)
sims = 1:1500



set.seed(123)

for(k in 1:length(mitigation_eff_range2)){
  mit_eff <- mitigation_eff_range2[k]
  
  output2_IUU <- matrix(nrow = length(bycatch_reductions2), ncol = length(sims)) %>% as.data.frame() 
  
for(j in 1:length(sims)){
    
  set.seed(j)
  
    s_c2 <-    rbeta(n = 1, shape1 = s_c2alpha, shape2 = s_c2beta) #chick+ fledgling survival year 0-1 - 0.64 
    s_cc2 <-  rbeta(n = 1, shape1 = s_cc2alpha, shape2 = s_cc2beta) # conditional chick+ fledgling survival year 0-1 - 0.64 
    s_j2 <- rbeta(n = 1, shape1 = s_j2alpha, shape2 = s_j2beta)#juvenile survival year 1-3 -  0.8 
    s_i2 <-  rbeta(n = 1, shape1 = s_i2alpha, shape2 = s_i2beta) #immature survival year 3-7 -  0.92
    s_s2 <- rbeta(n = 1, shape1 = s_s2alpha, shape2 = s_s2beta) #subadult survival year 7-10 - 0.94
    s_a2 <-  rbeta(n = 1, shape1 = s_a2alpha, shape2 = s_a2beta) #adult survival year 10+ - 0.94
    bs_a2 <-  rbeta(n = 1, shape1 = bs_a2alpha, shape2 = bs_a2beta) #adult breeding success - 0.8 
    bp_a2 <-  rbeta(n = 1, shape1 = bp_a2alpha, shape2 = bp_a2beta)  #adult breeding probablity (biennial breeding, most breeding by age 10) - 0.45
    c2 <- 0.5# # of female chicks per year
    f_a2 <- bp_a*c2*s_cc2 #fecundity

    
      # Check the condition and skip to the next iteration if it's true
  if (s_j2 > s_s2 || s_j2 > s_a2 || s_j2 > s_i2 || s_i2 > s_s2 || s_i2 > s_a2 || s_s2 > s_a2) {
    next
  }
    
    
    #fishing mortality = per capita calculation above
   # fm2 <- fm #set bycatch mortality
    fm2 <-  rbeta(n = 1, shape1 = fm2_alpha, shape2 = fm2_beta)  #variable bycatch mortality
    
    #natural mortality
    nm_j2 <- (1-s_j2)-fm2
    nm_i2 <- (1-s_i2)-fm2
    nm_s2 <- (1-s_s2)-fm2
    nm_a2 <- (1-s_a2)-fm2
    
    #need to calculate legal fishing, illegal fishing mortality, and non fishing mortality, and only module fishing mortality
    non_IUU<- 0.94
    IUU <- 0.06
  
    fm2_nonIUU <- fm2*non_IUU
    fm2_IUU <- fm2*IUU
    
    
    bycatch_reductions2b<- bycatch_reductions2*non_IUU
    
for(i in 1:length(bycatch_reductions2)){
  
  #calculate new survival rates = 1-(bycatch mortality*(1-efficacy of intervention action * proportion of legal fishery implementing intervention actions * prop of legal fishery to total fishery))+mortality remainder)

  n_s_j2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_j2)+fm2_IUU)
  n_s_i2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_i2)+fm2_IUU)
  n_s_s2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  n_s_a2 <- 1-((fm2_nonIUU*(1-(mit_eff*bycatch_reductions2b[i])))+(nm_s2)+fm2_IUU)
  

   #Age classes (years)    0-1      1-2      2-3     3-4     4-5     5-6     6-7    7-8     8-9      nw,                w1,                  w2,                   w3,                   w4
  n_m2_IUU <- matrix(data = c( 0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2^2*f_a2,     n_s_a2^2*f_a2*w,     n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w,      n_s_a2^2*f_a2*w4,      #0-1
                           n_s_j2,  0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #1-2
                           0,       n_s_j2,  0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #2-3
                           0,       0,       n_s_j2, 0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #3-4
                           0,       0,       0,      n_s_i2, 0,      0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #4-5
                           0,       0,       0,      0,      n_s_i2, 0,      0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #5-6
                           0,       0,       0,      0,      0,      n_s_i2, 0,      0,      0,      0,                 0,                   0,                    0,                    0,                     #6-7
                           0,       0,       0,      0,      0,      0,      n_s_i2, 0,      0,      0,                 0,                   0,                    0,                    0,                     #7-8
                           0,       0,       0,      0,      0,      0,      0,      n_s_s2, 0,      0,                 0,                   0,                    0,                    0,                     #8-9
                           0,       0,       0,      0,      0,      0,      0,      0,      n_s_s2, n_s_a2^2,          n_s_a2^2*w,          n_s_a2^2*w,           n_s_a2^2*w,           n_s_a2^2*w4,           #nw
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      n_s_a2*(1-n_s_a2), n_s_a2*(1-n_s_a2)*w, n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w,  n_s_a2*(1-n_s_a2)*w4,  #w1
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 n_s_a2*(1-w),        0,                    0,                    0,                     #w2
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   n_s_a2*(1-w),         0,                    0,                     #w3
                           0,       0,       0,      0,      0,      0,      0,      0,      0,      0,                 0,                   0,                    n_s_a2*(1-w),         0),                    #w4
                   nrow = 14, byrow = TRUE)
n_m2_IUU
  
   
  
  #extract eigenvalues and lambda from the matrix 
  n_m2_IUU_eig2 <- eigen(n_m2_IUU)
  lambda_n2_IUU <- as.numeric(n_m2_IUU_eig2$values[1])
  output2_IUU[i,j] <- lambda_n2_IUU # this matches the ideal population growth rate in the table
   output2_IUU <- as.data.frame(output2_IUU)
   output2_IUU$mitigation_efficacy <- mit_eff
  output2_IUU$bycatch_reduction <- bycatch_reductions2
   full_output_IUU_low[[k]] <- output2_IUU


    }

}
}

full_output_IUU_low[[1]]
 # sim_results_IUU<- full_output_IUU[[1]]
 # sim_results_IUU$quantile5 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.05)), na.rm=TRUE)
 # sim_results_IUU$quantile95 <-  apply(sim_results_IUU[1:100], 1, quantile, (probs =c(0.95)), na.rm=TRUE)
 
 
```


*format output*
```{r}
mitigation_eff_range2 #0.50 0.55 0.60 0.65 0.70 0.75 0.80 0.85 0.90 0.95 1.00

mit05_l_IUU_low <- full_output_IUU_low[[1]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit055_l_IUU_low <- full_output_IUU_low[[2]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit06_l_IUU_low  <- full_output_IUU_low[[3]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit065_l_IUU_low  <- full_output_IUU_low[[4]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit07_l_IUU_low  <- full_output_IUU_low[[5]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit075_l_IUU_low  <- full_output_IUU_low[[6]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit08_l_IUU_low  <- full_output_IUU_low[[7]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit085_l_IUU_low  <- full_output_IUU_low[[8]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit09_l_IUU_low  <- full_output_IUU_low[[9]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit095_l_IUU_low  <- full_output_IUU_low[[10]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

mit1_l_IUU_low  <- full_output_IUU_low[[11]] %>% 
  select_if(~all(!is.na(.))) %>% 
  pivot_longer(cols = starts_with("V"), names_to = "simrun", values_to = "lambda")

fulldat_IUU_low  <- rbind(mit05_l_IUU_low,mit055_l_IUU_low,mit06_l_IUU_low,mit065_l_IUU_low,mit07_l_IUU_low,mit075_l_IUU_low,
                      mit08_l_IUU_low,mit085_l_IUU_low,mit09_l_IUU_low,mit095_l_IUU_low,mit1_l_IUU_low)
fulldat_IUU_low$mitsim <- paste(fulldat_IUU_low$mitigation_efficacy, fulldat_IUU_low$simrun)

mit05_IUU_low  <- full_output_IUU_low[[1]] %>%  select_if(~all(!is.na(.)))
mit055_IUU_low  <- full_output_IUU_low[[1]] %>%  select_if(~all(!is.na(.)))
mit06_IUU_low <- full_output_IUU_low[[2]] %>%  select_if(~all(!is.na(.)))
mit065_IUU_low  <- full_output_IUU_low[[2]] %>%  select_if(~all(!is.na(.)))
mit07_IUU_low  <- full_output_IUU_low[[3]] %>%  select_if(~all(!is.na(.)))
mit075_IUU_low  <- full_output_IUU_low[[3]] %>%  select_if(~all(!is.na(.)))
mit08_IUU_low  <- full_output_IUU_low[[4]] %>%  select_if(~all(!is.na(.)))
mit085_IUU_low  <- full_output_IUU_low[[4]] %>%  select_if(~all(!is.na(.)))
mit09_IUU_low  <- full_output_IUU_low[[5]] %>%  select_if(~all(!is.na(.)))
mit095_IUU_low  <- full_output_IUU_low[[5]] %>%  select_if(~all(!is.na(.)))
mit1_IUU_low  <- full_output_IUU_low[[6]] %>%  select_if(~all(!is.na(.)))

full_dat_w_IUU_low <- rbind(mit05_IUU_low ,mit055_IUU_low ,mit06_IUU_low ,mit065_IUU_low ,mit07_IUU_low ,mit075_IUU_low ,
                        mit08_IUU_low ,mit085_IUU_low ,mit09_IUU_low ,mit095_IUU_low ,mit1_IUU_low )
# full_dat_w_IUU$quantile5 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.05)))
# full_dat_w_IUU$quantile95 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.95)))
# full_dat_w_IUU$quantile25 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.25)))
# full_dat_w_IUU$quantile75 <-  apply(full_dat_w_IUU[1:100], 1, quantile, (probs =c(0.75)))
full_dat_w_IUU_low$mitsim <- paste(full_dat_w_IUU_low$mitigation_efficacy, full_dat_w_IUU_low$simrun)

```

*plot VR uncertainty plots*
```{r}
output_l$mitigation_efficacy <- output_l$mit_eff
fulldat_IUU_low <- fulldat_IUU_low %>% group_by(mitigation_efficacy, bycatch_reduction) %>% mutate(mean_lambda = mean(lambda)) %>% ungroup()

ggplot(fulldat_IUU_low)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)
```

*then filter for 0 reductions lambda >=1 AND natural mortality lambda < 1 and replot*
```{r}

fulldat_IUU_low_filtered <- fulldat_IUU_low %>% 
  filter(!simrun%in%c("V4"  , "V13" , "V30" , "V31" , "V59" , "V74" , "V89"  ,"V165" ,"V170", "V186" ,"V281", "V304" ,"V326" ,"V377" ,"V383" ,"V412" ,"V453" ,"V458", "V495" ,"V521",
                      "V555" ,"V570", "V573" ,"V576" ,"V577" ,"V635" ,"V658" ,"V679", "V683", "V687", "V709", "V737" ,"V777", "V787", "V819" ,"V822" ,"V823" ,"V835" ,"V846" ,"V854",
                      "V866" ,"V956" ,"V974" ,"V976", "V987", "V993", #lowfilter
                     "V12"  , "V40"  , "V44"  , "V49"  , "V94"  , "V107" , "V153" , "V198" , "V207" , "V245" , "V391" , "V445" , "V452" , "V490"  ,"V540" , "V611" , "V769",  "V820" ,
                     "V843" , "V853"  ,"V957" , "V973",  "V1151", "V1227" ,"V1312","V1397")) #highfilter
unique(fulldat_IUU_low_filtered$simrun)

ggplot(fulldat_IUU_low_filtered)+
  geom_line(aes(x=bycatch_reduction, y=lambda, group = simrun), color = "grey", alpha = 0.1)+
 # geom_line(data = output_l, aes(x=bycatch_reductions, y=lambda))+ #"best" VR
  geom_hline(aes(yintercept = 1), color = "red", alpha =0.5)+ 
  geom_line(aes(x=bycatch_reduction, y=mean_lambda, group = simrun), color = "blue")+ #mean VR
  labs(x="% fisheries with bycatch mitigation", y="lambda")+
  facet_wrap(~mitigation_efficacy, nrow = 1)+
  themeo+
  coord_cartesian(expand=FALSE)

```
*this looks reasonable*
*now, calculate the probability of lambda being >=1 (aka prob of success) for each bycatch reduction percentile - do this across all mitigation efficacy rates, and broken up by efficacy rates*
```{r}
unique(fulldat_IUU_low_filtered$bycatch_reduction)

fulldat_IUU_low_prob1 <- fulldat_IUU_low_filtered %>% 
  group_by(bycatch_reduction) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_low_prob1mit <- fulldat_IUU_low_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(prob1 =sum(lambda>=1)/length(lambda))

fulldat_IUU_low_meanlambda <- fulldat_IUU_low_filtered %>% 
  group_by(bycatch_reduction, mitigation_efficacy) %>% 
  summarise(mean_lambda =mean(lambda))
```


```{r}
ggplot()+
  geom_line(data = fulldat_IUU_low_prob1mit, aes(bycatch_reduction, prob1, color = factor(mitigation_efficacy)), alpha = 0.5)+
  geom_line(data = fulldat_IUU_low_prob1, aes(bycatch_reduction, prob1))+
   labs(x="% legal fisheries with bycatch mitigation", y="Probability \u03BB \u2265 1 ", color = "% mitigation efficacy")+
    coord_cartesian(expand=FALSE)+
  #scale_color_viridis_d()+
  theme_bw()
```

*heatmap prob1*
```{r}

# Heatmap 
ggplot(fulldat_IUU_low_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
  scale_fill_viridis_c()

```

heatmap of mean lambda
```{r}
# Heatmap 
ggplot(fulldat_IUU_low_meanlambda, aes(bycatch_reduction, mitigation_efficacy, fill= mean_lambda)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Mean \u03BB")+
  scale_fill_viridis_c()
  #scale_fill_distiller(palette = "RdBu")
```

*find range of prob1 and mean_lambda across IUU tests, set color ramp for that range, then replot all along the same color ramp*
```{r}
range(fulldat_IUU_none_meanlambda$mean_lambda) #0.9944091 1.0035894
range(fulldat_IUU_low_meanlambda$mean_lambda) #0.9944091 1.0025200
range(fulldat_IUU_med_meanlambda$mean_lambda) #0.9944091 1.0002828
range(fulldat_IUU_high_meanlambda$mean_lambda) #0.9944091 0.9984062
range(fulldat_IUU_meanlambda$mean_lambda) #0.9944091 1.0025200

#0.9944091 - 1.0035894

range(fulldat_IUU_none_meanlambda$mean_lambda^20) #0.8939271 1.0742888
range(fulldat_IUU_low_meanlambda$mean_lambda^20) #0.8939271 1.0516255
range(fulldat_IUU_med_meanlambda$mean_lambda^20) #0.8939271 1.0056705
range(fulldat_IUU_high_meanlambda$mean_lambda^20) #0.8939271 0.9686023
range(fulldat_IUU_meanlambda$mean_lambda^20) #0.8939271 1.0516255

#0.8939271 - 1.0742888

# range(fulldat_IUU_none_prob1$prob1) #0.001526718 0.675641915
# range(fulldat_IUU_low_prob1$prob1) #0.001526718 0.569049271
# range(fulldat_IUU_med_prob1$prob1) #0.001526718 0.327272727
# range(fulldat_IUU_high_prob1$prob1) #0.001526718 0.146703678
# range(fulldat_IUU_prob1$prob1) #0.001526718 0.569049271

#0.001526718 - 0.675641915

range(fulldat_IUU_none_prob1mit$prob1) #0.001526718 0.957251908
range(fulldat_IUU_low_prob1mit$prob1) #0.001526718 0.861068702
range(fulldat_IUU_med_prob1mit$prob1) #0.001526718 0.537404580
range(fulldat_IUU_high_prob1mit$prob1) #0.001526718 0.267175573
range(fulldat_IUU_prob1mit$prob1) #0.001526718 0.861068702

#0.001526718 - 0.957251908
```

*remake figures (test zero and high first)*
```{r}
#grad <- c("#b2182b", "#ef8a62", "#fddbc7", "#f7f7f7","#d1e5f0","#67a9cf", "#2166ac")
#grad <- c("#b2182b", "#ef8a62", "#fddbc7","#d1e5f0","#67a9cf", "#2166ac")
grad <- c("#d73027", "#fc8d59", "#fee090", "#ffffbf","#e0f3f8","#91bfdb", "#4575b4")
#grad <- c("#d73027", "#fc8d59", "#fee090", "#ffffbf","#91bfdb", "#4575b4")
#grad_lims <- c(0 ,0.957251908)
grad_lims <- c(0 ,1)


ggplot(fulldat_IUU_none_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
 #scale_fill_viridis_c()
 scale_fill_gradientn(colors  = grad, limits = grad_lims)
```

```{r}

ggplot(fulldat_IUU_high_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
 # scale_fill_viridis_c()
 scale_fill_gradientn(colors = grad, limits = grad_lims)

```

```{r}

ggplot(fulldat_IUU_med_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
 # scale_fill_viridis_c()
 scale_fill_gradientn(colors = grad, limits = grad_lims)

```


```{r}

ggplot(fulldat_IUU_low_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
 # scale_fill_viridis_c()
 scale_fill_gradientn(colors = grad, limits = grad_lims)

```

I think this one might be wrong - this may have been overwritten by the low IUU somehow
```{r}

ggplot(fulldat_IUU_prob1mit, aes(bycatch_reduction, mitigation_efficacy, fill= prob1)) + 
  geom_tile()+
  theme_bw()+
  coord_cartesian(expand=FALSE)+
  labs(x="% legal fisheries with bycatch mitigation", y="% mitigation efficacy", fill = "Probability \u03BB \u2265 1")+
 # scale_fill_viridis_c()
 scale_fill_gradientn(colors = grad, limits = grad_lims)

```


