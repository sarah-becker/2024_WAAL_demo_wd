---
title: "Diagnostic Figures — Effort, Catchability, and Survival by Period"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 6)
```

```{r libraries}
library(tidyverse)
library(here)
library(patchwork)
library(scales)
```

# Overview

This script produces diagnostic figures comparing key inputs and outcomes across the four
time periods used in the bycatch model (06a–06d):

- **Fishing effort** (mean annual hooks by fishery type)
- **Effective catchability** (mean annual BI bycatch per hook — a realized BPUE)
- **Survival rates** (s_Juv and s_Adult as set in each period script)
- **Per-capita fishing mortality** (total FM across fisheries, by age class)

The goal is to verify that all three drivers of change (effort, catchability, and
demographic conditions) are coherent across periods, and to show where changes in
survival are attributable to fishing vs. other processes.

---

# Load Data

```{r load-data}
# Most recent 03f output date
date_sfx_03f <- "2026-02-25"

# Hooks by fleet and period (03g, 2026-02-24 — the file with hooks output)
hooks_raw <- read_csv(here("output/hooks_by_fleet_period_03g_2026-02-24.csv"),
                      show_col_types = FALSE)

# Bycatch by fishery and period (03f — mean annual BI bycatch, all ages summed)
byc_period <- read_csv(here(paste0("output/bycatch_by_fishery_period_03f_", date_sfx_03f, ".csv")),
                       show_col_types = FALSE)

# Per-capita fishing mortality by period and age class (03f)
percap <- read_csv(here(paste0("output/percap_rates_by_period_03f_", date_sfx_03f, ".csv")),
                   show_col_types = FALSE)
```

---

# Prepare Data

```{r period-labels}
# Period labels used in 06a-06d (bycatch model periods)
model_periods <- c("1990-1994", "1995-1999", "2000-2004", "2005-2009")

# The hooks file (03g) uses slightly different period endpoints
# ("1990-1995" vs "1990-1994") due to raw data year groupings — mapping them here
hooks_period_map <- c(
  "1990-1995" = "1990-1994",
  "1996-2000" = "1995-1999",
  "2001-2005" = "2000-2004",
  "2006-2010" = "2005-2009"
)
```

```{r effort-data}
# Total hooks by fishery type and period (summed across fleets, excluding NAs)
# The hooks_raw total_hooks column is the 5-year total; divide by 5 for mean annual
hooks_by_period <- hooks_raw %>%
  filter(!is.na(total_hooks)) %>%
  mutate(period = recode(year_group, !!!hooks_period_map)) %>%
  filter(period %in% model_periods) %>%
  group_by(period, fishery) %>%
  summarise(mean_annual_hooks = sum(total_hooks, na.rm = TRUE) / 5,
            .groups = "drop") %>%
  mutate(
    period   = factor(period, levels = model_periods),
    fishery  = factor(fishery, levels = c("PLL", "DLL"))
  )
```

```{r catchability-data}
# Effective catchability (BPUE): mean annual BI bycatch / mean annual hooks
# bi_total in bycatch file is already mean annual
catchability_by_period <- byc_period %>%
  left_join(hooks_by_period, by = c("year_group" = "period", "fishery")) %>%
  mutate(
    period  = factor(year_group, levels = model_periods),
    fishery = factor(fishery, levels = c("PLL", "DLL")),
    # bycatch per 1000 hooks (× 1000 for readability)
    bpue_per1000 = (bi_total / mean_annual_hooks) * 1000
  )
```

```{r survival-data}
# Survival rates as set in 06a-06d VR sections (read from figure, period-specific)
surv_rates <- tibble(
  period  = factor(model_periods, levels = model_periods),
  s_Juv   = c(0.78, 0.725, 0.78,  0.78),
  s_Adult = c(0.96, 0.940, 0.92,  0.92)
) %>%
  pivot_longer(cols = c(s_Juv, s_Adult),
               names_to  = "stage",
               values_to = "survival") %>%
  mutate(stage = recode(stage,
                        "s_Juv"   = "Juvenile",
                        "s_Adult" = "Adult (pooled)"))
```

```{r percap-data}
# Per-capita total FM by period and age class (PLL + DLL combined)
percap_clean <- percap %>%
  mutate(
    period    = factor(year_group, levels = model_periods),
    age_class = factor(age_class, levels = c("j2j3", "imm", "fb", "sb", "nb"),
                       labels = c("Juvenile", "Immature", "Breeding (F)", "Breeding (S)", "Non-breeding"))
  )
```

---

# Shared Plot Theme

```{r theme}
period_colors <- c("1990-1994" = "#D55E00",
                   "1995-1999" = "#E69F00",
                   "2000-2004" = "#009E73",
                   "2005-2009" = "#0072B2")

fishery_colors <- c("PLL" = "#CC79A7", "DLL" = "#56B4E9")

diag_theme <- theme_classic(base_size = 12) +
  theme(
    strip.background = element_blank(),
    strip.text       = element_text(face = "bold"),
    legend.position  = "bottom",
    axis.text.x      = element_text(angle = 30, hjust = 1),
    plot.title       = element_text(face = "bold", size = 11),
    legend.box       = "horizontal"
  )
```

---

# Three Dual Y-Axis Diagnostic Figures

## Plot 1 — PLL: Effort (left) + Catchability (right)

```{r p1-pll, fig.width=6, fig.height=5}
pll_data <- hooks_by_period %>%
  filter(fishery == "PLL") %>%
  left_join(
    catchability_by_period %>% filter(fishery == "PLL") %>% select(period, bpue_per1000),
    by = "period"
  )

# Scale factor maps bpue_per1000 onto the hooks_M axis for dual-axis rendering
scale_pll <- max(pll_data$mean_annual_hooks / 1e6, na.rm = TRUE) /
             max(pll_data$bpue_per1000, na.rm = TRUE)

p1 <- ggplot(pll_data, aes(x = period)) +
  geom_col(aes(y = mean_annual_hooks / 1e6), fill = "#CC79A7", alpha = 0.7, width = 0.6) +
  geom_line(aes(y = bpue_per1000 * scale_pll, group = 1),
            color = "#882255", linewidth = 1.3) +
  geom_point(aes(y = bpue_per1000 * scale_pll),
             color = "#882255", size = 3) +
  scale_y_continuous(
    name     = "Mean annual hooks (millions)",
    labels   = label_number(suffix = "M"),
    sec.axis = sec_axis(
      ~ . / scale_pll,
      name   = "BI bycatch per 1,000 hooks",
      labels = label_number(accuracy = 0.0001)
    )
  ) +
  labs(title = "Pelagic longline (PLL): effort and catchability", x = NULL) +
  diag_theme +
  theme(
    axis.title.y.left  = element_text(color = "#CC79A7"),
    axis.text.y.left   = element_text(color = "#CC79A7"),
    axis.title.y.right = element_text(color = "#882255"),
    axis.text.y.right  = element_text(color = "#882255")
  )

p1
```

## Plot 2 — DLL: Effort (left) + Catchability (right)

```{r p2-dll, fig.width=6, fig.height=5}
dll_data <- hooks_by_period %>%
  filter(fishery == "DLL") %>%
  left_join(
    catchability_by_period %>% filter(fishery == "DLL") %>% select(period, bpue_per1000),
    by = "period"
  )

scale_dll <- max(dll_data$mean_annual_hooks / 1e6, na.rm = TRUE) /
             max(dll_data$bpue_per1000, na.rm = TRUE)

p2 <- ggplot(dll_data, aes(x = period)) +
  geom_col(aes(y = mean_annual_hooks / 1e6), fill = "#56B4E9", alpha = 0.7, width = 0.6) +
  geom_line(aes(y = bpue_per1000 * scale_dll, group = 1),
            color = "#0072B2", linewidth = 1.3) +
  geom_point(aes(y = bpue_per1000 * scale_dll),
             color = "#0072B2", size = 3) +
  scale_y_continuous(
    name     = "Mean annual hooks (millions)",
    labels   = label_number(suffix = "M"),
    sec.axis = sec_axis(
      ~ . / scale_dll,
      name   = "BI bycatch per 1,000 hooks",
      labels = label_number(accuracy = 0.0001)
    )
  ) +
  labs(title = "Demersal longline (DLL): effort and catchability", x = NULL) +
  diag_theme +
  theme(
    axis.title.y.left  = element_text(color = "#56B4E9"),
    axis.text.y.left   = element_text(color = "#56B4E9"),
    axis.title.y.right = element_text(color = "#0072B2"),
    axis.text.y.right  = element_text(color = "#0072B2")
  )

p2
```

## Plot 3 — Survival (left) + Mean Per-Capita FM (right)

```{r p3-surv-fm, fig.width=6, fig.height=5}
# Mean per-capita FM across all age classes per period
mean_percap <- percap_clean %>%
  group_by(period) %>%
  summarise(mean_fm = mean(total_percap), .groups = "drop")

# Define the y-range for each axis
surv_lo <- 0.65; surv_hi <- 1.00
fm_lo   <- 0;    fm_hi   <- max(mean_percap$mean_fm, na.rm = TRUE) * 1.25

# Transformation functions to map FM onto the survival axis scale
fm_to_surv <- function(x) surv_lo + (x - fm_lo) / (fm_hi - fm_lo) * (surv_hi - surv_lo)
surv_to_fm <- function(x) fm_lo  + (x - surv_lo) / (surv_hi - surv_lo) * (fm_hi - fm_lo)

p3 <- ggplot() +
  # Survival lines (left axis)
  geom_line(data = surv_rates,
            aes(x = period, y = survival, color = stage, group = stage),
            linewidth = 1.3) +
  geom_point(data = surv_rates,
             aes(x = period, y = survival, color = stage),
             size = 3) +
  # Per-capita FM line (right axis, transformed to survival scale for plotting)
  geom_line(data = mean_percap,
            aes(x = period, y = fm_to_surv(mean_fm), group = 1),
            color = "grey30", linewidth = 1.3, linetype = "dashed") +
  geom_point(data = mean_percap,
             aes(x = period, y = fm_to_surv(mean_fm)),
             color = "grey30", size = 3, shape = 17) +
  scale_color_manual(
    values = c("Juvenile" = "#E69F00", "Adult (pooled)" = "#0072B2"),
    name   = "Survival"
  ) +
  scale_y_continuous(
    name     = "Annual survival probability",
    limits   = c(surv_lo, surv_hi),
    labels   = label_number(accuracy = 0.01),
    sec.axis = sec_axis(
      surv_to_fm,
      name   = "Mean per-capita FM (all ages, PLL + DLL)",
      labels = label_number(accuracy = 0.001)
    )
  ) +
  labs(title = "Survival and mean per-capita fishing mortality", x = NULL) +
  diag_theme +
  theme(
    axis.title.y.left  = element_text(color = "#0072B2"),
    axis.text.y.left   = element_text(color = "#0072B2"),
    axis.title.y.right = element_text(color = "grey30"),
    axis.text.y.right  = element_text(color = "grey30")
  )

p3
```

## Combined Figure

```{r combined-figure, fig.width=16, fig.height=6}
dir.create(here("output/figures"), showWarnings = FALSE, recursive = TRUE)

combined <- p1 + p2 + p3 +
  plot_annotation(
    title    = "Fishing Effort, Catchability, and Survival — Trends Across Periods",
    subtitle = "Bars = mean annual hooks; lines = bycatch per 1,000 hooks (plots 1-2) or survival/FM (plot 3)",
    theme    = theme(
      plot.title    = element_text(face = "bold", size = 13),
      plot.subtitle = element_text(size = 10, color = "grey40")
    )
  )

combined

ggsave(here("output/figures/07_diagnostic_effort_catchability_survival.png"),
       combined, width = 16, height = 6, dpi = 300)
```

---

# Interpretation Notes

```{r interpretation}
# Summary table: how much did each component change from 1990-1994 to 2005-2009?

# Effort change
effort_summary <- hooks_by_period %>%
  group_by(fishery) %>%
  summarise(
    hooks_1990 = mean_annual_hooks[period == "1990-1994"],
    hooks_2005 = mean_annual_hooks[period == "2005-2009"],
    pct_change = 100 * (hooks_2005 - hooks_1990) / hooks_1990
  )

cat("=== Effort change (1990-1994 to 2005-2009) ===\n")
print(effort_summary)

# Catchability change
bpue_summary <- catchability_by_period %>%
  group_by(fishery) %>%
  summarise(
    bpue_1990 = bpue_per1000[period == "1990-1994"],
    bpue_2005 = bpue_per1000[period == "2005-2009"],
    pct_change = 100 * (bpue_2005 - bpue_1990) / bpue_1990
  )

cat("\n=== BPUE change (1990-1994 to 2005-2009) ===\n")
print(bpue_summary)

# Survival change
cat("\n=== Survival change (1990-1994 to 2005-2009) ===\n")
surv_rates %>%
  pivot_wider(names_from = period, values_from = survival) %>%
  mutate(abs_change = `2005-2009` - `1990-1994`) %>%
  print()

# Per-capita FM change (averaged across age classes)
percap_summary <- percap_clean %>%
  group_by(period) %>%
  summarise(mean_total_percap = mean(total_percap)) %>%
  mutate(
    pct_change_from_1990 = 100 * (mean_total_percap -
      mean_total_percap[period == "1990-1994"]) /
      mean_total_percap[period == "1990-1994"]
  )

cat("\n=== Mean per-capita FM (averaged across age classes) ===\n")
print(percap_summary)
```

```{r session-info}
sessionInfo()
```
