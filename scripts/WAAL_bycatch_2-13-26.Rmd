---
title: "WAAL bycatch 5-27-25"
output: html_document
---

```{r, echo= FALSE, include =FALSE}
library(here)
library(tidyverse)
library(RColorBrewer)

#set up various plotting themes
themeo <-theme_classic()+
  theme(strip.background = element_blank(),
        panel.grid.major = element_line(colour = "transparent"), 
        panel.grid.minor = element_line(colour = "transparent"),
        axis.line = element_blank(),
        axis.title = element_text(color = "black", size = 10),
        axis.ticks.length=unit(-0.1, "cm"),
        axis.ticks = element_line(color = "black", size = .25),
        axis.ticks.x = element_line(color = "black"),
        axis.ticks.y = element_line(color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=.5),
        panel.spacing = unit(1, "lines"),
        legend.position = "bottom",
        legend.title = element_text(colour = "black", size = 10, face = "bold"),
        legend.text = element_text(color = "black", size =8)) #default legend position
```


*SET UP DEMO MATRIX, VRs, CALCULATE MEAN POP GROWTH RATE, SSD, etc*

**set vital rates**
```{r}
#breeding prob
b_EF	<- 0.746 #experienced failed
b_ENB	<- 0.589 #experienced non breeding
b_ES  <- 0.016 #experienced successful
b_IF  <- 0.744 #inexperienced failed
b_Imm	<- 0.101 #immature
b_IS  <- 0.011 #inexperienced successful
b_PF	<- 0.941 #sabbatical 

#success prob
k_EF	<- 0.631 #experienced failed
k_ENB	<- 0.675 #experienced non breeding
k_ES	<- 0.500 #experienced successful
k_IF	<- 0.627 #inexperienced failed
k_Imm	<- 0.585 #immature
k_IS	<- 0.627 #inexperienced successful
k_PF	<- 0.791 #sabbatical 

#return prob
r_EF	<- 0.973 #experienced failed
r_ENB	<- 0.953 #experienced non breeding
r_ES	<- 0.292 #experienced successful
r_IF	<- 0.948 #inexperienced failed
r_Imm	<- 0.692 #immature
r_IS	<- 0.459 #inexperienced successful
r_PF	<- 0.972 #sabbatical 

#survival
s_EF	<- 0.913 #experienced failed
s_ENB	<- 0.943 #experienced non breeding
s_ES	<- 0.895 #experienced successful
s_IF	<- 0.920 #inexperienced failed
s_Imm	<- 0.921 #immature
s_IS	<- 0.892 #inexperienced successful
s_Juv	<- 0.846 #juvenile
s_PF	<- 0.935 #sabbatical        


#mean VRs
mean_a_s <- (s_EF + s_ENB+ s_ES + s_IF + s_IS + s_PF)/6
mean_a_r <- (r_EF + r_ENB+ r_ES + r_IF + r_IS + r_PF)/6
mean_a_k <- (k_EF + k_ENB+ k_ES + k_IF + k_IS + k_PF)/6
mean_a_b <- (b_EF + b_ENB+ b_ES + b_IF + b_IS + b_PF)/6

#mean VRs
mean_s <- (s_EF + s_ENB+ s_ES + s_IF + s_IS + s_PF )/6
mean_r <- (r_EF + r_ENB+ r_ES + r_IF + r_IS + r_PF + r_Imm)/7
mean_k <- (k_EF + k_ENB+ k_ES + k_IF + k_IS + k_PF + k_Imm)/7
mean_b <- (b_EF + b_ENB+ b_ES + b_IF + b_IS + b_PF + b_Imm)/7
``` 

**create matrix**
```{r}
#Stages          #J2	 J3    Imm4  Imm5  PB	                                   IS                      IF    	                 ES	                     EF    	                 ENB	                       Sabb
m<-matrix(data=c(0,    0,	   0,	   0,	   0,	                                   0.5*s_Juv,              0,	                     0.5*s_Juv,	             0,	                     0,	                         0,                      #J2
                 s_Juv,0,	   0,	   0,	   0,                                 	 0,	                     0,	                     0,	                     0,	                     0,	                         0,                      #J3
	               0,	   s_Juv,0,	   0,	   0,	                                   0,	                     0,	                     0,	                     0,	                     0,	                         0,                      #Imm4
	               0,	   0,	   s_Imm,0,	   0,	                                   0,	                     0,	                     0,	                     0,	                     0,                          0,                      #Imm5
                 0,    0,	   0,	   s_Imm,s_Imm*r_Imm*(1-b_Imm)+s_Imm*(1-r_Imm),0,	                     0,	                     0,                      0,	                     0,	                         0,                      #PB
	               0,	   0,	   0,	   0,	   s_Imm*r_Imm*b_Imm*k_Imm,	             0,	                     0,	                     0,	                     0,	                     0,	                         0,                      #IS
	               0,    0,	   0,	   0,	   s_Imm*r_Imm*b_Imm*(1-k_Imm),	         0,	                     0,	                     0,	                     0,	                     0,	                         0,                      #IF
	               0,	   0,	   0,	   0,	   0,	                                   s_IS*r_IS*b_IS*k_IS,    s_IF*r_IF*b_IF*k_IF,	   s_ES*r_ES*b_ES*k_ES,	   s_EF*r_EF*b_EF*k_EF,	   s_ENB*r_ENB*b_ENB*k_ENB,	   s_PF*r_PF*b_PF*k_PF,    #ES
                 0,	   0,	   0,	   0,	   0,	                                   s_IS*r_IS*b_IS*(1-k_IS),s_IF*r_IF*b_IF*(1-k_IF),s_ES*r_ES*b_ES*(1-k_ES),s_EF*r_EF*b_EF*(1-k_EF),s_ENB*r_ENB*b_ENB*(1-k_ENB),s_PF*r_PF*b_PF*(1-k_PF),#EF
	               0,	   0,	   0,	   0,	   0,	                                   s_IS*r_IS*(1-b_IS),	   s_IF*r_IF*(1-b_IF),	   s_ES*r_ES*(1-b_ES),	   s_EF*r_EF*(1-b_EF),	   s_ENB*r_ENB*(1-b_ENB),	     s_PF*r_PF*(1-b_PF),     #ENB
	               0,    0,	   0,	   0,	   0,	                                   s_IS*(1-r_IS),	         s_IF*(1-r_IF),	         s_ES*(1-r_ES),	         s_EF*(1-r_EF),	         s_ENB*(1-r_ENB),	           s_PF*(1-r_PF) ),        #Sabb
	               nrow = 11, byrow = TRUE)
m
```

**extract lambda, SSDs, and RVs from eigenvalues**
```{r}
#deterministic growth rate (lambda)
#extract eigenvalues and lambda from the matrix 
m_eig <- eigen(m)
lambda <- as.numeric(m_eig$values[1])
lambda # 0.9749412 - this looks reasonable compared to Pardo's figure. Just a guess-timate since she doesn't report a mean lambda across all years

#Stable state distribution
#extract and scale the right eigenvector 
SSD <- round(as.numeric(m_eig$vectors[,1]/sum(m_eig$vectors[,1])),3)
SSD

#extract reproductive values
RV <- as.numeric(eigen(t(m))$vectors[,1]/eigen(t(m))$vectors[1,1])
RV
```

**Compare SSD to observed demographic proportions from Clay et al.**
```{r}
# Matrix stage names (matching column order)
stage_names <- c("J2", "J3", "Imm4", "Imm5", "PB", "IS", "IF", "ES", "EF", "ENB", "Sabb")
names(SSD) <- stage_names

# Map matrix stages to Clay demographic classes
# FB = failed breeders (IF + EF)
# SB = successful breeders (IS + ES)
# NB = non-breeders (ENB + Sabb)
# J2J3 = juveniles (J2 + J3)
# IMM = immatures (Imm4 + Imm5 + PB)
ssd_grouped <- tibble(
  Dem_class = c("J2J3", "IMM", "FB", "SB", "NB"),
  ssd_prop = c(
    SSD["J2"] + SSD["J3"],
    SSD["Imm4"] + SSD["Imm5"] + SSD["PB"],
    SSD["IF"] + SSD["EF"],
    SSD["IS"] + SSD["ES"],
    SSD["ENB"] + SSD["Sabb"]
  )
)

# Load observed proportions from Clay (excluding J1 and summary row)
dem_props_obs <- read_csv(here("data/WAAL_dist_Clay2019/Dem_props copy.csv"),
                          show_col_types = FALSE) %>%
  mutate(Dem_class = str_replace(Dem_class, "J2\\+3", "J2J3")) %>%
  filter(Dem_class != "J1", Period != "1990-2009")

# Mean observed proportion across periods
obs_mean <- dem_props_obs %>%
  group_by(Dem_class) %>%
  summarise(obs_prop = mean(Prop), .groups = "drop")

# Renormalize observed proportions to sum to 1 (since J1 is excluded)
obs_mean <- obs_mean %>%
  mutate(obs_prop_norm = obs_prop / sum(obs_prop))

# Compare SSD vs observed
comparison <- ssd_grouped %>%
  left_join(obs_mean, by = "Dem_class") %>%
  mutate(
    ssd_norm = ssd_prop / sum(ssd_prop),
    difference = ssd_norm - obs_prop_norm,
    ratio = round(ssd_norm / obs_prop_norm, 3)
  )

comparison %>%
  mutate(across(where(is.numeric), ~round(.x, 4))) %>%
  print()

# Also show how proportions changed over time (population not at SSD)
dem_props_obs %>%
  select(Period, Dem_class, Prop) %>%
  pivot_wider(names_from = Period, values_from = Prop) %>%
  left_join(ssd_grouped %>% select(Dem_class, ssd_prop), by = "Dem_class") %>%
  mutate(across(where(is.numeric), ~round(.x, 4))) %>%
  print()
```
*LOAD BYCATCH MORTALITY FROM SCRIPT 03f*

Fishing effort, bird distributions, spatial overlap, and BPUE estimation are all handled in script 03f (spatial catchability approach). Here we load the mean annual per-capita bycatch rates and use them in the demographic model.

**load per-capita bycatch rates from 03f (1990-1995 period)**
```{r}
# Load period-specific bycatch totals from 03f
byc_period <- read_csv(here("output/bycatch_by_fishery_period_03f.csv"), show_col_types = FALSE)

# Load period-specific population sizes from Clay demographic data
dem_props <- read_csv(here("data/WAAL_dist_Clay2019/Dem_props copy.csv"),
                      show_col_types = FALSE) %>%
  mutate(Dem_class = str_replace(Dem_class, "J2\\+3", "J2J3"))

# Use 1990-1995 bycatch with 1990-1994 population (closest matching period)
target_period_byc <- "1990-1995"
target_period_pop <- "1990-1994"

pop_1990 <- dem_props %>%
  filter(Period == target_period_pop, Dem_class != "J1") %>%
  select(Dem_class, Pop) %>%
  mutate(age_class = tolower(Dem_class)) %>%
  mutate(age_class = case_when(
    age_class == "j2j3" ~ "j2j3",
    age_class == "imm" ~ "imm",
    age_class == "fb" ~ "fb",
    age_class == "sb" ~ "sb",
    age_class == "nb" ~ "nb"
  ))

# Get 1990-1995 bycatch by fishery and calculate per-capita
byc_1990 <- byc_period %>%
  filter(year_group == target_period_byc) %>%
  select(fishery, fb, sb, nb, j2j3, imm) %>%
  pivot_longer(cols = c(fb, sb, nb, j2j3, imm), names_to = "age_class", values_to = "annual_byc") %>%
  left_join(pop_1990 %>% select(age_class, Pop), by = "age_class") %>%
  mutate(percap = annual_byc / Pop)

byc_1990 %>% print(n = 20)

# Extract per-capita rates by fishery and age class
dem_fm_juv <- byc_1990 %>% filter(fishery == "DLL", age_class == "j2j3") %>% pull(percap)
dem_fm_imm <- byc_1990 %>% filter(fishery == "DLL", age_class == "imm") %>% pull(percap)
dem_fm_fb  <- byc_1990 %>% filter(fishery == "DLL", age_class == "fb") %>% pull(percap)
dem_fm_sb  <- byc_1990 %>% filter(fishery == "DLL", age_class == "sb") %>% pull(percap)
dem_fm_nb  <- byc_1990 %>% filter(fishery == "DLL", age_class == "nb") %>% pull(percap)

pel_fm_juv <- byc_1990 %>% filter(fishery == "PLL", age_class == "j2j3") %>% pull(percap)
pel_fm_imm <- byc_1990 %>% filter(fishery == "PLL", age_class == "imm") %>% pull(percap)
pel_fm_fb  <- byc_1990 %>% filter(fishery == "PLL", age_class == "fb") %>% pull(percap)
pel_fm_sb  <- byc_1990 %>% filter(fishery == "PLL", age_class == "sb") %>% pull(percap)
pel_fm_nb  <- byc_1990 %>% filter(fishery == "PLL", age_class == "nb") %>% pull(percap)

# Print summary
cat(sprintf("=== Per-capita fishing mortality (%s bycatch, %s population) ===\n\n",
            target_period_byc, target_period_pop))
cat(sprintf("%-8s %10s %10s %10s\n", "Age", "DLL", "PLL", "Total"))
for (ac in c("j2j3", "imm", "fb", "sb", "nb")) {
  d <- byc_1990 %>% filter(fishery == "DLL", age_class == ac) %>% pull(percap)
  p <- byc_1990 %>% filter(fishery == "PLL", age_class == ac) %>% pull(percap)
  cat(sprintf("%-8s %10.6f %10.6f %10.6f\n", ac, d, p, d + p))
}
```

**IUU**
Welch et al (6%), Weimerskirch et al. (=< 33%), Carneiro et al. 2022 (low, need to calculate myself from her paper)
USE THESE RATES TO SET IUU scenarios, distributions as in previous code


**partition mortality between natural and fishery mortality, set efficacy rates**
```{r}
# survival = 1 - total_mortality
# total_mortality = natural_mortality + fishing_mortality
# therefore: natural_mortality = (1 - survival) - fishing_mortality

# Natural mortality = total mortality minus fishing mortality (no IUU)
nm_juv <- (1-s_Juv)-dem_fm_juv-pel_fm_juv
nm_imm <- (1-s_Imm)-dem_fm_imm-pel_fm_imm
nm_efb <- (1-s_EF)-dem_fm_fb-pel_fm_fb
nm_esb <- (1-s_ES)-dem_fm_sb-pel_fm_sb
nm_enb <- (1-s_ENB)-dem_fm_nb-pel_fm_nb
nm_ifb <- (1-s_IF)-dem_fm_fb-pel_fm_fb
nm_isb <- (1-s_IS)-dem_fm_sb-pel_fm_sb
nm_pf  <- (1-s_PF)-dem_fm_nb-pel_fm_nb

# Check all natural mortalities are positive
cat("=== Natural mortality check ===\n")
nm_vals <- c(nm_juv=nm_juv, nm_imm=nm_imm, nm_efb=nm_efb, nm_esb=nm_esb,
             nm_enb=nm_enb, nm_ifb=nm_ifb, nm_isb=nm_isb, nm_pf=nm_pf)
for (nm_name in names(nm_vals)) {
  cat(sprintf("  %s: %.4f %s\n", nm_name, nm_vals[nm_name],
              ifelse(nm_vals[nm_name] > 0, "OK", "NEGATIVE - bycatch too high!")))
}
```

**loop through mitigation measure scenarios × coverage levels**
Test each mitigation scenario (from single measures to full 3/3) across varying
proportions of fisheries. Efficacy values based on literature (see above).
```{r}
# Efficacy of individual mitigation measures (proportion reduction in bycatch)
# Based on ACAP best practice reviews, Bull 2007, Melvin et al. 2014,
# Domingo et al. 2017, Robertson et al. 2006
# Values reflect operational (real-world) conditions, not best-case experimental.
eff_tori_lines   <- 0.80  # tori/bird scaring lines (Bull 2007: 85-100% experimental; operational ~70-85%)
eff_night_set    <- 0.60  # night setting (ACAP review: 60-85% experimental; varies with moon phase/latitude)
eff_line_weight  <- 0.65  # weighted branch lines / integrated weight lines (Robertson et al. 2006: 50-80%)
eff_hook_shield  <- 0.35  # hook shielding devices / smart tuna hooks (Sullivan et al. 2018: ~30-50%)

# Combined efficacy: 1 - (1-a)*(1-b)*(1-c) for independent measures
eff_2of3 <- 1 - (1 - eff_tori_lines) * (1 - eff_night_set)                    # tori + night set
eff_3of3 <- 1 - (1 - eff_tori_lines) * (1 - eff_night_set) * (1 - eff_line_weight)  # all three

cat(sprintf("2/3 combined efficacy: %.1f%%\n", eff_2of3 * 100))
cat(sprintf("3/3 combined efficacy: %.1f%%\n", eff_3of3 * 100))

# Define named mitigation scenarios
mitigation_scenarios <- tibble(
  scenario = c("Hook shielding only",
               "Line weighting only",
               "Night setting only",
               "Tori lines only",
               "2/3 (tori + night)",
               "3/3 (tori + night + weight)"),
  efficacy = c(eff_hook_shield,                                          # 0.35
               eff_line_weight,                                          # 0.65
               eff_night_set,                                            # 0.60
               eff_tori_lines,                                           # 0.80
               eff_2of3,                                                 # tori + night combined
               eff_3of3)                                                 # all three combined
)

mitigation_scenarios %>% mutate(efficacy_pct = round(efficacy * 100, 1)) %>% print()

coverage_seq <- seq(0, 1, by = 0.01)

# Run all scenarios
blanket_results <- expand.grid(
  scenario_idx = 1:nrow(mitigation_scenarios),
  reduction = coverage_seq
) %>%
  mutate(lambda = NA_real_,
         scenario = mitigation_scenarios$scenario[scenario_idx],
         efficacy = mitigation_scenarios$efficacy[scenario_idx])

for (i in 1:nrow(blanket_results)) {
  mit_eff <- blanket_results$efficacy[i]
  red <- blanket_results$reduction[i]

  ns_Juv <- 1 - (((dem_fm_juv + pel_fm_juv) * (1 - (mit_eff * red))) + (nm_juv))
  ns_Imm <- 1 - (((dem_fm_imm + pel_fm_imm) * (1 - (mit_eff * red))) + (nm_imm))
  ns_EF  <- 1 - (((dem_fm_fb  + pel_fm_fb)  * (1 - (mit_eff * red))) + (nm_efb))
  ns_ES  <- 1 - (((dem_fm_sb  + pel_fm_sb)  * (1 - (mit_eff * red))) + (nm_esb))
  ns_ENB <- 1 - (((dem_fm_nb  + pel_fm_nb)  * (1 - (mit_eff * red))) + (nm_enb))
  ns_IF  <- 1 - (((dem_fm_fb  + pel_fm_fb)  * (1 - (mit_eff * red))) + (nm_ifb))
  ns_IS  <- 1 - (((dem_fm_sb  + pel_fm_sb)  * (1 - (mit_eff * red))) + (nm_isb))
  ns_PF  <- 1 - (((dem_fm_nb  + pel_fm_nb)  * (1 - (mit_eff * red))) + (nm_pf))

  n_m <- matrix(data = c(
    0,     0,      0,      0,      0,                                          0.5*ns_Juv,               0,                        0.5*ns_Juv,               0,                        0,                          0,
    ns_Juv,0,      0,      0,      0,                                          0,                        0,                        0,                        0,                        0,                          0,
    0,     ns_Juv, 0,      0,      0,                                          0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      ns_Imm, 0,      0,                                          0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      ns_Imm, ns_Imm*r_Imm*(1-b_Imm)+ns_Imm*(1-r_Imm),  0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      0,      ns_Imm*r_Imm*b_Imm*k_Imm,                  0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      0,      ns_Imm*r_Imm*b_Imm*(1-k_Imm),              0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      0,      0,                                          ns_IS*r_IS*b_IS*k_IS,     ns_IF*r_IF*b_IF*k_IF,     ns_ES*r_ES*b_ES*k_ES,     ns_EF*r_EF*b_EF*k_EF,     ns_ENB*r_ENB*b_ENB*k_ENB,   ns_PF*r_PF*b_PF*k_PF,
    0,     0,      0,      0,      0,                                          ns_IS*r_IS*b_IS*(1-k_IS), ns_IF*r_IF*b_IF*(1-k_IF), ns_ES*r_ES*b_ES*(1-k_ES), ns_EF*r_EF*b_EF*(1-k_EF), ns_ENB*r_ENB*b_ENB*(1-k_ENB),ns_PF*r_PF*b_PF*(1-k_PF),
    0,     0,      0,      0,      0,                                          ns_IS*r_IS*(1-b_IS),      ns_IF*r_IF*(1-b_IF),      ns_ES*r_ES*(1-b_ES),      ns_EF*r_EF*(1-b_EF),      ns_ENB*r_ENB*(1-b_ENB),     ns_PF*r_PF*(1-b_PF),
    0,     0,      0,      0,      0,                                          ns_IS*(1-r_IS),           ns_IF*(1-r_IF),           ns_ES*(1-r_ES),           ns_EF*(1-r_EF),           ns_ENB*(1-r_ENB),           ns_PF*(1-r_PF)
  ), nrow = 11, byrow = TRUE)

  n_m_eig <- eigen(n_m)
  blanket_results$lambda[i] <- as.numeric(n_m_eig$values[1])
}
```

**plot mitigation scenarios**
```{r}
# Order scenarios by efficacy for legend
blanket_results <- blanket_results %>%
  mutate(scenario = factor(scenario,
    levels = mitigation_scenarios$scenario))

ggplot(blanket_results) +
  geom_line(aes(x = reduction, y = lambda,
                group = scenario, color = scenario)) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  labs(x = "% fisheries with bycatch mitigation",
       y = "lambda",
       color = "Mitigation scenario") +
  themeo +
  guides(colour = guide_legend(nrow = 2)) +
  coord_cartesian(expand = FALSE) +
  scale_color_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494"))
```

**plot mitigation scenarios — zoomed near lambda = 1 threshold**
```{r}
# Zoom to the ecologically critical range around lambda = 1
# Small differences in lambda here determine population decline vs recovery
ggplot(blanket_results) +
  geom_line(aes(x = reduction, y = lambda,
                group = scenario, color = scenario),
            linewidth = 0.8) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  labs(x = "% fisheries with bycatch mitigation",
       y = "lambda",
       color = "Mitigation scenario",
       subtitle = "Zoomed to lambda = 1 threshold — small differences determine decline vs recovery") +
  themeo +
  guides(colour = guide_legend(nrow = 2)) +
  coord_cartesian(ylim = c(0.995, 1.005), expand = FALSE) +
  scale_color_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494"))
```

**coverage needed to reach lambda >= 1 by scenario**
```{r}
# For each scenario, find the minimum coverage at which lambda crosses 1
threshold_crossings <- blanket_results %>%
  filter(lambda >= 1) %>%
  group_by(scenario) %>%
  summarise(min_coverage = min(reduction), .groups = "drop") %>%
  arrange(min_coverage)

# Scenarios that never reach lambda = 1
never_recover <- setdiff(levels(blanket_results$scenario), threshold_crossings$scenario)
if (length(never_recover) > 0) {
  threshold_crossings <- bind_rows(
    threshold_crossings,
    tibble(scenario = never_recover, min_coverage = NA_real_)
  )
}

threshold_crossings %>%
  mutate(min_coverage_pct = ifelse(is.na(min_coverage),
                                   "Never reaches lambda >= 1",
                                   paste0(min_coverage * 100, "%"))) %>%
  print()
```

**mitigation scenarios — this section is now replaced by the named scenario loop above**
The blanket scenario loop now tests all 6 measure combinations (hook shielding, line weight, night set, tori, 2/3, 3/3) directly. See the `blanket_results` output above.

*FLEET-LEVEL MITIGATION SCENARIOS*

The blanket approach above applies uniform mitigation across all fisheries. Below we disaggregate bycatch by fleet and apply fleet-specific mitigation reflecting actual management practices.

**load fleet-level bycatch and define mitigation scenarios**
```{r}
# Load fleet-level bycatch for the baseline period (1990-1995)
fleet_byc <- read_csv(here("output/bycatch_by_fleet_period_03f.csv"), show_col_types = FALSE) %>%
  filter(year_group == "1990-1995")

# Calculate per-capita rates by fleet
fleet_percap <- fleet_byc %>%
  select(fishery, fleet, fb, sb, nb, j2j3, imm) %>%
  pivot_longer(cols = c(fb, sb, nb, j2j3, imm), names_to = "age_class", values_to = "byc") %>%
  left_join(pop_1990 %>% select(age_class, Pop), by = "age_class") %>%
  mutate(percap = byc / Pop)

# Show which fleets contribute most to bycatch
fleet_byc %>%
  select(fishery, fleet, bi_total) %>%
  arrange(desc(bi_total)) %>%
  print(n = 20)
```

Mitigation efficacy rates (eff_tori_lines, eff_night_set, eff_line_weight, eff_hook_shield, eff_2of3, eff_3of3) and mitigation_scenarios are defined in the blanket scenario section above.

**define fleet-level mitigation status**
```{r}
# Define current mitigation status for each fleet
# status: "none", "partial" (2/3 measures), "full" (3/3 measures, best practice)
# compliance: proportion of fleet actually using the measures (0-1)
# PLACEHOLDERS — update based on RFMO/fleet-specific information

fleet_mitigation <- tribble(
  ~fishery, ~fleet,          ~status,    ~compliance,  ~notes,
  # DLL fleets - many have strong mitigation (CCAMLR especially)
  "DLL",    "CCAMLR",        "full",     0.95,         "3/3 measures, strong enforcement",
  "DLL",    "Argentina",     "partial",  0.70,         "some measures adopted",
  "DLL",    "Chile",         "partial",  0.60,         "some measures adopted",
  "DLL",    "Falklands",     "full",     0.90,         "3/3 measures, good compliance",
  "DLL",    "South Africa",  "full",     0.85,         "3/3 measures",
  # PLL fleets - many have 2/3 or less
  "PLL",    "Japan",         "partial",  0.80,         "2/3 in most RFMOs",
  "PLL",    "Taiwan",        "partial",  0.60,         "2/3 adopted but variable compliance",
  "PLL",    "Korea",         "partial",  0.50,         "2/3 in some areas",
  "PLL",    "Spain",         "partial",  0.70,         "EU requirements, 2/3",
  "PLL",    "Portugal",      "partial",  0.70,         "EU requirements, 2/3",
  "PLL",    "Brazil",        "partial",  0.40,         "some measures, lower compliance",
  "PLL",    "China",         "none",     0.0,          "limited adoption",
  "PLL",    "Other",         "none",     0.0,          "mixed/unknown fleets",
  "PLL",    "Chile",         "partial",  0.60,         "some measures",
  "PLL",    "South Africa",  "partial",  0.70,         "domestic requirements",
  "PLL",    "Cuba",          "none",     0.0,          "no information",
  "PLL",    "Belize",        "none",     0.0,          "flag of convenience",
  "PLL",    "France Reunion", "partial", 0.60,         "EU requirements",
  "PLL",    "Seychelles",    "none",     0.0,          "limited adoption",
  "PLL",    "Namibia",       "partial",  0.50,         "some measures",
  "PLL",    "Vanuatu",       "none",     0.0,          "flag of convenience",
  "PLL",    "USSR",          "none",     0.0,          "historical, no mitigation",
  "PLL",    "USA",           "partial",  0.80,         "NMFS requirements",
  "PLL",    "Panama",        "none",     0.0,          "flag of convenience",
  "PLL",    "French Polynesia","partial",0.60,         "EU/French requirements",
  "PLL",    "St. Vincent and Grenadines", "none", 0.0, "flag of convenience"
)

# Map status to efficacy
fleet_mitigation <- fleet_mitigation %>%
  mutate(
    base_efficacy = case_when(
      status == "full"    ~ eff_3of3,
      status == "partial" ~ eff_2of3,
      status == "none"    ~ 0
    ),
    # Effective reduction = base efficacy * compliance
    effective_reduction = base_efficacy * compliance
  )

fleet_mitigation %>%
  select(fishery, fleet, status, compliance, base_efficacy, effective_reduction) %>%
  arrange(fishery, desc(effective_reduction)) %>%
  print(n = 30)
```

**calculate fleet-level fishing mortality under different scenarios**
```{r}
# Function to calculate total fishing mortality per age class under a given scenario
# scenario = a fleet_mitigation-style dataframe with effective_reduction per fleet
calc_fleet_fm <- function(fleet_percap_df, scenario_df) {

  # Join fleet per-capita rates with scenario reductions
  fm_by_fleet <- fleet_percap_df %>%
    left_join(scenario_df %>% select(fishery, fleet, effective_reduction),
              by = c("fishery", "fleet")) %>%
    mutate(
      # If fleet not in scenario table, assume no mitigation
      effective_reduction = replace_na(effective_reduction, 0),
      # Reduced per-capita rate
      percap_mitigated = percap * (1 - effective_reduction)
    )

  # Sum across fleets within each fishery x age_class
  fm_by_fishery <- fm_by_fleet %>%
    group_by(fishery, age_class) %>%
    summarise(
      percap_baseline = sum(percap),
      percap_mitigated = sum(percap_mitigated),
      pct_reduction = 1 - percap_mitigated / percap_baseline,
      .groups = "drop"
    )

  fm_by_fishery
}

# Helper to extract fm values from scenario output and build matrix
calc_lambda_from_scenario <- function(scenario_fm) {

  # Extract mitigated per-capita rates
  get_fm <- function(fish, ac) {
    scenario_fm %>% filter(fishery == fish, age_class == ac) %>% pull(percap_mitigated)
  }

  s_dem_fm_juv <- get_fm("DLL", "j2j3"); s_pel_fm_juv <- get_fm("PLL", "j2j3")
  s_dem_fm_imm <- get_fm("DLL", "imm");  s_pel_fm_imm <- get_fm("PLL", "imm")
  s_dem_fm_fb  <- get_fm("DLL", "fb");   s_pel_fm_fb  <- get_fm("PLL", "fb")
  s_dem_fm_sb  <- get_fm("DLL", "sb");   s_pel_fm_sb  <- get_fm("PLL", "sb")
  s_dem_fm_nb  <- get_fm("DLL", "nb");   s_pel_fm_nb  <- get_fm("PLL", "nb")

  # New survival = 1 - natural_mortality - mitigated_fishing_mortality
  ns_Juv <- 1 - nm_juv - s_dem_fm_juv - s_pel_fm_juv
  ns_Imm <- 1 - nm_imm - s_dem_fm_imm - s_pel_fm_imm
  ns_EF  <- 1 - nm_efb - s_dem_fm_fb  - s_pel_fm_fb
  ns_IF  <- 1 - nm_ifb - s_dem_fm_fb  - s_pel_fm_fb
  ns_ES  <- 1 - nm_esb - s_dem_fm_sb  - s_pel_fm_sb
  ns_IS  <- 1 - nm_isb - s_dem_fm_sb  - s_pel_fm_sb
  ns_ENB <- 1 - nm_enb - s_dem_fm_nb  - s_pel_fm_nb
  ns_PF  <- 1 - nm_pf  - s_dem_fm_nb  - s_pel_fm_nb

  # Build matrix (same structure as baseline)
  n_m <- matrix(data = c(
    0,     0,     0,      0,      0,                                           0.5*ns_Juv,              0,                       0.5*ns_Juv,              0,                       0,                         0,
    ns_Juv,0,     0,      0,      0,                                           0,                       0,                       0,                       0,                       0,                         0,
    0,     ns_Juv,0,      0,      0,                                           0,                       0,                       0,                       0,                       0,                         0,
    0,     0,     ns_Imm, 0,      0,                                           0,                       0,                       0,                       0,                       0,                         0,
    0,     0,     0,      ns_Imm, ns_Imm*r_Imm*(1-b_Imm)+ns_Imm*(1-r_Imm),   0,                       0,                       0,                       0,                       0,                         0,
    0,     0,     0,      0,      ns_Imm*r_Imm*b_Imm*k_Imm,                   0,                       0,                       0,                       0,                       0,                         0,
    0,     0,     0,      0,      ns_Imm*r_Imm*b_Imm*(1-k_Imm),               0,                       0,                       0,                       0,                       0,                         0,
    0,     0,     0,      0,      0,                                           ns_IS*r_IS*b_IS*k_IS,    ns_IF*r_IF*b_IF*k_IF,    ns_ES*r_ES*b_ES*k_ES,    ns_EF*r_EF*b_EF*k_EF,    ns_ENB*r_ENB*b_ENB*k_ENB,  ns_PF*r_PF*b_PF*k_PF,
    0,     0,     0,      0,      0,                                           ns_IS*r_IS*b_IS*(1-k_IS),ns_IF*r_IF*b_IF*(1-k_IF),ns_ES*r_ES*b_ES*(1-k_ES),ns_EF*r_EF*b_EF*(1-k_EF),ns_ENB*r_ENB*b_ENB*(1-k_ENB),ns_PF*r_PF*b_PF*(1-k_PF),
    0,     0,     0,      0,      0,                                           ns_IS*r_IS*(1-b_IS),     ns_IF*r_IF*(1-b_IF),     ns_ES*r_ES*(1-b_ES),     ns_EF*r_EF*(1-b_EF),     ns_ENB*r_ENB*(1-b_ENB),    ns_PF*r_PF*(1-b_PF),
    0,     0,     0,      0,      0,                                           ns_IS*(1-r_IS),          ns_IF*(1-r_IF),          ns_ES*(1-r_ES),          ns_EF*(1-r_EF),          ns_ENB*(1-r_ENB),          ns_PF*(1-r_PF)
  ), nrow = 11, byrow = TRUE)

  # Extract lambda
  n_m_eig <- eigen(n_m)
  lambda_n <- as.numeric(n_m_eig$values[1])

  return(lambda_n)
}
```

**define and run management scenarios**
```{r}
# SCENARIO 0: No mitigation (baseline 1990-1995)
scenario_none <- fleet_mitigation %>%
  mutate(effective_reduction = 0)

# SCENARIO 1: Current mitigation (as defined in fleet_mitigation table above)
scenario_current <- fleet_mitigation

# SCENARIO 2: All PLL fleets adopt 2/3 (current compliance levels)
scenario_pll_2of3 <- fleet_mitigation %>%
  mutate(
    base_efficacy = case_when(
      fishery == "DLL" ~ base_efficacy,  # keep DLL as is
      TRUE ~ eff_2of3                     # all PLL get 2/3
    ),
    compliance = case_when(
      fishery == "DLL" ~ compliance,
      compliance == 0 ~ 0.50,             # fleets with no mitigation get 50% compliance
      TRUE ~ compliance                   # keep existing compliance
    ),
    effective_reduction = base_efficacy * compliance
  )

# SCENARIO 3: All PLL fleets adopt 3/3 (current compliance levels)
scenario_pll_3of3 <- fleet_mitigation %>%
  mutate(
    base_efficacy = case_when(
      fishery == "DLL" ~ base_efficacy,
      TRUE ~ eff_3of3
    ),
    compliance = case_when(
      fishery == "DLL" ~ compliance,
      compliance == 0 ~ 0.50,
      TRUE ~ compliance
    ),
    effective_reduction = base_efficacy * compliance
  )

# SCENARIO 4: Full compliance everywhere (3/3, 100% compliance)
scenario_full <- fleet_mitigation %>%
  mutate(
    base_efficacy = eff_3of3,
    compliance = 1.0,
    effective_reduction = base_efficacy * compliance
  )

# SCENARIO 5: Target top 3 PLL fleets only (Taiwan, Japan, Other = ~95% of PLL bycatch)
# These are the fleets where intervention would have the most impact
scenario_target_top3 <- fleet_mitigation %>%
  mutate(
    base_efficacy = case_when(
      fishery == "PLL" & fleet %in% c("Taiwan", "Japan", "Other") ~ eff_3of3,
      TRUE ~ base_efficacy
    ),
    compliance = case_when(
      fishery == "PLL" & fleet %in% c("Taiwan", "Japan", "Other") ~ 0.80,
      TRUE ~ compliance
    ),
    effective_reduction = base_efficacy * compliance
  )

# Run all scenarios
scenarios <- list(
  "0_no_mitigation"    = scenario_none,
  "1_current"          = scenario_current,
  "2_all_pll_2of3"     = scenario_pll_2of3,
  "3_all_pll_3of3"     = scenario_pll_3of3,
  "4_full_compliance"  = scenario_full,
  "5_target_top3_pll"  = scenario_target_top3
)

scenario_results <- tibble(
  scenario = names(scenarios),
  lambda = NA_real_,
  dll_reduction_pct = NA_real_,
  pll_reduction_pct = NA_real_,
  total_byc_reduction_pct = NA_real_
)

for (i in seq_along(scenarios)) {
  fm <- calc_fleet_fm(fleet_percap, scenarios[[i]])
  scenario_results$lambda[i] <- calc_lambda_from_scenario(fm)

  # Track reductions
  dll_red <- fm %>% filter(fishery == "DLL") %>% summarise(mean(pct_reduction)) %>% pull()
  pll_red <- fm %>% filter(fishery == "PLL") %>% summarise(mean(pct_reduction)) %>% pull()
  total_red <- fm %>% summarise(
    weighted.mean(pct_reduction, w = percap_baseline)
  ) %>% pull()

  scenario_results$dll_reduction_pct[i] <- round(dll_red * 100, 1)
  scenario_results$pll_reduction_pct[i] <- round(pll_red * 100, 1)
  scenario_results$total_byc_reduction_pct[i] <- round(total_red * 100, 1)
}

scenario_results %>%
  mutate(lambda = round(lambda, 4)) %>%
  print()
```

**plot scenario comparison**
```{r}
ggplot(scenario_results, aes(x = reorder(scenario, lambda), y = lambda)) +
  geom_col(fill = "#41b6c4", width = 0.6) +
  geom_hline(yintercept = 1, color = "red", alpha = 0.5, linetype = "dashed") +
  geom_text(aes(label = round(lambda, 4)), hjust = -0.1, size = 3) +
  labs(x = "", y = "lambda",
       title = "Population growth rate under fleet-specific mitigation scenarios") +
  coord_flip(ylim = c(min(scenario_results$lambda) - 0.005, max(max(scenario_results$lambda) + 0.005, 1.005))) +
  themeo
```

**detailed fleet contribution to bycatch reduction**
```{r}
# Show which fleets contribute most to bycatch and how much each scenario reduces them
# Using scenario 5 (target top 3) as example
fm_target <- calc_fleet_fm(fleet_percap, scenario_target_top3)

# Fleet-level detail
fleet_detail <- fleet_percap %>%
  left_join(scenario_target_top3 %>% select(fishery, fleet, effective_reduction, status),
            by = c("fishery", "fleet")) %>%
  mutate(
    effective_reduction = replace_na(effective_reduction, 0),
    byc_mitigated = byc * (1 - effective_reduction)
  ) %>%
  group_by(fishery, fleet) %>%
  summarise(
    total_byc_baseline = sum(byc),
    total_byc_mitigated = sum(byc_mitigated),
    reduction_pct = round((1 - total_byc_mitigated / total_byc_baseline) * 100, 1),
    .groups = "drop"
  ) %>%
  filter(total_byc_baseline > 0.01) %>%
  arrange(desc(total_byc_baseline))

fleet_detail %>% print(n = 20)

cat(sprintf("\nTotal baseline bycatch: %.1f birds\n", sum(fleet_detail$total_byc_baseline)))
cat(sprintf("Total mitigated bycatch: %.1f birds\n", sum(fleet_detail$total_byc_mitigated)))
cat(sprintf("Overall reduction: %.1f%%\n",
            (1 - sum(fleet_detail$total_byc_mitigated) / sum(fleet_detail$total_byc_baseline)) * 100))
```


*IUU FISHING MORTALITY*

Total mortality is fixed by observed survival rates. We partition it into three components:
  (1 - survival) = natural_mortality + legal_FM + IUU_FM

Legal FM comes from the spatial overlap / BPUE analysis (script 03f).
IUU FM is estimated as a proportion of legal FM, carved out of what was previously attributed to natural mortality. Mitigation only affects legal FM. IUU can be reduced separately through enforcement scenarios.

**define IUU range and check natural mortality stays positive**
```{r}
# PLACEHOLDER RANGE: 2-30% of legal FM
# Low end (~2-6%): Carneiro et al. (2022), Agnew et al. (2009)
# Mid (~10%): conservative working estimate
# High end (~30%): Weimerskirch et al. (likely upper bound)
iuu_range <- seq(0.02, 0.30, by = 0.02)  # PLACEHOLDER — update from literature

# Check that natural mortality stays positive across the full IUU range
cat("=== Natural mortality check across IUU range ===\n")
for (iuu_p in iuu_range) {
  nm_check <- c(
    juv = nm_juv - (dem_fm_juv + pel_fm_juv) * iuu_p,
    imm = nm_imm - (dem_fm_imm + pel_fm_imm) * iuu_p,
    efb = nm_efb - (dem_fm_fb  + pel_fm_fb)  * iuu_p,
    esb = nm_esb - (dem_fm_sb  + pel_fm_sb)  * iuu_p,
    enb = nm_enb - (dem_fm_nb  + pel_fm_nb)  * iuu_p,
    ifb = nm_ifb - (dem_fm_fb  + pel_fm_fb)  * iuu_p,
    isb = nm_isb - (dem_fm_sb  + pel_fm_sb)  * iuu_p,
    pf  = nm_pf  - (dem_fm_nb  + pel_fm_nb)  * iuu_p
  )
  min_nm <- min(nm_check)
  flag <- ifelse(min_nm < 0, " *** NEGATIVE ***", "")
  cat(sprintf("  IUU = %4.0f%%: min natural mortality = %.6f%s\n",
              iuu_p * 100, min_nm, flag))
}
```

**verify mortality partition at a single IUU value**
```{r}
# Example check at 10% IUU
iuu_example <- 0.10
iuu_fm_juv_ex <- (dem_fm_juv + pel_fm_juv) * iuu_example
nm_juv_ex <- nm_juv - iuu_fm_juv_ex

cat("=== Mortality partition check (juveniles, IUU = 10%) ===\n")
cat(sprintf("  Legal FM:  %.6f\n", dem_fm_juv + pel_fm_juv))
cat(sprintf("  IUU FM:    %.6f\n", iuu_fm_juv_ex))
cat(sprintf("  Natural:   %.6f\n", nm_juv_ex))
cat(sprintf("  Sum:       %.6f\n", (dem_fm_juv + pel_fm_juv) + iuu_fm_juv_ex + nm_juv_ex))
cat(sprintf("  1 - s_Juv: %.6f\n", 1 - s_Juv))
```

**mitigation + IUU reduction scenarios (three axes)**
```{r}
# Three independent axes:
#   1. IUU proportion (2-30% of legal FM) — how much mortality is IUU
#   2. Mitigation coverage on legal fisheries (0-100%)
#   3. IUU reduction through enforcement (0-100%)
#
# new_survival = 1 - natural_mort - legal_FM*(1 - mit_eff*coverage) - IUU_FM*(1 - iuu_reduction)
# Natural mortality is constant within each IUU proportion level.

# Use the same named mitigation scenarios as the blanket loop
coverage_seq <- seq(0, 1, by = 0.01)
iuu_reduction_seq <- c(0, 0.25, 0.50, 0.75, 1.0)

# Four axes: mitigation scenario × IUU proportion × coverage × IUU reduction
iuu_scenario_output <- expand.grid(
  scenario_idx = 1:nrow(mitigation_scenarios),
  iuu_proportion = iuu_range,
  coverage = coverage_seq,
  iuu_reduction = iuu_reduction_seq
) %>%
  mutate(
    lambda = NA_real_,
    scenario = mitigation_scenarios$scenario[scenario_idx],
    mit_eff = mitigation_scenarios$efficacy[scenario_idx]
  )

for (i in 1:nrow(iuu_scenario_output)) {
  iuu_p   <- iuu_scenario_output$iuu_proportion[i]
  red     <- iuu_scenario_output$coverage[i]
  iuu_red <- iuu_scenario_output$iuu_reduction[i]
  mit_eff <- iuu_scenario_output$mit_eff[i]

  # IUU mortality for this proportion
  iuu_juv <- (dem_fm_juv + pel_fm_juv) * iuu_p
  iuu_imm <- (dem_fm_imm + pel_fm_imm) * iuu_p
  iuu_fb  <- (dem_fm_fb  + pel_fm_fb)  * iuu_p
  iuu_sb  <- (dem_fm_sb  + pel_fm_sb)  * iuu_p
  iuu_nb  <- (dem_fm_nb  + pel_fm_nb)  * iuu_p

  # Natural mortality (shrinks as IUU proportion increases)
  nm_j  <- nm_juv - iuu_juv
  nm_i  <- nm_imm - iuu_imm
  nm_ef <- nm_efb - iuu_fb
  nm_es <- nm_esb - iuu_sb
  nm_en <- nm_enb - iuu_nb
  nm_if <- nm_ifb - iuu_fb
  nm_is <- nm_isb - iuu_sb
  nm_p  <- nm_pf  - iuu_nb

  # New survival = 1 - natural_mort - mitigated_legal_FM - mitigated_IUU_FM
  ns_Juv <- 1 - nm_j -
    (dem_fm_juv + pel_fm_juv) * (1 - mit_eff * red) -
    iuu_juv * (1 - iuu_red)
  ns_Imm <- 1 - nm_i -
    (dem_fm_imm + pel_fm_imm) * (1 - mit_eff * red) -
    iuu_imm * (1 - iuu_red)
  ns_EF <- 1 - nm_ef -
    (dem_fm_fb + pel_fm_fb) * (1 - mit_eff * red) -
    iuu_fb * (1 - iuu_red)
  ns_ES <- 1 - nm_es -
    (dem_fm_sb + pel_fm_sb) * (1 - mit_eff * red) -
    iuu_sb * (1 - iuu_red)
  ns_ENB <- 1 - nm_en -
    (dem_fm_nb + pel_fm_nb) * (1 - mit_eff * red) -
    iuu_nb * (1 - iuu_red)
  ns_IF <- 1 - nm_if -
    (dem_fm_fb + pel_fm_fb) * (1 - mit_eff * red) -
    iuu_fb * (1 - iuu_red)
  ns_IS <- 1 - nm_is -
    (dem_fm_sb + pel_fm_sb) * (1 - mit_eff * red) -
    iuu_sb * (1 - iuu_red)
  ns_PF <- 1 - nm_p -
    (dem_fm_nb + pel_fm_nb) * (1 - mit_eff * red) -
    iuu_nb * (1 - iuu_red)

  # Build 11-stage matrix
  n_m <- matrix(data = c(
    0,     0,      0,      0,      0,                                          0.5*ns_Juv,               0,                        0.5*ns_Juv,               0,                        0,                          0,
    ns_Juv,0,      0,      0,      0,                                          0,                        0,                        0,                        0,                        0,                          0,
    0,     ns_Juv, 0,      0,      0,                                          0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      ns_Imm, 0,      0,                                          0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      ns_Imm, ns_Imm*r_Imm*(1-b_Imm)+ns_Imm*(1-r_Imm),  0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      0,      ns_Imm*r_Imm*b_Imm*k_Imm,                  0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      0,      ns_Imm*r_Imm*b_Imm*(1-k_Imm),              0,                        0,                        0,                        0,                        0,                          0,
    0,     0,      0,      0,      0,                                          ns_IS*r_IS*b_IS*k_IS,     ns_IF*r_IF*b_IF*k_IF,     ns_ES*r_ES*b_ES*k_ES,     ns_EF*r_EF*b_EF*k_EF,     ns_ENB*r_ENB*b_ENB*k_ENB,   ns_PF*r_PF*b_PF*k_PF,
    0,     0,      0,      0,      0,                                          ns_IS*r_IS*b_IS*(1-k_IS), ns_IF*r_IF*b_IF*(1-k_IF), ns_ES*r_ES*b_ES*(1-k_ES), ns_EF*r_EF*b_EF*(1-k_EF), ns_ENB*r_ENB*b_ENB*(1-k_ENB),ns_PF*r_PF*b_PF*(1-k_PF),
    0,     0,      0,      0,      0,                                          ns_IS*r_IS*(1-b_IS),      ns_IF*r_IF*(1-b_IF),      ns_ES*r_ES*(1-b_ES),      ns_EF*r_EF*(1-b_EF),      ns_ENB*r_ENB*(1-b_ENB),     ns_PF*r_PF*(1-b_PF),
    0,     0,      0,      0,      0,                                          ns_IS*(1-r_IS),           ns_IF*(1-r_IF),           ns_ES*(1-r_ES),           ns_EF*(1-r_EF),           ns_ENB*(1-r_ENB),           ns_PF*(1-r_PF)
  ), nrow = 11, byrow = TRUE)

  n_m_eig <- eigen(n_m)
  iuu_scenario_output$lambda[i] <- as.numeric(n_m_eig$values[1])
}
```

**plot IUU scenarios — faceted by mitigation scenario × IUU proportion**
```{r, fig.width=14, fig.height=10}
# Select representative IUU proportions and mitigation scenarios for plotting
iuu_plot_vals <- c(0.02, 0.10, 0.20, 0.30)
# Focus on the most policy-relevant scenarios
mit_plot_scenarios <- c("Tori lines only", "2/3 (tori + night)", "3/3 (tori + night + weight)")

iuu_scenario_output %>%
  filter(iuu_proportion %in% iuu_plot_vals,
         scenario %in% mit_plot_scenarios) %>%
  mutate(
    iuu_label = factor(paste0("IUU = ", iuu_proportion * 100, "%"),
                       levels = paste0("IUU = ", sort(iuu_plot_vals) * 100, "%")),
    scenario = factor(scenario, levels = mitigation_scenarios$scenario)
  ) %>%
  ggplot() +
  geom_line(aes(x = coverage, y = lambda,
                group = factor(iuu_reduction),
                color = factor(iuu_reduction))) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  facet_grid(scenario ~ iuu_label) +
  labs(x = "% legal fisheries with bycatch mitigation",
       y = "lambda",
       color = "% IUU\nreduction") +
  themeo +
  coord_cartesian(expand = FALSE) +
  scale_color_manual(values = c("#d73027", "#fc8d59", "#fee090", "#91bfdb", "#4575b4"))
```

**summary: at what coverage does each scenario reach lambda >= 1?**
```{r}
# For each mitigation scenario × IUU proportion × IUU reduction,
# find the minimum coverage needed to reach lambda >= 1
threshold_summary <- iuu_scenario_output %>%
  filter(lambda >= 1) %>%
  group_by(scenario, iuu_proportion, iuu_reduction) %>%
  summarise(min_coverage = min(coverage), .groups = "drop")

# Show for no IUU reduction (worst case for enforcement)
threshold_summary %>%
  filter(iuu_reduction == 0) %>%
  pivot_wider(names_from = iuu_proportion, values_from = min_coverage,
              names_prefix = "IUU_") %>%
  arrange(scenario) %>%
  print(n = 20)
```














*UNCERTAINTY SIMULATION*

Incorporate uncertainty in vital rates, fishing mortality, and IUU proportion.
Uses the 11-stage matrix and three-component mortality partition (natural + legal FM + IUU FM).

**define beta distribution parameters for vital rates**
```{r}
# Helper function to calculate beta distribution shape parameters from mean and 95% CI
# Uses method of moments: SE = (upper - lower) / 3.92
calc_beta_params <- function(mean_val, lower_ci, upper_ci) {
  se <- (upper_ci - lower_ci) / 3.92
  var <- se^2
  # Ensure variance is positive and smaller than mean*(1-mean) for valid beta
  max_var <- mean_val * (1 - mean_val)
  if (var >= max_var || var <= 0) {
    # Fall back to a reasonable variance (tight distribution)
    var <- max_var * 0.01
  }
  alpha <- mean_val * ((1 - mean_val) / var - 1 / mean_val)
  beta <- (1 - mean_val) * ((1 - mean_val) / var - 1 / (1 - mean_val))
  # Ensure both shape parameters are positive
  if (alpha <= 0 || beta <= 0) {
    alpha <- mean_val * 100
    beta <- (1 - mean_val) * 100
  }
  return(list(alpha = alpha, beta = beta))
}

# === SURVIVAL RATES ===
# PLACEHOLDER CIs — update from Pardo et al. / Clay et al. when available
# Survival CIs are typically tight for seabirds (±0.02-0.03)
surv_params <- list(
  s_Juv = calc_beta_params(0.846, 0.81, 0.88),    # juvenile
  s_Imm = calc_beta_params(0.921, 0.89, 0.95),    # immature
  s_EF  = calc_beta_params(0.913, 0.88, 0.94),    # experienced failed
  s_ES  = calc_beta_params(0.895, 0.86, 0.93),    # experienced successful
  s_ENB = calc_beta_params(0.943, 0.92, 0.97),    # experienced non-breeding
  s_IF  = calc_beta_params(0.920, 0.89, 0.95),    # inexperienced failed
  s_IS  = calc_beta_params(0.892, 0.86, 0.93),    # inexperienced successful
  s_PF  = calc_beta_params(0.935, 0.91, 0.96)     # sabbatical
)

# === BREEDING PROBABILITY ===
# Wider CIs typical for breeding parameters (±0.05-0.10)
breed_params <- list(
  b_EF  = calc_beta_params(0.746, 0.68, 0.81),
  b_ENB = calc_beta_params(0.589, 0.52, 0.66),
  b_ES  = calc_beta_params(0.016, 0.005, 0.04),   # very low, keep tight
  b_IF  = calc_beta_params(0.744, 0.68, 0.81),
  b_Imm = calc_beta_params(0.101, 0.06, 0.15),
  b_IS  = calc_beta_params(0.011, 0.003, 0.03),   # very low, keep tight
  b_PF  = calc_beta_params(0.941, 0.90, 0.97)
)

# === RETURN PROBABILITY ===
return_params <- list(
  r_EF  = calc_beta_params(0.973, 0.95, 0.99),
  r_ENB = calc_beta_params(0.953, 0.93, 0.98),
  r_ES  = calc_beta_params(0.292, 0.22, 0.37),
  r_IF  = calc_beta_params(0.948, 0.92, 0.97),
  r_Imm = calc_beta_params(0.692, 0.63, 0.76),
  r_IS  = calc_beta_params(0.459, 0.38, 0.54),
  r_PF  = calc_beta_params(0.972, 0.95, 0.99)
)

# === BREEDING SUCCESS ===
success_params <- list(
  k_EF  = calc_beta_params(0.631, 0.57, 0.69),
  k_ENB = calc_beta_params(0.675, 0.61, 0.74),
  k_ES  = calc_beta_params(0.500, 0.43, 0.57),
  k_IF  = calc_beta_params(0.627, 0.56, 0.69),
  k_Imm = calc_beta_params(0.585, 0.52, 0.65),
  k_IS  = calc_beta_params(0.627, 0.56, 0.69),
  k_PF  = calc_beta_params(0.791, 0.73, 0.85)
)
```

**define FM uncertainty — per-rate beta distributions**
```{r}
# PLACEHOLDER CIs for per-capita fishing mortality
# FM rates are small, so CIs are expressed as proportional uncertainty
# Using ±50% of point estimate as rough 95% CI bounds — update from data

calc_fm_beta_params <- function(mean_val) {
  # For very small rates, use proportional uncertainty (±50%)
  lower <- mean_val * 0.5
  upper <- mean_val * 1.5
  # Clamp upper to < 1
  upper <- min(upper, 0.99)
  calc_beta_params(mean_val, lower, upper)
}

# DLL per-capita rates
fm_params_dll <- list(
  juv = calc_fm_beta_params(dem_fm_juv),
  imm = calc_fm_beta_params(dem_fm_imm),
  fb  = calc_fm_beta_params(dem_fm_fb),
  sb  = calc_fm_beta_params(dem_fm_sb),
  nb  = calc_fm_beta_params(dem_fm_nb)
)

# PLL per-capita rates
fm_params_pll <- list(
  juv = calc_fm_beta_params(pel_fm_juv),
  imm = calc_fm_beta_params(pel_fm_imm),
  fb  = calc_fm_beta_params(pel_fm_fb),
  sb  = calc_fm_beta_params(pel_fm_sb),
  nb  = calc_fm_beta_params(pel_fm_nb)
)
```

**run uncertainty simulation**
```{r}
# Simulation parameters
n_sims <- 1000
coverage_seq <- seq(0, 1, by = 0.01)

# Use the same named mitigation scenarios as above
# mitigation_scenarios tibble was defined earlier with scenario names and efficacy values

# Store results: list of dataframes, one per mitigation scenario
full_output_uncert <- vector("list", nrow(mitigation_scenarios))

set.seed(123)

for (k in seq_along(mitigation_scenarios$efficacy)) {
  mit_eff <- mitigation_scenarios$efficacy[k]

  # Output matrix: rows = coverage levels, cols = sim runs
  output_mat <- matrix(NA_real_,
                       nrow = length(coverage_seq),
                       ncol = n_sims)

  for (j in 1:n_sims) {
    set.seed(j)

    # --- Draw vital rates from beta distributions ---
    # Survival
    sim_s_Juv <- rbeta(1, surv_params$s_Juv$alpha, surv_params$s_Juv$beta)
    sim_s_Imm <- rbeta(1, surv_params$s_Imm$alpha, surv_params$s_Imm$beta)
    sim_s_EF  <- rbeta(1, surv_params$s_EF$alpha,  surv_params$s_EF$beta)
    sim_s_ES  <- rbeta(1, surv_params$s_ES$alpha,  surv_params$s_ES$beta)
    sim_s_ENB <- rbeta(1, surv_params$s_ENB$alpha, surv_params$s_ENB$beta)
    sim_s_IF  <- rbeta(1, surv_params$s_IF$alpha,  surv_params$s_IF$beta)
    sim_s_IS  <- rbeta(1, surv_params$s_IS$alpha,  surv_params$s_IS$beta)
    sim_s_PF  <- rbeta(1, surv_params$s_PF$alpha,  surv_params$s_PF$beta)

    # Breeding probability
    sim_b_EF  <- rbeta(1, breed_params$b_EF$alpha,  breed_params$b_EF$beta)
    sim_b_ENB <- rbeta(1, breed_params$b_ENB$alpha, breed_params$b_ENB$beta)
    sim_b_ES  <- rbeta(1, breed_params$b_ES$alpha,  breed_params$b_ES$beta)
    sim_b_IF  <- rbeta(1, breed_params$b_IF$alpha,  breed_params$b_IF$beta)
    sim_b_Imm <- rbeta(1, breed_params$b_Imm$alpha, breed_params$b_Imm$beta)
    sim_b_IS  <- rbeta(1, breed_params$b_IS$alpha,  breed_params$b_IS$beta)
    sim_b_PF  <- rbeta(1, breed_params$b_PF$alpha,  breed_params$b_PF$beta)

    # Return probability
    sim_r_EF  <- rbeta(1, return_params$r_EF$alpha,  return_params$r_EF$beta)
    sim_r_ENB <- rbeta(1, return_params$r_ENB$alpha, return_params$r_ENB$beta)
    sim_r_ES  <- rbeta(1, return_params$r_ES$alpha,  return_params$r_ES$beta)
    sim_r_IF  <- rbeta(1, return_params$r_IF$alpha,  return_params$r_IF$beta)
    sim_r_Imm <- rbeta(1, return_params$r_Imm$alpha, return_params$r_Imm$beta)
    sim_r_IS  <- rbeta(1, return_params$r_IS$alpha,  return_params$r_IS$beta)
    sim_r_PF  <- rbeta(1, return_params$r_PF$alpha,  return_params$r_PF$beta)

    # Breeding success
    sim_k_EF  <- rbeta(1, success_params$k_EF$alpha,  success_params$k_EF$beta)
    sim_k_ENB <- rbeta(1, success_params$k_ENB$alpha, success_params$k_ENB$beta)
    sim_k_ES  <- rbeta(1, success_params$k_ES$alpha,  success_params$k_ES$beta)
    sim_k_IF  <- rbeta(1, success_params$k_IF$alpha,  success_params$k_IF$beta)
    sim_k_Imm <- rbeta(1, success_params$k_Imm$alpha, success_params$k_Imm$beta)
    sim_k_IS  <- rbeta(1, success_params$k_IS$alpha,  success_params$k_IS$beta)
    sim_k_PF  <- rbeta(1, success_params$k_PF$alpha,  success_params$k_PF$beta)

    # --- Biological constraint check ---
    # Juvenile survival should be lower than immature and adult survival
    # Immature survival should be lower than adult survival
    # Adult stages (EF, ES, ENB, IF, IS, PF) should all be > juvenile
    min_adult_s <- min(sim_s_EF, sim_s_ES, sim_s_ENB, sim_s_IF, sim_s_IS, sim_s_PF)
    if (sim_s_Juv > sim_s_Imm || sim_s_Juv > min_adult_s || sim_s_Imm > min_adult_s) {
      next
    }

    # --- Draw per-rate fishing mortality ---
    sim_dem_fm_juv <- rbeta(1, fm_params_dll$juv$alpha, fm_params_dll$juv$beta)
    sim_dem_fm_imm <- rbeta(1, fm_params_dll$imm$alpha, fm_params_dll$imm$beta)
    sim_dem_fm_fb  <- rbeta(1, fm_params_dll$fb$alpha,  fm_params_dll$fb$beta)
    sim_dem_fm_sb  <- rbeta(1, fm_params_dll$sb$alpha,  fm_params_dll$sb$beta)
    sim_dem_fm_nb  <- rbeta(1, fm_params_dll$nb$alpha,  fm_params_dll$nb$beta)

    sim_pel_fm_juv <- rbeta(1, fm_params_pll$juv$alpha, fm_params_pll$juv$beta)
    sim_pel_fm_imm <- rbeta(1, fm_params_pll$imm$alpha, fm_params_pll$imm$beta)
    sim_pel_fm_fb  <- rbeta(1, fm_params_pll$fb$alpha,  fm_params_pll$fb$beta)
    sim_pel_fm_sb  <- rbeta(1, fm_params_pll$sb$alpha,  fm_params_pll$sb$beta)
    sim_pel_fm_nb  <- rbeta(1, fm_params_pll$nb$alpha,  fm_params_pll$nb$beta)

    # --- Draw IUU proportion from uniform ---
    sim_iuu_p <- runif(1, min = 0.02, max = 0.30)

    # --- Calculate IUU mortality ---
    sim_iuu_juv <- (sim_dem_fm_juv + sim_pel_fm_juv) * sim_iuu_p
    sim_iuu_imm <- (sim_dem_fm_imm + sim_pel_fm_imm) * sim_iuu_p
    sim_iuu_fb  <- (sim_dem_fm_fb  + sim_pel_fm_fb)  * sim_iuu_p
    sim_iuu_sb  <- (sim_dem_fm_sb  + sim_pel_fm_sb)  * sim_iuu_p
    sim_iuu_nb  <- (sim_dem_fm_nb  + sim_pel_fm_nb)  * sim_iuu_p

    # --- Calculate natural mortality ---
    # nm = (1 - survival) - legal_FM - IUU_FM
    sim_nm_juv <- (1 - sim_s_Juv) - (sim_dem_fm_juv + sim_pel_fm_juv) - sim_iuu_juv
    sim_nm_imm <- (1 - sim_s_Imm) - (sim_dem_fm_imm + sim_pel_fm_imm) - sim_iuu_imm
    sim_nm_efb <- (1 - sim_s_EF)  - (sim_dem_fm_fb  + sim_pel_fm_fb)  - sim_iuu_fb
    sim_nm_esb <- (1 - sim_s_ES)  - (sim_dem_fm_sb  + sim_pel_fm_sb)  - sim_iuu_sb
    sim_nm_enb <- (1 - sim_s_ENB) - (sim_dem_fm_nb  + sim_pel_fm_nb)  - sim_iuu_nb
    sim_nm_ifb <- (1 - sim_s_IF)  - (sim_dem_fm_fb  + sim_pel_fm_fb)  - sim_iuu_fb
    sim_nm_isb <- (1 - sim_s_IS)  - (sim_dem_fm_sb  + sim_pel_fm_sb)  - sim_iuu_sb
    sim_nm_pf  <- (1 - sim_s_PF)  - (sim_dem_fm_nb  + sim_pel_fm_nb)  - sim_iuu_nb

    # Skip if any natural mortality is negative (FM exceeds mortality budget)
    if (any(c(sim_nm_juv, sim_nm_imm, sim_nm_efb, sim_nm_esb,
              sim_nm_enb, sim_nm_ifb, sim_nm_isb, sim_nm_pf) < 0)) {
      next
    }

    # --- Loop over mitigation coverage levels ---
    for (i in seq_along(coverage_seq)) {
      red <- coverage_seq[i]

      # Mitigated survival: only legal FM is reduced, IUU stays
      ns_Juv <- 1 - sim_nm_juv -
        (sim_dem_fm_juv + sim_pel_fm_juv) * (1 - mit_eff * red) -
        sim_iuu_juv
      ns_Imm <- 1 - sim_nm_imm -
        (sim_dem_fm_imm + sim_pel_fm_imm) * (1 - mit_eff * red) -
        sim_iuu_imm
      ns_EF <- 1 - sim_nm_efb -
        (sim_dem_fm_fb + sim_pel_fm_fb) * (1 - mit_eff * red) -
        sim_iuu_fb
      ns_ES <- 1 - sim_nm_esb -
        (sim_dem_fm_sb + sim_pel_fm_sb) * (1 - mit_eff * red) -
        sim_iuu_sb
      ns_ENB <- 1 - sim_nm_enb -
        (sim_dem_fm_nb + sim_pel_fm_nb) * (1 - mit_eff * red) -
        sim_iuu_nb
      ns_IF <- 1 - sim_nm_ifb -
        (sim_dem_fm_fb + sim_pel_fm_fb) * (1 - mit_eff * red) -
        sim_iuu_fb
      ns_IS <- 1 - sim_nm_isb -
        (sim_dem_fm_sb + sim_pel_fm_sb) * (1 - mit_eff * red) -
        sim_iuu_sb
      ns_PF <- 1 - sim_nm_pf -
        (sim_dem_fm_nb + sim_pel_fm_nb) * (1 - mit_eff * red) -
        sim_iuu_nb

      # Build 11-stage matrix with drawn VRs
      n_m <- matrix(data = c(
        0,      0,      0,       0,       0,                                                         0.5*ns_Juv,                          0,                                   0.5*ns_Juv,                          0,                                   0,                                     0,
        ns_Juv, 0,      0,       0,       0,                                                         0,                                   0,                                   0,                                   0,                                   0,                                     0,
        0,      ns_Juv, 0,       0,       0,                                                         0,                                   0,                                   0,                                   0,                                   0,                                     0,
        0,      0,      ns_Imm,  0,       0,                                                         0,                                   0,                                   0,                                   0,                                   0,                                     0,
        0,      0,      0,       ns_Imm,  ns_Imm*sim_r_Imm*(1-sim_b_Imm)+ns_Imm*(1-sim_r_Imm),      0,                                   0,                                   0,                                   0,                                   0,                                     0,
        0,      0,      0,       0,       ns_Imm*sim_r_Imm*sim_b_Imm*sim_k_Imm,                     0,                                   0,                                   0,                                   0,                                   0,                                     0,
        0,      0,      0,       0,       ns_Imm*sim_r_Imm*sim_b_Imm*(1-sim_k_Imm),                 0,                                   0,                                   0,                                   0,                                   0,                                     0,
        0,      0,      0,       0,       0,                                                         ns_IS*sim_r_IS*sim_b_IS*sim_k_IS,    ns_IF*sim_r_IF*sim_b_IF*sim_k_IF,    ns_ES*sim_r_ES*sim_b_ES*sim_k_ES,    ns_EF*sim_r_EF*sim_b_EF*sim_k_EF,    ns_ENB*sim_r_ENB*sim_b_ENB*sim_k_ENB,  ns_PF*sim_r_PF*sim_b_PF*sim_k_PF,
        0,      0,      0,       0,       0,                                                         ns_IS*sim_r_IS*sim_b_IS*(1-sim_k_IS),ns_IF*sim_r_IF*sim_b_IF*(1-sim_k_IF),ns_ES*sim_r_ES*sim_b_ES*(1-sim_k_ES),ns_EF*sim_r_EF*sim_b_EF*(1-sim_k_EF),ns_ENB*sim_r_ENB*sim_b_ENB*(1-sim_k_ENB),ns_PF*sim_r_PF*sim_b_PF*(1-sim_k_PF),
        0,      0,      0,       0,       0,                                                         ns_IS*sim_r_IS*(1-sim_b_IS),         ns_IF*sim_r_IF*(1-sim_b_IF),         ns_ES*sim_r_ES*(1-sim_b_ES),         ns_EF*sim_r_EF*(1-sim_b_EF),         ns_ENB*sim_r_ENB*(1-sim_b_ENB),        ns_PF*sim_r_PF*(1-sim_b_PF),
        0,      0,      0,       0,       0,                                                         ns_IS*(1-sim_r_IS),                  ns_IF*(1-sim_r_IF),                  ns_ES*(1-sim_r_ES),                  ns_EF*(1-sim_r_EF),                  ns_ENB*(1-sim_r_ENB),                  ns_PF*(1-sim_r_PF)
      ), nrow = 11, byrow = TRUE)

      n_m_eig <- eigen(n_m)
      output_mat[i, j] <- as.numeric(n_m_eig$values[1])
    }
  }

  # Store results with metadata
  output_df <- as.data.frame(output_mat)
  output_df$mitigation_efficacy <- mit_eff
  output_df$scenario <- mitigation_scenarios$scenario[k]
  output_df$coverage <- coverage_seq
  full_output_uncert[[k]] <- output_df
}
```

**format uncertainty output**
```{r}
# Combine all mitigation scenarios into long format
uncert_long <- map_dfr(full_output_uncert, function(df) {
  df %>%
    select_if(~ all(!is.na(.))) %>%
    pivot_longer(cols = starts_with("V"),
                 names_to = "simrun",
                 values_to = "lambda")
})

# Order scenarios by efficacy
uncert_long <- uncert_long %>%
  mutate(scenario = factor(scenario, levels = mitigation_scenarios$scenario))

# Calculate summary statistics per coverage × scenario
uncert_summary <- uncert_long %>%
  group_by(scenario, coverage) %>%
  summarise(
    mean_lambda = mean(lambda),
    q05 = quantile(lambda, 0.05),
    q25 = quantile(lambda, 0.25),
    q75 = quantile(lambda, 0.75),
    q95 = quantile(lambda, 0.95),
    n_sims = n(),
    .groups = "drop"
  )

# Check how many sims passed filters per scenario
uncert_long %>%
  group_by(scenario) %>%
  summarise(n_valid_sims = n_distinct(simrun)) %>%
  print()
```

**plot uncertainty — individual sim runs + mean**
```{r, fig.width=14, fig.height=5}
ggplot(uncert_long) +
  geom_line(aes(x = coverage, y = lambda, group = simrun),
            color = "grey", alpha = 0.1) +
  geom_line(data = uncert_summary,
            aes(x = coverage, y = mean_lambda),
            color = "blue", linewidth = 0.8) +
  geom_hline(yintercept = 1, color = "red", alpha = 0.5) +
  labs(x = "% legal fisheries with bycatch mitigation", y = "lambda") +
  facet_wrap(~scenario, nrow = 1) +
  themeo +
  coord_cartesian(expand = FALSE)
```

**plot uncertainty — ribbon (90% CI + IQR)**
```{r, fig.width=14, fig.height=5}
ggplot(uncert_summary) +
  geom_ribbon(aes(x = coverage, ymin = q05, ymax = q95),
              fill = "lightblue", alpha = 0.4) +
  geom_ribbon(aes(x = coverage, ymin = q25, ymax = q75),
              fill = "steelblue", alpha = 0.4) +
  geom_line(aes(x = coverage, y = mean_lambda),
            color = "darkblue", linewidth = 0.8) +
  geom_hline(yintercept = 1, color = "red", alpha = 0.5, linetype = "dashed") +
  labs(x = "% legal fisheries with bycatch mitigation", y = "lambda",
       subtitle = "Dark ribbon = IQR, light ribbon = 90% CI") +
  facet_wrap(~scenario, nrow = 1) +
  themeo +
  coord_cartesian(expand = FALSE)
```

**plot uncertainty — zoomed near lambda = 1 (mean lines only, all scenarios overlaid)**
```{r, fig.width=10, fig.height=5}
# Overlay all scenarios on one plot, zoomed to the threshold region
# This makes the difference between 2/3 and 3/3 visible
ggplot(uncert_summary) +
  geom_line(aes(x = coverage, y = mean_lambda,
                group = scenario, color = scenario),
            linewidth = 0.8) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  labs(x = "% legal fisheries with bycatch mitigation", y = "lambda",
       color = "Mitigation scenario",
       subtitle = "Mean lambda with VR + FM + IUU uncertainty — zoomed to recovery threshold") +
  themeo +
  guides(colour = guide_legend(nrow = 2)) +
  coord_cartesian(ylim = c(0.995, 1.005), expand = FALSE) +
  scale_color_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494"))
```

**probability of recovery (lambda >= 1) by coverage and scenario**
```{r, fig.width=14, fig.height=5}
# For each coverage × scenario, what fraction of sims achieve lambda >= 1?
# This directly shows whether the population is likely to recover
prob_recovery <- uncert_long %>%
  group_by(scenario, coverage) %>%
  summarise(
    prob_recover = mean(lambda >= 1),
    .groups = "drop"
  )

ggplot(prob_recovery) +
  geom_line(aes(x = coverage, y = prob_recover,
                group = scenario, color = scenario),
            linewidth = 0.8) +
  geom_hline(yintercept = 0.5, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  labs(x = "% legal fisheries with bycatch mitigation",
       y = "P(lambda >= 1)",
       color = "Mitigation scenario",
       subtitle = "Probability of population recovery under uncertainty") +
  themeo +
  guides(colour = guide_legend(nrow = 2)) +
  coord_cartesian(expand = FALSE) +
  scale_color_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494"))
```

*UNCERTAINTY SIMULATION WITH FIXED IUU RATES + IUU REDUCTION*

Same VR/FM uncertainty as above, but with fixed IUU proportions (2%, 10%, 30%)
crossed with 3 IUU enforcement levels (no reduction, 50% reduction, full elimination).
IUU only affects lambda when it is partially or fully reduced — without reduction,
IUU cancels algebraically (it's just relabeled natural mortality).

**run fixed-IUU uncertainty simulation with enforcement levels**
```{r}
fixed_iuu_vals <- c(0.02, 0.10, 0.30)
fixed_iuu_red_vals <- c(0, 0.50, 1.0)  # no reduction, 50% reduction, full elimination
n_sims_fixed <- 1000
coverage_seq_fixed <- seq(0, 1, by = 0.01)

# Total combos: 3 IUU levels × 3 IUU reductions × 6 mitigation scenarios = 54
full_output_fixed_iuu <- vector("list",
  length(fixed_iuu_vals) * length(fixed_iuu_red_vals) * nrow(mitigation_scenarios))

set.seed(123)
list_idx <- 0

for (iuu_idx in seq_along(fixed_iuu_vals)) {
  fixed_iuu_p <- fixed_iuu_vals[iuu_idx]

  for (iuu_red_idx in seq_along(fixed_iuu_red_vals)) {
    fixed_iuu_red <- fixed_iuu_red_vals[iuu_red_idx]

    for (k in seq_along(mitigation_scenarios$efficacy)) {
      mit_eff <- mitigation_scenarios$efficacy[k]
      list_idx <- list_idx + 1

      output_mat <- matrix(NA_real_,
                           nrow = length(coverage_seq_fixed),
                           ncol = n_sims_fixed)

      for (j in 1:n_sims_fixed) {
        set.seed(j)

        # --- Draw vital rates from beta distributions ---
        sim_s_Juv <- rbeta(1, surv_params$s_Juv$alpha, surv_params$s_Juv$beta)
        sim_s_Imm <- rbeta(1, surv_params$s_Imm$alpha, surv_params$s_Imm$beta)
        sim_s_EF  <- rbeta(1, surv_params$s_EF$alpha,  surv_params$s_EF$beta)
        sim_s_ES  <- rbeta(1, surv_params$s_ES$alpha,  surv_params$s_ES$beta)
        sim_s_ENB <- rbeta(1, surv_params$s_ENB$alpha, surv_params$s_ENB$beta)
        sim_s_IF  <- rbeta(1, surv_params$s_IF$alpha,  surv_params$s_IF$beta)
        sim_s_IS  <- rbeta(1, surv_params$s_IS$alpha,  surv_params$s_IS$beta)
        sim_s_PF  <- rbeta(1, surv_params$s_PF$alpha,  surv_params$s_PF$beta)

        sim_b_EF  <- rbeta(1, breed_params$b_EF$alpha,  breed_params$b_EF$beta)
        sim_b_ENB <- rbeta(1, breed_params$b_ENB$alpha, breed_params$b_ENB$beta)
        sim_b_ES  <- rbeta(1, breed_params$b_ES$alpha,  breed_params$b_ES$beta)
        sim_b_IF  <- rbeta(1, breed_params$b_IF$alpha,  breed_params$b_IF$beta)
        sim_b_Imm <- rbeta(1, breed_params$b_Imm$alpha, breed_params$b_Imm$beta)
        sim_b_IS  <- rbeta(1, breed_params$b_IS$alpha,  breed_params$b_IS$beta)
        sim_b_PF  <- rbeta(1, breed_params$b_PF$alpha,  breed_params$b_PF$beta)

        sim_r_EF  <- rbeta(1, return_params$r_EF$alpha,  return_params$r_EF$beta)
        sim_r_ENB <- rbeta(1, return_params$r_ENB$alpha, return_params$r_ENB$beta)
        sim_r_ES  <- rbeta(1, return_params$r_ES$alpha,  return_params$r_ES$beta)
        sim_r_IF  <- rbeta(1, return_params$r_IF$alpha,  return_params$r_IF$beta)
        sim_r_Imm <- rbeta(1, return_params$r_Imm$alpha, return_params$r_Imm$beta)
        sim_r_IS  <- rbeta(1, return_params$r_IS$alpha,  return_params$r_IS$beta)
        sim_r_PF  <- rbeta(1, return_params$r_PF$alpha,  return_params$r_PF$beta)

        sim_k_EF  <- rbeta(1, success_params$k_EF$alpha,  success_params$k_EF$beta)
        sim_k_ENB <- rbeta(1, success_params$k_ENB$alpha, success_params$k_ENB$beta)
        sim_k_ES  <- rbeta(1, success_params$k_ES$alpha,  success_params$k_ES$beta)
        sim_k_IF  <- rbeta(1, success_params$k_IF$alpha,  success_params$k_IF$beta)
        sim_k_Imm <- rbeta(1, success_params$k_Imm$alpha, success_params$k_Imm$beta)
        sim_k_IS  <- rbeta(1, success_params$k_IS$alpha,  success_params$k_IS$beta)
        sim_k_PF  <- rbeta(1, success_params$k_PF$alpha,  success_params$k_PF$beta)

        # --- Biological constraint check ---
        min_adult_s <- min(sim_s_EF, sim_s_ES, sim_s_ENB, sim_s_IF, sim_s_IS, sim_s_PF)
        if (sim_s_Juv > sim_s_Imm || sim_s_Juv > min_adult_s || sim_s_Imm > min_adult_s) {
          next
        }

        # --- Draw per-rate fishing mortality ---
        sim_dem_fm_juv <- rbeta(1, fm_params_dll$juv$alpha, fm_params_dll$juv$beta)
        sim_dem_fm_imm <- rbeta(1, fm_params_dll$imm$alpha, fm_params_dll$imm$beta)
        sim_dem_fm_fb  <- rbeta(1, fm_params_dll$fb$alpha,  fm_params_dll$fb$beta)
        sim_dem_fm_sb  <- rbeta(1, fm_params_dll$sb$alpha,  fm_params_dll$sb$beta)
        sim_dem_fm_nb  <- rbeta(1, fm_params_dll$nb$alpha,  fm_params_dll$nb$beta)

        sim_pel_fm_juv <- rbeta(1, fm_params_pll$juv$alpha, fm_params_pll$juv$beta)
        sim_pel_fm_imm <- rbeta(1, fm_params_pll$imm$alpha, fm_params_pll$imm$beta)
        sim_pel_fm_fb  <- rbeta(1, fm_params_pll$fb$alpha,  fm_params_pll$fb$beta)
        sim_pel_fm_sb  <- rbeta(1, fm_params_pll$sb$alpha,  fm_params_pll$sb$beta)
        sim_pel_fm_nb  <- rbeta(1, fm_params_pll$nb$alpha,  fm_params_pll$nb$beta)

        # --- Fixed IUU proportion ---
        sim_iuu_juv <- (sim_dem_fm_juv + sim_pel_fm_juv) * fixed_iuu_p
        sim_iuu_imm <- (sim_dem_fm_imm + sim_pel_fm_imm) * fixed_iuu_p
        sim_iuu_fb  <- (sim_dem_fm_fb  + sim_pel_fm_fb)  * fixed_iuu_p
        sim_iuu_sb  <- (sim_dem_fm_sb  + sim_pel_fm_sb)  * fixed_iuu_p
        sim_iuu_nb  <- (sim_dem_fm_nb  + sim_pel_fm_nb)  * fixed_iuu_p

        # --- Natural mortality ---
        sim_nm_juv <- (1 - sim_s_Juv) - (sim_dem_fm_juv + sim_pel_fm_juv) - sim_iuu_juv
        sim_nm_imm <- (1 - sim_s_Imm) - (sim_dem_fm_imm + sim_pel_fm_imm) - sim_iuu_imm
        sim_nm_efb <- (1 - sim_s_EF)  - (sim_dem_fm_fb  + sim_pel_fm_fb)  - sim_iuu_fb
        sim_nm_esb <- (1 - sim_s_ES)  - (sim_dem_fm_sb  + sim_pel_fm_sb)  - sim_iuu_sb
        sim_nm_enb <- (1 - sim_s_ENB) - (sim_dem_fm_nb  + sim_pel_fm_nb)  - sim_iuu_nb
        sim_nm_ifb <- (1 - sim_s_IF)  - (sim_dem_fm_fb  + sim_pel_fm_fb)  - sim_iuu_fb
        sim_nm_isb <- (1 - sim_s_IS)  - (sim_dem_fm_sb  + sim_pel_fm_sb)  - sim_iuu_sb
        sim_nm_pf  <- (1 - sim_s_PF)  - (sim_dem_fm_nb  + sim_pel_fm_nb)  - sim_iuu_nb

        # Skip if any natural mortality is negative
        if (any(c(sim_nm_juv, sim_nm_imm, sim_nm_efb, sim_nm_esb,
                  sim_nm_enb, sim_nm_ifb, sim_nm_isb, sim_nm_pf) < 0)) {
          next
        }

        # --- Loop over coverage levels ---
        for (i in seq_along(coverage_seq_fixed)) {
          red <- coverage_seq_fixed[i]

          # Legal FM reduced by mitigation, IUU FM reduced by enforcement
          ns_Juv <- 1 - sim_nm_juv -
            (sim_dem_fm_juv + sim_pel_fm_juv) * (1 - mit_eff * red) -
            sim_iuu_juv * (1 - fixed_iuu_red)
          ns_Imm <- 1 - sim_nm_imm -
            (sim_dem_fm_imm + sim_pel_fm_imm) * (1 - mit_eff * red) -
            sim_iuu_imm * (1 - fixed_iuu_red)
          ns_EF <- 1 - sim_nm_efb -
            (sim_dem_fm_fb + sim_pel_fm_fb) * (1 - mit_eff * red) -
            sim_iuu_fb * (1 - fixed_iuu_red)
          ns_ES <- 1 - sim_nm_esb -
            (sim_dem_fm_sb + sim_pel_fm_sb) * (1 - mit_eff * red) -
            sim_iuu_sb * (1 - fixed_iuu_red)
          ns_ENB <- 1 - sim_nm_enb -
            (sim_dem_fm_nb + sim_pel_fm_nb) * (1 - mit_eff * red) -
            sim_iuu_nb * (1 - fixed_iuu_red)
          ns_IF <- 1 - sim_nm_ifb -
            (sim_dem_fm_fb + sim_pel_fm_fb) * (1 - mit_eff * red) -
            sim_iuu_fb * (1 - fixed_iuu_red)
          ns_IS <- 1 - sim_nm_isb -
            (sim_dem_fm_sb + sim_pel_fm_sb) * (1 - mit_eff * red) -
            sim_iuu_sb * (1 - fixed_iuu_red)
          ns_PF <- 1 - sim_nm_pf -
            (sim_dem_fm_nb + sim_pel_fm_nb) * (1 - mit_eff * red) -
            sim_iuu_nb * (1 - fixed_iuu_red)

          # Build 11-stage matrix with drawn VRs
          n_m <- matrix(data = c(
            0,      0,      0,       0,       0,                                                         0.5*ns_Juv,                          0,                                   0.5*ns_Juv,                          0,                                   0,                                     0,
            ns_Juv, 0,      0,       0,       0,                                                         0,                                   0,                                   0,                                   0,                                   0,                                     0,
            0,      ns_Juv, 0,       0,       0,                                                         0,                                   0,                                   0,                                   0,                                   0,                                     0,
            0,      0,      ns_Imm,  0,       0,                                                         0,                                   0,                                   0,                                   0,                                   0,                                     0,
            0,      0,      0,       ns_Imm,  ns_Imm*sim_r_Imm*(1-sim_b_Imm)+ns_Imm*(1-sim_r_Imm),      0,                                   0,                                   0,                                   0,                                   0,                                     0,
            0,      0,      0,       0,       ns_Imm*sim_r_Imm*sim_b_Imm*sim_k_Imm,                     0,                                   0,                                   0,                                   0,                                   0,                                     0,
            0,      0,      0,       0,       ns_Imm*sim_r_Imm*sim_b_Imm*(1-sim_k_Imm),                 0,                                   0,                                   0,                                   0,                                   0,                                     0,
            0,      0,      0,       0,       0,                                                         ns_IS*sim_r_IS*sim_b_IS*sim_k_IS,    ns_IF*sim_r_IF*sim_b_IF*sim_k_IF,    ns_ES*sim_r_ES*sim_b_ES*sim_k_ES,    ns_EF*sim_r_EF*sim_b_EF*sim_k_EF,    ns_ENB*sim_r_ENB*sim_b_ENB*sim_k_ENB,  ns_PF*sim_r_PF*sim_b_PF*sim_k_PF,
            0,      0,      0,       0,       0,                                                         ns_IS*sim_r_IS*sim_b_IS*(1-sim_k_IS),ns_IF*sim_r_IF*sim_b_IF*(1-sim_k_IF),ns_ES*sim_r_ES*sim_b_ES*(1-sim_k_ES),ns_EF*sim_r_EF*sim_b_EF*(1-sim_k_EF),ns_ENB*sim_r_ENB*sim_b_ENB*(1-sim_k_ENB),ns_PF*sim_r_PF*sim_b_PF*(1-sim_k_PF),
            0,      0,      0,       0,       0,                                                         ns_IS*sim_r_IS*(1-sim_b_IS),         ns_IF*sim_r_IF*(1-sim_b_IF),         ns_ES*sim_r_ES*(1-sim_b_ES),         ns_EF*sim_r_EF*(1-sim_b_EF),         ns_ENB*sim_r_ENB*(1-sim_b_ENB),        ns_PF*sim_r_PF*(1-sim_b_PF),
            0,      0,      0,       0,       0,                                                         ns_IS*(1-sim_r_IS),                  ns_IF*(1-sim_r_IF),                  ns_ES*(1-sim_r_ES),                  ns_EF*(1-sim_r_EF),                  ns_ENB*(1-sim_r_ENB),                  ns_PF*(1-sim_r_PF)
          ), nrow = 11, byrow = TRUE)

          n_m_eig <- eigen(n_m)
          output_mat[i, j] <- as.numeric(n_m_eig$values[1])
        }
      }

      output_df <- as.data.frame(output_mat)
      output_df$mitigation_efficacy <- mit_eff
      output_df$scenario <- mitigation_scenarios$scenario[k]
      output_df$iuu_proportion <- fixed_iuu_p
      output_df$iuu_reduction <- fixed_iuu_red
      output_df$coverage <- coverage_seq_fixed
      full_output_fixed_iuu[[list_idx]] <- output_df
    }
  }
}
```

**format fixed-IUU uncertainty output**
```{r}
uncert_fixed_iuu_long <- map_dfr(full_output_fixed_iuu, function(df) {
  df %>%
    select_if(~ all(!is.na(.))) %>%
    pivot_longer(cols = starts_with("V"),
                 names_to = "simrun",
                 values_to = "lambda")
})

uncert_fixed_iuu_long <- uncert_fixed_iuu_long %>%
  mutate(
    scenario = factor(scenario, levels = mitigation_scenarios$scenario),
    iuu_label = factor(paste0("IUU = ", iuu_proportion * 100, "%"),
                       levels = paste0("IUU = ", sort(fixed_iuu_vals) * 100, "%")),
    iuu_red_label = factor(paste0(iuu_reduction * 100, "% IUU reduction"),
                           levels = paste0(sort(fixed_iuu_red_vals) * 100, "% IUU reduction"))
  )

uncert_fixed_iuu_summary <- uncert_fixed_iuu_long %>%
  group_by(scenario, iuu_proportion, iuu_label, iuu_reduction, iuu_red_label, coverage) %>%
  summarise(
    mean_lambda = mean(lambda),
    q05 = quantile(lambda, 0.05),
    q25 = quantile(lambda, 0.25),
    q75 = quantile(lambda, 0.75),
    q95 = quantile(lambda, 0.95),
    n_sims = n(),
    .groups = "drop"
  )

# Check valid sims per scenario × IUU level × enforcement
uncert_fixed_iuu_long %>%
  group_by(scenario, iuu_label, iuu_red_label) %>%
  summarise(n_valid_sims = n_distinct(simrun), .groups = "drop") %>%
  pivot_wider(names_from = iuu_red_label, values_from = n_valid_sims) %>%
  print(n = 30)
```

**plot fixed-IUU uncertainty — ribbon (scenario rows × IUU columns), colored by enforcement**
```{r, fig.width=14, fig.height=10}
mit_plot_scenarios_fixed <- c("Tori lines only", "2/3 (tori + night)", "3/3 (tori + night + weight)")

uncert_fixed_iuu_summary %>%
  filter(scenario %in% mit_plot_scenarios_fixed) %>%
  ggplot() +
  geom_ribbon(aes(x = coverage, ymin = q05, ymax = q95,
                  group = iuu_red_label, fill = iuu_red_label),
              alpha = 0.2) +
  geom_line(aes(x = coverage, y = mean_lambda,
                group = iuu_red_label, color = iuu_red_label),
            linewidth = 0.8) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  facet_grid(scenario ~ iuu_label) +
  labs(x = "% legal fisheries with bycatch mitigation", y = "lambda",
       color = "IUU enforcement", fill = "IUU enforcement",
       subtitle = "Ribbons = 90% CI from VR + FM uncertainty") +
  themeo +
  coord_cartesian(expand = FALSE) +
  scale_color_manual(values = c("#d73027", "#fee090", "#4575b4")) +
  scale_fill_manual(values = c("#d73027", "#fee090", "#4575b4"))
```

**plot fixed-IUU uncertainty — all 6 mitigation scenarios at each IUU × enforcement combo**
```{r, fig.width=14, fig.height=10}
uncert_fixed_iuu_summary %>%
  ggplot() +
  geom_ribbon(aes(x = coverage, ymin = q05, ymax = q95,
                  group = scenario, fill = scenario),
              alpha = 0.15) +
  geom_line(aes(x = coverage, y = mean_lambda,
                group = scenario, color = scenario),
            linewidth = 0.7) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  facet_grid(iuu_red_label ~ iuu_label) +
  labs(x = "% legal fisheries with bycatch mitigation", y = "lambda",
       color = "Mitigation scenario", fill = "Mitigation scenario",
       subtitle = "Shaded = 90% CI from VR + FM uncertainty") +
  themeo +
  guides(colour = guide_legend(nrow = 2), fill = guide_legend(nrow = 2)) +
  coord_cartesian(expand = FALSE) +
  scale_color_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494")) +
  scale_fill_manual(values = c("#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494"))
```

**plot fixed-IUU — zoomed mean lines (scenario rows × IUU columns), colored by enforcement**
```{r, fig.width=14, fig.height=10}
# Zoomed to lambda = 1 region to show where scenarios cross the recovery threshold
uncert_fixed_iuu_summary %>%
  filter(scenario %in% mit_plot_scenarios_fixed) %>%
  ggplot() +
  geom_line(aes(x = coverage, y = mean_lambda,
                group = iuu_red_label, color = iuu_red_label),
            linewidth = 0.8) +
  geom_hline(yintercept = 1, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  facet_grid(scenario ~ iuu_label) +
  labs(x = "% legal fisheries with bycatch mitigation", y = "lambda",
       color = "IUU enforcement",
       subtitle = "Zoomed to recovery threshold — mean lambda only") +
  themeo +
  coord_cartesian(ylim = c(0.995, 1.005), expand = FALSE) +
  scale_color_manual(values = c("#d73027", "#fee090", "#4575b4"))
```

**probability of recovery (lambda >= 1) — fixed IUU × enforcement**
```{r, fig.width=14, fig.height=10}
# What fraction of uncertainty sims achieve recovery at each coverage level?
prob_recovery_fixed <- uncert_fixed_iuu_long %>%
  filter(scenario %in% mit_plot_scenarios_fixed) %>%
  group_by(scenario, iuu_label, iuu_red_label, coverage) %>%
  summarise(
    prob_recover = mean(lambda >= 1),
    .groups = "drop"
  )

ggplot(prob_recovery_fixed) +
  geom_line(aes(x = coverage, y = prob_recover,
                group = iuu_red_label, color = iuu_red_label),
            linewidth = 0.8) +
  geom_hline(yintercept = 0.5, color = "darkgrey", alpha = 0.5, linetype = "dashed") +
  facet_grid(scenario ~ iuu_label) +
  labs(x = "% legal fisheries with bycatch mitigation",
       y = "P(lambda >= 1)",
       color = "IUU enforcement",
       subtitle = "Probability of population recovery under VR + FM uncertainty") +
  themeo +
  coord_cartesian(expand = FALSE) +
  scale_color_manual(values = c("#d73027", "#fee090", "#4575b4"))
```

